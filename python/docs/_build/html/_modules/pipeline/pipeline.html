<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pipeline.pipeline &mdash; appengine-pipelines 1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="appengine-pipelines 1 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">appengine-pipelines 1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for pipeline.pipeline</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>
<span class="c">#</span>
<span class="c"># Copyright 2010 Google Inc.</span>
<span class="c">#</span>
<span class="c"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c"># you may not use this file except in compliance with the License.</span>
<span class="c"># You may obtain a copy of the License at</span>
<span class="c">#</span>
<span class="c">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c">#</span>
<span class="c"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c"># See the License for the specific language governing permissions and</span>
<span class="c"># limitations under the License.</span>

<span class="sd">&quot;&quot;&quot;Google App Engine Pipeline API for complex, asynchronous workflows.&quot;&quot;&quot;</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c"># Public API.</span>
    <span class="s">&#39;Error&#39;</span><span class="p">,</span> <span class="s">&#39;PipelineSetupError&#39;</span><span class="p">,</span> <span class="s">&#39;PipelineExistsError&#39;</span><span class="p">,</span>
    <span class="s">&#39;PipelineRuntimeError&#39;</span><span class="p">,</span> <span class="s">&#39;SlotNotFilledError&#39;</span><span class="p">,</span> <span class="s">&#39;SlotNotDeclaredError&#39;</span><span class="p">,</span>
    <span class="s">&#39;UnexpectedPipelineError&#39;</span><span class="p">,</span> <span class="s">&#39;PipelineStatusError&#39;</span><span class="p">,</span> <span class="s">&#39;Slot&#39;</span><span class="p">,</span> <span class="s">&#39;Pipeline&#39;</span><span class="p">,</span>
    <span class="s">&#39;PipelineFuture&#39;</span><span class="p">,</span> <span class="s">&#39;After&#39;</span><span class="p">,</span> <span class="s">&#39;InOrder&#39;</span><span class="p">,</span> <span class="s">&#39;Retry&#39;</span><span class="p">,</span> <span class="s">&#39;Abort&#39;</span><span class="p">,</span> <span class="s">&#39;get_status_tree&#39;</span><span class="p">,</span>
    <span class="s">&#39;get_pipeline_names&#39;</span><span class="p">,</span> <span class="s">&#39;get_root_list&#39;</span><span class="p">,</span> <span class="s">&#39;create_handlers_map&#39;</span><span class="p">,</span>
    <span class="s">&#39;set_enforce_auth&#39;</span><span class="p">,</span>
<span class="p">]</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">uuid</span>

<span class="kn">from</span> <span class="nn">google.appengine.api</span> <span class="kn">import</span> <span class="n">mail</span>
<span class="kn">from</span> <span class="nn">google.appengine.api</span> <span class="kn">import</span> <span class="n">files</span>
<span class="kn">from</span> <span class="nn">google.appengine.api</span> <span class="kn">import</span> <span class="n">users</span>
<span class="kn">from</span> <span class="nn">google.appengine.api</span> <span class="kn">import</span> <span class="n">taskqueue</span>
<span class="kn">from</span> <span class="nn">google.appengine.ext</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">google.appengine.ext</span> <span class="kn">import</span> <span class="n">webapp</span>

<span class="k">try</span><span class="p">:</span>
  <span class="kn">import</span> <span class="nn">json</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
  <span class="kn">import</span> <span class="nn">simplejson</span> <span class="kn">as</span> <span class="nn">json</span>

<span class="c"># Relative imports</span>
<span class="kn">import</span> <span class="nn">models</span>
<span class="kn">import</span> <span class="nn">status_ui</span>
<span class="kn">import</span> <span class="nn">util</span> <span class="kn">as</span> <span class="nn">mr_util</span>

<span class="c"># pylint: disable=g-bad-name</span>
<span class="c"># pylint: disable=protected-access</span>

<span class="c"># For convenience</span>
<span class="n">_BarrierIndex</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BarrierIndex</span>
<span class="n">_BarrierRecord</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BarrierRecord</span>
<span class="n">_PipelineRecord</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PipelineRecord</span>
<span class="n">_SlotRecord</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">SlotRecord</span>
<span class="n">_StatusRecord</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">StatusRecord</span>


<span class="c"># Overall TODOs:</span>
<span class="c"># - Add a human readable name for start()</span>

<span class="c"># Potential TODOs:</span>
<span class="c"># - Add support for ANY N barriers.</span>
<span class="c"># - Allow Pipelines to declare they are &quot;short&quot; and optimize the evaluate()</span>
<span class="c">#   function to run as many of them in quick succession.</span>
<span class="c"># - Add support in all Pipelines for hold/release where up-stream</span>
<span class="c">#   barriers will fire but do nothing because the Pipeline is not ready.</span>

<span class="c">################################################################################</span>


<div class="viewcode-block" id="Error"><a class="viewcode-back" href="../../pipeline.html#pipeline.pipeline.Error">[docs]</a><span class="k">class</span> <span class="nc">Error</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Base class for exceptions in this module.&quot;&quot;&quot;</span>

</div>
<div class="viewcode-block" id="PipelineSetupError"><a class="viewcode-back" href="../../pipeline.html#pipeline.pipeline.PipelineSetupError">[docs]</a><span class="k">class</span> <span class="nc">PipelineSetupError</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Base class for exceptions that happen before Pipeline execution.&quot;&quot;&quot;</span>

</div>
<div class="viewcode-block" id="PipelineExistsError"><a class="viewcode-back" href="../../pipeline.html#pipeline.pipeline.PipelineExistsError">[docs]</a><span class="k">class</span> <span class="nc">PipelineExistsError</span><span class="p">(</span><span class="n">PipelineSetupError</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A new Pipeline with an assigned idempotence_key cannot be overwritten.&quot;&quot;&quot;</span>

</div>
<div class="viewcode-block" id="PipelineRuntimeError"><a class="viewcode-back" href="../../pipeline.html#pipeline.pipeline.PipelineRuntimeError">[docs]</a><span class="k">class</span> <span class="nc">PipelineRuntimeError</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Base class for exceptions that happen during Pipeline execution.&quot;&quot;&quot;</span>

</div>
<div class="viewcode-block" id="SlotNotFilledError"><a class="viewcode-back" href="../../pipeline.html#pipeline.pipeline.SlotNotFilledError">[docs]</a><span class="k">class</span> <span class="nc">SlotNotFilledError</span><span class="p">(</span><span class="n">PipelineRuntimeError</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A slot that should have been filled already was not yet filled.&quot;&quot;&quot;</span>

</div>
<div class="viewcode-block" id="SlotNotDeclaredError"><a class="viewcode-back" href="../../pipeline.html#pipeline.pipeline.SlotNotDeclaredError">[docs]</a><span class="k">class</span> <span class="nc">SlotNotDeclaredError</span><span class="p">(</span><span class="n">PipelineRuntimeError</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A slot that was filled or passed along was not previously declared.&quot;&quot;&quot;</span>

</div>
<div class="viewcode-block" id="UnexpectedPipelineError"><a class="viewcode-back" href="../../pipeline.html#pipeline.pipeline.UnexpectedPipelineError">[docs]</a><span class="k">class</span> <span class="nc">UnexpectedPipelineError</span><span class="p">(</span><span class="n">PipelineRuntimeError</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;An assertion failed, potentially leaving the pipeline unable to proceed.&quot;&quot;&quot;</span>

</div>
<span class="k">class</span> <span class="nc">PipelineUserError</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Exceptions raised indirectly by developers to cause certain behaviors.&quot;&quot;&quot;</span>


<div class="viewcode-block" id="Retry"><a class="viewcode-back" href="../../pipeline.html#pipeline.pipeline.Retry">[docs]</a><span class="k">class</span> <span class="nc">Retry</span><span class="p">(</span><span class="n">PipelineUserError</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;The currently running pipeline should be retried at a later time.&quot;&quot;&quot;</span>

</div>
<div class="viewcode-block" id="Abort"><a class="viewcode-back" href="../../pipeline.html#pipeline.pipeline.Abort">[docs]</a><span class="k">class</span> <span class="nc">Abort</span><span class="p">(</span><span class="n">PipelineUserError</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;The currently running pipeline should be aborted up to the root.&quot;&quot;&quot;</span>

</div>
<div class="viewcode-block" id="PipelineStatusError"><a class="viewcode-back" href="../../pipeline.html#pipeline.pipeline.PipelineStatusError">[docs]</a><span class="k">class</span> <span class="nc">PipelineStatusError</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Exceptions raised when trying to collect pipeline status.&quot;&quot;&quot;</span>

</div>
<span class="k">class</span> <span class="nc">_CallbackTaskError</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A callback task was unable to execute properly for some reason.&quot;&quot;&quot;</span>


<span class="c">################################################################################</span>

<span class="n">_MAX_BARRIERS_TO_NOTIFY</span> <span class="o">=</span> <span class="mi">10</span>

<span class="n">_MAX_ABORTS_TO_BEGIN</span> <span class="o">=</span> <span class="mi">10</span>

<span class="n">_TEST_MODE</span> <span class="o">=</span> <span class="bp">False</span>

<span class="n">_TEST_ROOT_PIPELINE_KEY</span> <span class="o">=</span> <span class="bp">None</span>

<span class="n">_DEFAULT_BACKOFF_SECONDS</span> <span class="o">=</span> <span class="mi">15</span>

<span class="n">_DEFAULT_BACKOFF_FACTOR</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">_DEFAULT_MAX_ATTEMPTS</span> <span class="o">=</span> <span class="mi">3</span>

<span class="n">_RETRY_WIGGLE_TIMEDELTA</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="n">_DEBUG</span> <span class="o">=</span> <span class="bp">False</span>

<span class="n">_MAX_JSON_SIZE</span> <span class="o">=</span> <span class="mi">900000</span>

<span class="n">_ENFORCE_AUTH</span> <span class="o">=</span> <span class="bp">True</span>

<span class="n">_MAX_CALLBACK_TASK_RETRIES</span> <span class="o">=</span> <span class="mi">5</span>

<span class="c">################################################################################</span>


<div class="viewcode-block" id="Slot"><a class="viewcode-back" href="../../pipeline.html#pipeline.pipeline.Slot">[docs]</a><span class="k">class</span> <span class="nc">Slot</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;An output that is filled by a Pipeline as it executes.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">slot_key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initializer.</span>

<span class="sd">    Args:</span>
<span class="sd">      name: The name of this slot.</span>
<span class="sd">      slot_key: The db.Key for this slot&#39;s _SlotRecord if it&#39;s already been</span>
<span class="sd">        allocated by an up-stream pipeline.</span>
<span class="sd">      strict: If this Slot was created as an output of a strictly defined</span>
<span class="sd">        pipeline.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">UnexpectedPipelineError</span><span class="p">(</span><span class="s">&#39;Slot with key &quot;</span><span class="si">%s</span><span class="s">&quot; missing a name.&#39;</span> <span class="o">%</span>
                                    <span class="n">slot_key</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">slot_key</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">slot_key</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Key</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="n">_SlotRecord</span><span class="o">.</span><span class="n">kind</span><span class="p">(),</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_exists</span> <span class="o">=</span> <span class="n">_TEST_MODE</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_exists</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_touched</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_strict</span> <span class="o">=</span> <span class="n">strict</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">slot_key</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">filled</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_filler_pipeline_key</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_fill_datetime</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="bp">None</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the current value of this slot.</span>

<span class="sd">    Returns:</span>
<span class="sd">      The value of the slot (a serializable Python type).</span>

<span class="sd">    Raises:</span>
<span class="sd">      SlotNotFilledError if the value hasn&#39;t been filled yet.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">filled</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">SlotNotFilledError</span><span class="p">(</span><span class="s">&#39;Slot with name &quot;</span><span class="si">%s</span><span class="s">&quot;, key &quot;</span><span class="si">%s</span><span class="s">&quot; not yet filled.&#39;</span>
                               <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">filler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the pipeline ID that filled this slot&#39;s value.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A string that is the pipeline ID.</span>

<span class="sd">    Raises:</span>
<span class="sd">      SlotNotFilledError if the value hasn&#39;t been filled yet.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">filled</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">SlotNotFilledError</span><span class="p">(</span><span class="s">&#39;Slot with name &quot;</span><span class="si">%s</span><span class="s">&quot;, key &quot;</span><span class="si">%s</span><span class="s">&quot; not yet filled.&#39;</span>
                               <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filler_pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">fill_datetime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns when the slot was filled.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A datetime.datetime.</span>

<span class="sd">    Raises:</span>
<span class="sd">      SlotNotFilledError if the value hasn&#39;t been filled yet.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">filled</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">SlotNotFilledError</span><span class="p">(</span><span class="s">&#39;Slot with name &quot;</span><span class="si">%s</span><span class="s">&quot;, key &quot;</span><span class="si">%s</span><span class="s">&quot; not yet filled.&#39;</span>
                               <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fill_datetime</span>

  <span class="k">def</span> <span class="nf">_set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slot_record</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sets the value of this slot based on its corresponding _SlotRecord.</span>

<span class="sd">    Does nothing if the slot has not yet been filled.</span>

<span class="sd">    Args:</span>
<span class="sd">      slot_record: The _SlotRecord containing this Slot&#39;s value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">slot_record</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">_SlotRecord</span><span class="o">.</span><span class="n">FILLED</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">filled</span> <span class="o">=</span> <span class="bp">True</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_filler_pipeline_key</span> <span class="o">=</span> <span class="n">_SlotRecord</span><span class="o">.</span><span class="n">filler</span><span class="o">.</span><span class="n">get_value_for_datastore</span><span class="p">(</span>
          <span class="n">slot_record</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_fill_datetime</span> <span class="o">=</span> <span class="n">slot_record</span><span class="o">.</span><span class="n">fill_time</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">slot_record</span><span class="o">.</span><span class="n">value</span>

  <span class="k">def</span> <span class="nf">_set_value_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filler_pipeline_key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sets the value of this slot for use in testing.</span>

<span class="sd">    Args:</span>
<span class="sd">      filler_pipeline_key: The db.Key of the _PipelineRecord that filled</span>
<span class="sd">        this slot.</span>
<span class="sd">      value: The serializable value set for this slot.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">filled</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_filler_pipeline_key</span> <span class="o">=</span> <span class="n">filler_pipeline_key</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_fill_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
    <span class="c"># Convert to JSON and back again, to simulate the behavior of production.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
        <span class="n">value</span><span class="p">,</span> <span class="n">cls</span><span class="o">=</span><span class="n">mr_util</span><span class="o">.</span><span class="n">JsonEncoder</span><span class="p">),</span> <span class="n">cls</span><span class="o">=</span><span class="n">mr_util</span><span class="o">.</span><span class="n">JsonDecoder</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a string representation of this slot.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filled</span><span class="p">:</span>
      <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="s">&#39;Slot(name=&quot;</span><span class="si">%s</span><span class="s">&quot;, slot_key=&quot;</span><span class="si">%s</span><span class="s">&quot;)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="PipelineFuture"><a class="viewcode-back" href="../../pipeline.html#pipeline.pipeline.PipelineFuture">[docs]</a><span class="k">class</span> <span class="nc">PipelineFuture</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A future for accessing the outputs of a Pipeline.&quot;&quot;&quot;</span>

  <span class="c"># NOTE: Do not, ever, add a names() method to this class. Callers cannot do</span>
  <span class="c"># introspection on their context of being called. Even though the runtime</span>
  <span class="c"># environment of the Pipeline can allow for that to happen, such behavior</span>
  <span class="c"># would prevent synchronous simulation and verification, whic is an</span>
  <span class="c"># unacceptable tradeoff.</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_names</span><span class="p">,</span> <span class="n">force_strict</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initializer.</span>

<span class="sd">    Args:</span>
<span class="sd">      output_names: The list of require output names that will be strictly</span>
<span class="sd">        enforced by this class.</span>
<span class="sd">      force_strict: If True, force this future to be in strict mode.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_after_all_pipelines</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_output_dict</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s">&#39;default&#39;</span><span class="p">:</span> <span class="n">Slot</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;default&#39;</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_strict</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">force_strict</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strict</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">output_names</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_dict</span><span class="p">:</span>
          <span class="k">raise</span> <span class="n">UnexpectedPipelineError</span><span class="p">(</span><span class="s">&#39;Output name reserved: &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Slot</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_inherit_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">pipeline_name</span><span class="p">,</span>
                       <span class="n">already_defined</span><span class="p">,</span>
                       <span class="n">resolve_outputs</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Inherits outputs from a calling Pipeline.</span>

<span class="sd">    Args:</span>
<span class="sd">      pipeline_name: The Pipeline class name (used for debugging).</span>
<span class="sd">      already_defined: Maps output name to stringified db.Key (of _SlotRecords)</span>
<span class="sd">        of any exiting output slots to be inherited by this future.</span>
<span class="sd">      resolve_outputs: When True, this method will dereference all output slots</span>
<span class="sd">        before returning back to the caller, making those output slots&#39; values</span>
<span class="sd">        available.</span>

<span class="sd">    Raises:</span>
<span class="sd">      UnexpectedPipelineError when resolve_outputs is True and any of the output</span>
<span class="sd">      slots could not be retrived from the Datastore.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">slot_key</span> <span class="ow">in</span> <span class="n">already_defined</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">slot_key</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Key</span><span class="p">):</span>
        <span class="n">slot_key</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Key</span><span class="p">(</span><span class="n">slot_key</span><span class="p">)</span>

      <span class="n">slot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">slot</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strict</span><span class="p">:</span>
          <span class="k">raise</span> <span class="n">UnexpectedPipelineError</span><span class="p">(</span>
              <span class="s">&#39;Inherited output named &quot;</span><span class="si">%s</span><span class="s">&quot; must be filled but &#39;</span>
              <span class="s">&#39;not declared for pipeline class &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">pipeline_name</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_output_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Slot</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">slot_key</span><span class="o">=</span><span class="n">slot_key</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">slot</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">slot_key</span>
        <span class="n">slot</span><span class="o">.</span><span class="n">_exists</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">if</span> <span class="n">resolve_outputs</span><span class="p">:</span>
      <span class="n">slot_key_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">s</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_dict</span><span class="o">.</span><span class="n">itervalues</span><span class="p">())</span>
      <span class="n">all_slots</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">slot_key_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
      <span class="k">for</span> <span class="n">slot</span><span class="p">,</span> <span class="n">slot_record</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">slot_key_dict</span><span class="o">.</span><span class="n">itervalues</span><span class="p">(),</span> <span class="n">all_slots</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">slot_record</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
          <span class="k">raise</span> <span class="n">UnexpectedPipelineError</span><span class="p">(</span>
              <span class="s">&#39;Inherited output named &quot;</span><span class="si">%s</span><span class="s">&quot; for pipeline class &quot;</span><span class="si">%s</span><span class="s">&quot; is &#39;</span>
              <span class="s">&#39;missing its Slot in the datastore: &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span>
              <span class="p">(</span><span class="n">slot</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pipeline_name</span><span class="p">,</span> <span class="n">slot</span><span class="o">.</span><span class="n">key</span><span class="p">))</span>
        <span class="n">slot</span> <span class="o">=</span> <span class="n">slot_key_dict</span><span class="p">[</span><span class="n">slot_record</span><span class="o">.</span><span class="n">key</span><span class="p">()]</span>
        <span class="n">slot</span><span class="o">.</span><span class="n">_set_value</span><span class="p">(</span><span class="n">slot_record</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Provides an output Slot instance with the given name if allowed.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_dict</span><span class="p">:</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strict</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SlotNotDeclaredError</span><span class="p">(</span><span class="s">&#39;Undeclared output with name &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_output_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Slot</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
    <span class="n">slot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">slot</span>

</div>
<span class="k">class</span> <span class="nc">_PipelineMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Meta-class for recording all Pipelines that have been defined.&quot;&quot;&quot;</span>

  <span class="c"># List of all Pipeline classes that have been seen.</span>
  <span class="n">_all_classes</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">cls_dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initializes the class path of a Pipeline and saves it.&quot;&quot;&quot;</span>
    <span class="n">cls</span> <span class="o">=</span> <span class="nb">type</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">cls_dict</span><span class="p">)</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">_all_classes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cls</span>


<span class="k">class</span> <span class="nc">ClassProperty</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Descriptor that lets us have read-only class properties.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>

  <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cls</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>


<div class="viewcode-block" id="Pipeline"><a class="viewcode-back" href="../../pipeline.html#pipeline.pipeline.Pipeline">[docs]</a><span class="k">class</span> <span class="nc">Pipeline</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A Pipeline function-object that performs operations and has a life cycle.</span>

<span class="sd">  Class properties (to be overridden by sub-classes):</span>
<span class="sd">    async: When True, this Pipeline will execute asynchronously and fill the</span>
<span class="sd">      default output slot itself using the complete() method.</span>
<span class="sd">    output_names: List of named outputs (in addition to the default slot) that</span>
<span class="sd">      this Pipeline must output to (no more, no less).</span>
<span class="sd">    public_callbacks: If the callback URLs generated for this class should be</span>
<span class="sd">      accessible by all external requests regardless of login or task queue.</span>
<span class="sd">    admin_callbacks: If the callback URLs generated for this class should be</span>
<span class="sd">      accessible by the task queue ane externally by users logged in as admins.</span>
<span class="sd">    class_path: String identifier for this Pipeline, which is derived from</span>
<span class="sd">      its path in the global system modules dictionary.</span>

<span class="sd">  Modifiable instance properties:</span>
<span class="sd">    backoff_seconds: How many seconds to use as the constant factor in</span>
<span class="sd">      exponential backoff; may be changed by the user.</span>
<span class="sd">    backoff_factor: Base factor to use for exponential backoff. The formula</span>
<span class="sd">      followed is (backoff_seconds * backoff_factor^current_attempt).</span>
<span class="sd">    max_attempts: Maximum number of retry attempts to make before failing</span>
<span class="sd">      completely and aborting the entire pipeline up to the root.</span>
<span class="sd">    target: The application version to use for processing this Pipeline. This</span>
<span class="sd">      can be set to the name of a backend to direct Pipelines to run there.</span>

<span class="sd">  Instance properties:</span>
<span class="sd">    pipeline_id: The ID of this pipeline.</span>
<span class="sd">    root_pipeline_id: The ID of the root of this pipeline.</span>
<span class="sd">    queue_name: The queue this pipeline runs on or None if unknown.</span>
<span class="sd">    current_attempt: The current attempt being tried for this pipeline.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">_PipelineMeta</span>

  <span class="c"># To be set by sub-classes</span>
  <span class="n">async</span> <span class="o">=</span> <span class="bp">False</span>
  <span class="n">output_names</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">public_callbacks</span> <span class="o">=</span> <span class="bp">False</span>
  <span class="n">admin_callbacks</span> <span class="o">=</span> <span class="bp">False</span>

  <span class="c"># Internal only.</span>
  <span class="n">_class_path</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># Set for each class</span>
  <span class="n">_send_mail</span> <span class="o">=</span> <span class="n">mail</span><span class="o">.</span><span class="n">send_mail_to_admins</span>  <span class="c"># For testing</span>

  <span class="c"># callback_xg_transaction: Determines whether callbacks are processed within</span>
  <span class="c"># a single entity-group transaction (False), a cross-entity-group</span>
  <span class="c"># transaction (True), or no transaction (None, default). It is generally</span>
  <span class="c"># unsafe for a callback to modify pipeline state outside of a transaction, in</span>
  <span class="c"># particular any pre-initialized state from the pipeline record, such as the</span>
  <span class="c"># outputs. If a transaction is used, the callback method must operate within</span>
  <span class="c"># the datastore&#39;s transaction time limits.</span>
  <span class="c"># TODO(user): Make non-internal once other API calls are considered for</span>
  <span class="c"># transaction support.</span>
  <span class="n">_callback_xg_transaction</span> <span class="o">=</span> <span class="bp">None</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initializer.</span>

<span class="sd">    Args:</span>
<span class="sd">      *args: The positional arguments for this function-object.</span>
<span class="sd">      **kwargs: The keyword arguments for this function-object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">backoff_seconds</span> <span class="o">=</span> <span class="n">_DEFAULT_BACKOFF_SECONDS</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">backoff_factor</span> <span class="o">=</span> <span class="n">_DEFAULT_BACKOFF_FACTOR</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">max_attempts</span> <span class="o">=</span> <span class="n">_DEFAULT_MAX_ATTEMPTS</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">task_retry</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_current_attempt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_root_pipeline_key</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_pipeline_key</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_context</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_result_status</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_set_class_path</span><span class="p">()</span>
    <span class="c"># Introspectively set the target so pipelines stick to the version it</span>
    <span class="c"># started.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">mr_util</span><span class="o">.</span><span class="n">_get_task_target</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">_TEST_MODE</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_context</span> <span class="o">=</span> <span class="n">_PipelineContext</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_root_pipeline_key</span> <span class="o">=</span> <span class="n">_TEST_ROOT_PIPELINE_KEY</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_pipeline_key</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Key</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span>
          <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">kind</span><span class="p">(),</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="n">PipelineFuture</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_names</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">evaluate_test</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">pipeline_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the ID of this Pipeline as a string or None if unknown.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pipeline_key</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">root_pipeline_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns root pipeline ID as a websafe string or None if unknown.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root_pipeline_key</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root_pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">is_root</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns True if this pipeline is a root pipeline, False otherwise.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root_pipeline_key</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pipeline_key</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">queue_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the queue name this Pipeline runs on or None if unknown.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">queue_name</span>
    <span class="k">return</span> <span class="bp">None</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">base_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the base path for Pipeline URL handlers or None if unknown.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">base_path</span>
    <span class="k">return</span> <span class="bp">None</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">has_finalized</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns True if this pipeline has completed and finalized.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_status</span> <span class="o">==</span> <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">DONE</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">was_aborted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns True if this pipeline was aborted.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_status</span> <span class="o">==</span> <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">ABORTED</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">current_attempt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the current attempt at running this pipeline, starting at 1.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_attempt</span> <span class="o">+</span> <span class="mi">1</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">test_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns True if the pipeline is running in test mode.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_TEST_MODE</span>

  <span class="nd">@ClassProperty</span>
  <span class="k">def</span> <span class="nf">class_path</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the unique string identifier for this Pipeline class.</span>

<span class="sd">    Refers to how to find the Pipeline in the global modules dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cls</span><span class="o">.</span><span class="n">_set_class_path</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">_class_path</span>

  <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Pipeline.from_id"><a class="viewcode-back" href="../../pipeline.html#pipeline.pipeline.Pipeline.from_id">[docs]</a>  <span class="k">def</span> <span class="nf">from_id</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">pipeline_id</span><span class="p">,</span> <span class="n">resolve_outputs</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">_pipeline_record</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns an instance corresponding to an existing Pipeline.</span>

<span class="sd">    The returned object will have the same properties a Pipeline does while</span>
<span class="sd">    it&#39;s running synchronously (e.g., like what it&#39;s first allocated), allowing</span>
<span class="sd">    callers to inspect caller arguments, outputs, fill slots, complete the</span>
<span class="sd">    pipeline, abort, retry, etc.</span>

<span class="sd">    Args:</span>
<span class="sd">      pipeline_id: The ID of this pipeline (a string).</span>
<span class="sd">      resolve_outputs: When True, dereference the outputs of this Pipeline</span>
<span class="sd">        so their values can be accessed by the caller.</span>
<span class="sd">      _pipeline_record: Internal-only. The _PipelineRecord instance to use</span>
<span class="sd">        to instantiate this instance instead of fetching it from</span>
<span class="sd">        the datastore.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Pipeline sub-class instances or None if it could not be found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pipeline_record</span> <span class="o">=</span> <span class="n">_pipeline_record</span>

    <span class="c"># Support pipeline IDs and idempotence_keys that are not unicode.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pipeline_id</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">pipeline_id</span> <span class="o">=</span> <span class="n">pipeline_id</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
        <span class="n">pipeline_id</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">pipeline_id</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="n">pipeline_key</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Key</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">kind</span><span class="p">(),</span> <span class="n">pipeline_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pipeline_record</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">pipeline_record</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pipeline_key</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pipeline_record</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">None</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="n">pipeline_func_class</span> <span class="o">=</span> <span class="n">mr_util</span><span class="o">.</span><span class="n">for_name</span><span class="p">(</span><span class="n">pipeline_record</span><span class="o">.</span><span class="n">class_path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Tried to find Pipeline </span><span class="si">%s</span><span class="s">#</span><span class="si">%s</span><span class="s">, but class could &#39;</span>
                      <span class="s">&#39;not be found. Using default Pipeline class instead.&#39;</span><span class="p">,</span>
                      <span class="n">pipeline_record</span><span class="o">.</span><span class="n">class_path</span><span class="p">,</span> <span class="n">pipeline_id</span><span class="p">)</span>
      <span class="n">pipeline_func_class</span> <span class="o">=</span> <span class="n">cls</span>

    <span class="n">params</span> <span class="o">=</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">params</span>
    <span class="n">arg_list</span><span class="p">,</span> <span class="n">kwarg_dict</span> <span class="o">=</span> <span class="n">_dereference_args</span><span class="p">(</span>
        <span class="n">pipeline_record</span><span class="o">.</span><span class="n">class_path</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;args&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;kwargs&#39;</span><span class="p">])</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">PipelineFuture</span><span class="p">(</span><span class="n">pipeline_func_class</span><span class="o">.</span><span class="n">output_names</span><span class="p">)</span>
    <span class="n">outputs</span><span class="o">.</span><span class="n">_inherit_outputs</span><span class="p">(</span>
        <span class="n">pipeline_record</span><span class="o">.</span><span class="n">class_path</span><span class="p">,</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;output_slots&#39;</span><span class="p">],</span>
        <span class="n">resolve_outputs</span><span class="o">=</span><span class="n">resolve_outputs</span><span class="p">)</span>

    <span class="n">stage</span> <span class="o">=</span> <span class="n">pipeline_func_class</span><span class="p">(</span><span class="o">*</span><span class="n">arg_list</span><span class="p">,</span> <span class="o">**</span><span class="n">kwarg_dict</span><span class="p">)</span>
    <span class="n">stage</span><span class="o">.</span><span class="n">backoff_seconds</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;backoff_seconds&#39;</span><span class="p">]</span>
    <span class="n">stage</span><span class="o">.</span><span class="n">backoff_factor</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;backoff_factor&#39;</span><span class="p">]</span>
    <span class="n">stage</span><span class="o">.</span><span class="n">max_attempts</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;max_attempts&#39;</span><span class="p">]</span>
    <span class="n">stage</span><span class="o">.</span><span class="n">task_retry</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;task_retry&#39;</span><span class="p">]</span>
    <span class="n">stage</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;target&#39;</span><span class="p">)</span>  <span class="c"># May not be defined for old Pipelines</span>
    <span class="n">stage</span><span class="o">.</span><span class="n">_current_attempt</span> <span class="o">=</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">current_attempt</span>
    <span class="n">stage</span><span class="o">.</span><span class="n">_set_values_internal</span><span class="p">(</span>
        <span class="n">_PipelineContext</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;queue_name&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;base_path&#39;</span><span class="p">]),</span>
        <span class="n">pipeline_key</span><span class="p">,</span>
        <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">root_pipeline</span><span class="o">.</span><span class="n">get_value_for_datastore</span><span class="p">(</span><span class="n">pipeline_record</span><span class="p">),</span>
        <span class="n">outputs</span><span class="p">,</span>
        <span class="n">pipeline_record</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">stage</span>

  <span class="c"># Methods that can be invoked on a Pipeline instance by anyone with a</span>
  <span class="c"># valid object (e.g., directly instantiated, retrieve via from_id).</span></div>
<div class="viewcode-block" id="Pipeline.start"><a class="viewcode-back" href="../../pipeline.html#pipeline.pipeline.Pipeline.start">[docs]</a>  <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">idempotence_key</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
            <span class="n">queue_name</span><span class="o">=</span><span class="s">&#39;default&#39;</span><span class="p">,</span>
            <span class="n">base_path</span><span class="o">=</span><span class="s">&#39;/_ah/pipeline&#39;</span><span class="p">,</span>
            <span class="n">return_task</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">countdown</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">eta</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Starts a new instance of this pipeline.</span>

<span class="sd">    Args:</span>
<span class="sd">      idempotence_key: The ID to use for this Pipeline and throughout its</span>
<span class="sd">        asynchronous workflow to ensure the operations are idempotent. If</span>
<span class="sd">        empty a starting key will be automatically assigned.</span>
<span class="sd">      queue_name: What queue this Pipeline&#39;s workflow should execute on.</span>
<span class="sd">      base_path: The relative URL path to where the Pipeline API is</span>
<span class="sd">        mounted for access by the taskqueue API or external requests.</span>
<span class="sd">      return_task: When True, a task to start this pipeline will be returned</span>
<span class="sd">        instead of submitted, allowing the caller to start off this pipeline</span>
<span class="sd">        as part of a separate transaction (potentially leaving this newly</span>
<span class="sd">        allocated pipeline&#39;s datastore entities in place if that separate</span>
<span class="sd">        transaction fails for any reason).</span>
<span class="sd">      countdown: Time in seconds into the future that this Task should execute.</span>
<span class="sd">        Defaults to zero.</span>
<span class="sd">      eta: A datetime.datetime specifying the absolute time at which the task</span>
<span class="sd">        should be executed. Must not be specified if &#39;countdown&#39; is specified.</span>
<span class="sd">        This may be timezone-aware or timezone-naive. If None, defaults to now.</span>
<span class="sd">        For pull tasks, no worker will be able to lease this task before the</span>
<span class="sd">        time indicated by eta.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A taskqueue.Task instance if return_task was True. This task will *not*</span>
<span class="sd">      have a name, thus to ensure reliable execution of your pipeline you</span>
<span class="sd">      should add() this task as part of a separate Datastore transaction.</span>

<span class="sd">    Raises:</span>
<span class="sd">      PipelineExistsError if the pipeline with the given idempotence key exists.</span>
<span class="sd">      PipelineSetupError if the pipeline could not start for any other reason.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">idempotence_key</span><span class="p">:</span>
      <span class="n">idempotence_key</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">idempotence_key</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">idempotence_key</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
        <span class="n">idempotence_key</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">idempotence_key</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="n">pipeline_key</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Key</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">kind</span><span class="p">(),</span> <span class="n">idempotence_key</span><span class="p">)</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">_PipelineContext</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">queue_name</span><span class="p">,</span> <span class="n">base_path</span><span class="p">)</span>
    <span class="n">future</span> <span class="o">=</span> <span class="n">PipelineFuture</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_names</span><span class="p">,</span> <span class="n">force_strict</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_set_values_internal</span><span class="p">(</span>
          <span class="n">context</span><span class="p">,</span> <span class="n">pipeline_key</span><span class="p">,</span> <span class="n">pipeline_key</span><span class="p">,</span> <span class="n">future</span><span class="p">,</span> <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">WAITING</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="n">start</span><span class="p">(</span>
          <span class="bp">self</span><span class="p">,</span> <span class="n">return_task</span><span class="o">=</span><span class="n">return_task</span><span class="p">,</span> <span class="n">countdown</span><span class="o">=</span><span class="n">countdown</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="n">eta</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Error</span><span class="p">:</span>
      <span class="c"># Pass through exceptions that originate in this module.</span>
      <span class="k">raise</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
      <span class="c"># Re-type any exceptions that were raised in dependent methods.</span>
      <span class="k">raise</span> <span class="n">PipelineSetupError</span><span class="p">(</span><span class="s">&#39;Error starting </span><span class="si">%s</span><span class="s">#</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
          <span class="bp">self</span><span class="p">,</span> <span class="n">idempotence_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</div>
<div class="viewcode-block" id="Pipeline.start_test"><a class="viewcode-back" href="../../pipeline.html#pipeline.pipeline.Pipeline.start_test">[docs]</a>  <span class="k">def</span> <span class="nf">start_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idempotence_key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">base_path</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Starts this pipeline in test fashion.</span>

<span class="sd">    Args:</span>
<span class="sd">      idempotence_key: Dummy idempotence_key to use for this root pipeline.</span>
<span class="sd">      base_path: Dummy base URL path to use for this root pipeline.</span>
<span class="sd">      kwargs: Ignored keyword arguments usually passed to start().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">idempotence_key</span><span class="p">:</span>
      <span class="n">idempotence_key</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
    <span class="n">pipeline_key</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Key</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">kind</span><span class="p">(),</span> <span class="n">idempotence_key</span><span class="p">)</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">_PipelineContext</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">,</span> <span class="n">base_path</span><span class="p">)</span>
    <span class="n">future</span> <span class="o">=</span> <span class="n">PipelineFuture</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_names</span><span class="p">,</span> <span class="n">force_strict</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_set_values_internal</span><span class="p">(</span>
        <span class="n">context</span><span class="p">,</span> <span class="n">pipeline_key</span><span class="p">,</span> <span class="n">pipeline_key</span><span class="p">,</span> <span class="n">future</span><span class="p">,</span> <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">WAITING</span><span class="p">)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">start_test</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

  <span class="c"># Pipeline control methods.</span></div>
<div class="viewcode-block" id="Pipeline.retry"><a class="viewcode-back" href="../../pipeline.html#pipeline.pipeline.Pipeline.retry">[docs]</a>  <span class="k">def</span> <span class="nf">retry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retry_message</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Forces a currently running asynchronous pipeline to retry.</span>

<span class="sd">    Note this may not be called by synchronous or generator pipelines. Those</span>
<span class="sd">    must instead raise the &#39;Retry&#39; exception during execution.</span>

<span class="sd">    Args:</span>
<span class="sd">      retry_message: Optional message explaining why the retry happened.</span>

<span class="sd">    Returns:</span>
<span class="sd">      True if the Pipeline should be retried, False if it cannot be cancelled</span>
<span class="sd">      mid-flight for some reason.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">async</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">UnexpectedPipelineError</span><span class="p">(</span>
          <span class="s">&#39;May only call retry() method for asynchronous pipelines.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">try_cancel</span><span class="p">():</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">transition_retry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pipeline_key</span><span class="p">,</span> <span class="n">retry_message</span><span class="p">)</span>
      <span class="k">return</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="Pipeline.abort"><a class="viewcode-back" href="../../pipeline.html#pipeline.pipeline.Pipeline.abort">[docs]</a>  <span class="k">def</span> <span class="nf">abort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">abort_message</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mark the entire pipeline up to the root as aborted.</span>

<span class="sd">    Note this should only be called from *outside* the context of a running</span>
<span class="sd">    pipeline. Synchronous and generator pipelines should raise the &#39;Abort&#39;</span>
<span class="sd">    exception to cause this behavior during execution.</span>

<span class="sd">    Args:</span>
<span class="sd">      abort_message: Optional message explaining why the abort happened.</span>

<span class="sd">    Returns:</span>
<span class="sd">      True if the abort signal was sent successfully; False if the pipeline</span>
<span class="sd">      could not be aborted for any reason.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># TODO: Use thread-local variable to enforce that this is not called</span>
    <span class="c"># while a pipeline is executing in the current thread.</span>
    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">async</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root_pipeline_key</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pipeline_key</span> <span class="ow">and</span>
        <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">try_cancel</span><span class="p">()):</span>
      <span class="c"># Handle the special case where the root pipeline is async and thus</span>
      <span class="c"># cannot be aborted outright.</span>
      <span class="k">return</span> <span class="bp">False</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">begin_abort</span><span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_root_pipeline_key</span><span class="p">,</span> <span class="n">abort_message</span><span class="o">=</span><span class="n">abort_message</span><span class="p">)</span>

  <span class="c"># Methods used by the Pipeline as it runs.</span></div>
<div class="viewcode-block" id="Pipeline.fill"><a class="viewcode-back" href="../../pipeline.html#pipeline.pipeline.Pipeline.fill">[docs]</a>  <span class="k">def</span> <span class="nf">fill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_or_slot</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fills an output slot required by this Pipeline.</span>

<span class="sd">    Args:</span>
<span class="sd">      name_or_slot: The name of the slot (a string) or Slot record to fill.</span>
<span class="sd">      value: The serializable value to assign to this slot.</span>

<span class="sd">    Raises:</span>
<span class="sd">      UnexpectedPipelineError if the Slot no longer exists. SlotNotDeclaredError</span>
<span class="sd">      if trying to output to a slot that was not declared ahead of time.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name_or_slot</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
      <span class="n">slot</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">,</span> <span class="n">name_or_slot</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name_or_slot</span><span class="p">,</span> <span class="n">Slot</span><span class="p">):</span>
      <span class="n">slot</span> <span class="o">=</span> <span class="n">name_or_slot</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">UnexpectedPipelineError</span><span class="p">(</span>
          <span class="s">&#39;Could not fill invalid output name: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">name_or_slot</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">slot</span><span class="o">.</span><span class="n">_exists</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">SlotNotDeclaredError</span><span class="p">(</span>
          <span class="s">&#39;Cannot fill output with name &quot;</span><span class="si">%s</span><span class="s">&quot; that was just &#39;</span>
          <span class="s">&#39;declared within the Pipeline context.&#39;</span> <span class="o">%</span> <span class="n">slot</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">fill_slot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pipeline_key</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Pipeline.set_status"><a class="viewcode-back" href="../../pipeline.html#pipeline.pipeline.Pipeline.set_status">[docs]</a>  <span class="k">def</span> <span class="nf">set_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">console_url</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">status_links</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sets the current status of this pipeline.</span>

<span class="sd">    This method is purposefully non-transactional. Updates are written to the</span>
<span class="sd">    datastore immediately and overwrite all existing statuses.</span>

<span class="sd">    Args:</span>
<span class="sd">      message: (optional) Overall status message.</span>
<span class="sd">      console_url: (optional) Relative URL to use for the &quot;console&quot; of this</span>
<span class="sd">        pipeline that displays current progress. When None, no console will</span>
<span class="sd">        be displayed.</span>
<span class="sd">      status_links: (optional) Dictionary of readable link names to relative</span>
<span class="sd">        URLs that should be associated with this pipeline as it runs. These links</span>
<span class="sd">        provide convenient access to other dashboards, consoles, etc associated</span>
<span class="sd">        with the pipeline.</span>

<span class="sd">    Raises:</span>
<span class="sd">      PipelineRuntimeError if the status could not be set for any reason.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">_TEST_MODE</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
          <span class="s">&#39;New status for </span><span class="si">%s</span><span class="s">#</span><span class="si">%s</span><span class="s">: message=</span><span class="si">%r</span><span class="s">, console_url=</span><span class="si">%r</span><span class="s">, status_links=</span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span>
          <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_id</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">console_url</span><span class="p">,</span> <span class="n">status_links</span><span class="p">)</span>
      <span class="k">return</span>

    <span class="n">status_key</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Key</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="n">_StatusRecord</span><span class="o">.</span><span class="n">kind</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_id</span><span class="p">)</span>
    <span class="n">root_pipeline_key</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Key</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span>
        <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">kind</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_pipeline_id</span><span class="p">)</span>
    <span class="n">status_record</span> <span class="o">=</span> <span class="n">_StatusRecord</span><span class="p">(</span>
        <span class="n">key</span><span class="o">=</span><span class="n">status_key</span><span class="p">,</span> <span class="n">root_pipeline</span><span class="o">=</span><span class="n">root_pipeline_key</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">message</span><span class="p">:</span>
        <span class="n">status_record</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span>
      <span class="k">if</span> <span class="n">console_url</span><span class="p">:</span>
        <span class="n">status_record</span><span class="o">.</span><span class="n">console_url</span> <span class="o">=</span> <span class="n">console_url</span>
      <span class="k">if</span> <span class="n">status_links</span><span class="p">:</span>
        <span class="c"># Alphabeticalize the list.</span>
        <span class="n">status_record</span><span class="o">.</span><span class="n">link_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="n">db</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">status_links</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">())</span>
        <span class="n">status_record</span><span class="o">.</span><span class="n">link_urls</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">db</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">status_links</span><span class="p">[</span><span class="n">name</span><span class="p">])</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">status_record</span><span class="o">.</span><span class="n">link_names</span><span class="p">]</span>

      <span class="n">status_record</span><span class="o">.</span><span class="n">status_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>

      <span class="n">status_record</span><span class="o">.</span><span class="n">put</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">PipelineRuntimeError</span><span class="p">(</span><span class="s">&#39;Could not set status for </span><span class="si">%s</span><span class="s">#</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
          <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</div>
<div class="viewcode-block" id="Pipeline.complete"><a class="viewcode-back" href="../../pipeline.html#pipeline.pipeline.Pipeline.complete">[docs]</a>  <span class="k">def</span> <span class="nf">complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default_output</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Marks this asynchronous Pipeline as complete.</span>

<span class="sd">    Args:</span>
<span class="sd">      default_output: What value the &#39;default&#39; output slot should be assigned.</span>

<span class="sd">    Raises:</span>
<span class="sd">      UnexpectedPipelineError if the slot no longer exists or this method was</span>
<span class="sd">      called for a pipeline that is not async.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># TODO: Enforce that all outputs expected by this async pipeline were</span>
    <span class="c"># filled before this complete() function was called. May required all</span>
    <span class="c"># async functions to declare their outputs upfront.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">async</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">UnexpectedPipelineError</span><span class="p">(</span>
          <span class="s">&#39;May only call complete() method for asynchronous pipelines.&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">fill_slot</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pipeline_key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">default</span><span class="p">,</span> <span class="n">default_output</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Pipeline.get_callback_url"><a class="viewcode-back" href="../../pipeline.html#pipeline.pipeline.Pipeline.get_callback_url">[docs]</a>  <span class="k">def</span> <span class="nf">get_callback_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a relative URL for invoking this Pipeline&#39;s callback method.</span>

<span class="sd">    Args:</span>
<span class="sd">      kwargs: Dictionary mapping keyword argument names to single values that</span>
<span class="sd">        should be passed to the callback when it is invoked.</span>

<span class="sd">    Raises:</span>
<span class="sd">      UnexpectedPipelineError if this is invoked on pipeline that is not async.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># TODO: Support positional parameters.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">async</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">UnexpectedPipelineError</span><span class="p">(</span>
          <span class="s">&#39;May only call get_callback_url() method for asynchronous pipelines.&#39;</span><span class="p">)</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;pipeline_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
    <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/callback?</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_path</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Pipeline.get_callback_task"><a class="viewcode-back" href="../../pipeline.html#pipeline.pipeline.Pipeline.get_callback_task">[docs]</a>  <span class="k">def</span> <span class="nf">get_callback_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a task for calling back this Pipeline.</span>

<span class="sd">    Args:</span>
<span class="sd">      params: Keyword argument containing a dictionary of key/value pairs</span>
<span class="sd">        that will be passed to the callback when it is executed.</span>
<span class="sd">      args, kwargs: Passed to the taskqueue.Task constructor. Use these</span>
<span class="sd">        arguments to set the task name (for idempotence), etc.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A taskqueue.Task instance that must be enqueued by the caller.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">async</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">UnexpectedPipelineError</span><span class="p">(</span>
          <span class="s">&#39;May only call get_callback_task() method for asynchronous pipelines.&#39;</span><span class="p">)</span>

    <span class="n">params</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;params&#39;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span>
    <span class="n">params</span><span class="p">[</span><span class="s">&#39;pipeline_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_path</span> <span class="o">+</span> <span class="s">&#39;/callback&#39;</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;POST&#39;</span>
    <span class="k">return</span> <span class="n">taskqueue</span><span class="o">.</span><span class="n">Task</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Pipeline.send_result_email"><a class="viewcode-back" href="../../pipeline.html#pipeline.pipeline.Pipeline.send_result_email">[docs]</a>  <span class="k">def</span> <span class="nf">send_result_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sends an email to admins indicating this Pipeline has completed.</span>

<span class="sd">    For developer convenience. Automatically called from finalized for root</span>
<span class="sd">    Pipelines that do not override the default action.</span>

<span class="sd">    Args:</span>
<span class="sd">      sender: (optional) Override the sender&#39;s email address.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">status</span> <span class="o">=</span> <span class="s">&#39;successful&#39;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">was_aborted</span><span class="p">:</span>
      <span class="n">status</span> <span class="o">=</span> <span class="s">&#39;aborted&#39;</span>

    <span class="n">app_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;APPLICATION_ID&#39;</span><span class="p">]</span>
    <span class="n">shard_index</span> <span class="o">=</span> <span class="n">app_id</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;~&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">shard_index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
      <span class="n">app_id</span> <span class="o">=</span> <span class="n">app_id</span><span class="p">[</span><span class="n">shard_index</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>

    <span class="n">param_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
        <span class="s">&#39;app_id&#39;</span><span class="p">:</span> <span class="n">app_id</span><span class="p">,</span>
        <span class="s">&#39;class_path&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_class_path</span><span class="p">,</span>
        <span class="s">&#39;pipeline_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_pipeline_id</span><span class="p">,</span>
        <span class="s">&#39;base_path&#39;</span><span class="p">:</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">.appspot.com</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">app_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_path</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="n">subject</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s">&#39;Pipeline </span><span class="si">%(status)s</span><span class="s">: App &quot;</span><span class="si">%(app_id)s</span><span class="s">&quot;, </span><span class="si">%(class_path)s</span><span class="s">&#39;</span>
        <span class="s">&#39;#</span><span class="si">%(pipeline_id)s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">param_dict</span><span class="p">)</span>
    <span class="n">body</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;View the pipeline results here:</span>

<span class="s">http://</span><span class="si">%(base_path)s</span><span class="s">/status?root=</span><span class="si">%(pipeline_id)s</span><span class="s"></span>

<span class="s">Thanks,</span>

<span class="s">The Pipeline API</span>
<span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">param_dict</span>

    <span class="n">html</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;&lt;html&gt;&lt;body&gt;</span>
<span class="s">&lt;p&gt;View the pipeline results here:&lt;/p&gt;</span>

<span class="s">&lt;p&gt;&lt;a href=&quot;http://</span><span class="si">%(base_path)s</span><span class="s">/status?root=</span><span class="si">%(pipeline_id)s</span><span class="s">&quot;</span>
<span class="s">&gt;http://</span><span class="si">%(base_path)s</span><span class="s">/status?root=</span><span class="si">%(pipeline_id)s</span><span class="s">&lt;/a&gt;&lt;/p&gt;</span>

<span class="s">&lt;p&gt;</span>
<span class="s">Thanks,</span>
<span class="s">&lt;br&gt;</span>
<span class="s">The Pipeline API</span>
<span class="s">&lt;/p&gt;</span>
<span class="s">&lt;/body&gt;&lt;/html&gt;</span>
<span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">param_dict</span>

    <span class="k">if</span> <span class="n">sender</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">sender</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">@</span><span class="si">%s</span><span class="s">.appspotmail.com&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">app_id</span><span class="p">,</span> <span class="n">app_id</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_send_mail</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">html</span><span class="o">=</span><span class="n">html</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">mail</span><span class="o">.</span><span class="n">InvalidSenderError</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">InvalidEmailError</span><span class="p">):</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Could not send result email for &#39;</span>
                      <span class="s">&#39;root pipeline ID &quot;</span><span class="si">%s</span><span class="s">&quot; from sender &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">root_pipeline_id</span><span class="p">,</span> <span class="n">sender</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Pipeline.cleanup"><a class="viewcode-back" href="../../pipeline.html#pipeline.pipeline.Pipeline.cleanup">[docs]</a>  <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Clean up this Pipeline and all Datastore records used for coordination.</span>

<span class="sd">    Only works when called on a root pipeline. Child pipelines will ignore</span>
<span class="sd">    calls to this method.</span>

<span class="sd">    After this method is called, Pipeline.from_id() and related status</span>
<span class="sd">    methods will return inconsistent or missing results. This method is</span>
<span class="sd">    fire-and-forget and asynchronous.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root_pipeline_key</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">UnexpectedPipelineError</span><span class="p">(</span>
          <span class="s">&#39;Could not cleanup Pipeline with unknown root pipeline ID.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_root</span><span class="p">:</span>
      <span class="k">return</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">taskqueue</span><span class="o">.</span><span class="n">Task</span><span class="p">(</span>
        <span class="n">params</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">root_pipeline_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_root_pipeline_key</span><span class="p">),</span>
        <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_path</span> <span class="o">+</span> <span class="s">&#39;/cleanup&#39;</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;X-Ae-Pipeline-Key&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root_pipeline_key</span><span class="p">})</span>
    <span class="n">taskqueue</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queue_name</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Pipeline.with_params"><a class="viewcode-back" href="../../pipeline.html#pipeline.pipeline.Pipeline.with_params">[docs]</a>  <span class="k">def</span> <span class="nf">with_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Modify various execution parameters of a Pipeline before it runs.</span>

<span class="sd">    This method has no effect in test mode.</span>

<span class="sd">    Args:</span>
<span class="sd">      kwargs: Attributes to modify on this Pipeline instance before it has</span>
<span class="sd">        been executed.</span>

<span class="sd">    Returns:</span>
<span class="sd">      This Pipeline instance, for easy chaining.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">_TEST_MODE</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
          <span class="s">&#39;Setting runtime parameters for </span><span class="si">%s</span><span class="s">#</span><span class="si">%s</span><span class="s">: </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span>
          <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_id</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
      <span class="k">return</span> <span class="bp">self</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">UnexpectedPipelineError</span><span class="p">(</span>
          <span class="s">&#39;May only call with_params() on a Pipeline that has not yet &#39;</span>
          <span class="s">&#39;been scheduled for execution.&#39;</span><span class="p">)</span>

    <span class="n">ALLOWED</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;backoff_seconds&#39;</span><span class="p">,</span> <span class="s">&#39;backoff_factor&#39;</span><span class="p">,</span> <span class="s">&#39;max_attempts&#39;</span><span class="p">,</span> <span class="s">&#39;target&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ALLOWED</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Unexpected keyword: </span><span class="si">%s</span><span class="s">=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
      <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span>

  <span class="c"># Methods implemented by developers for lifecycle management. These</span>
  <span class="c"># must be idempotent under all circumstances.</span></div>
<div class="viewcode-block" id="Pipeline.run"><a class="viewcode-back" href="../../pipeline.html#pipeline.pipeline.Pipeline.run">[docs]</a>  <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Runs this Pipeline.&quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;Must implement &quot;run&quot; in Pipeline sub-class.&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Pipeline.run_test"><a class="viewcode-back" href="../../pipeline.html#pipeline.pipeline.Pipeline.run_test">[docs]</a>  <span class="k">def</span> <span class="nf">run_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Runs this Pipeline in test mode.&quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
        <span class="s">&#39;Must implement &quot;run_test&quot; in Pipeline sub-class.&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Pipeline.finalized"><a class="viewcode-back" href="../../pipeline.html#pipeline.pipeline.Pipeline.finalized">[docs]</a>  <span class="k">def</span> <span class="nf">finalized</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Finalizes this Pipeline after execution if it&#39;s a generator.</span>

<span class="sd">    Default action as the root pipeline is to email the admins with the status.</span>
<span class="sd">    Implementors be sure to call &#39;was_aborted&#39; to find out if the finalization</span>
<span class="sd">    that you&#39;re handling is for a success or error case.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_pipeline_id</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">send_result_email</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Pipeline.finalized_test"><a class="viewcode-back" href="../../pipeline.html#pipeline.pipeline.Pipeline.finalized_test">[docs]</a>  <span class="k">def</span> <span class="nf">finalized_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Finalized this Pipeline in test mode.&quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
        <span class="s">&#39;Must implement &quot;finalized_test&quot; in Pipeline sub-class.&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Pipeline.callback"><a class="viewcode-back" href="../../pipeline.html#pipeline.pipeline.Pipeline.callback">[docs]</a>  <span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This Pipeline received an asynchronous callback request.&quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
        <span class="s">&#39;Must implement &quot;callback&quot; in Pipeline sub-class.&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Pipeline.try_cancel"><a class="viewcode-back" href="../../pipeline.html#pipeline.pipeline.Pipeline.try_cancel">[docs]</a>  <span class="k">def</span> <span class="nf">try_cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This pipeline has been cancelled.</span>

<span class="sd">    Called when a pipeline is interrupted part-way through due to some kind</span>
<span class="sd">    of failure (an abort of the whole pipeline to the root or a forced retry on</span>
<span class="sd">    this child pipeline).</span>

<span class="sd">    Returns:</span>
<span class="sd">      True to indicate that cancellation was successful and this pipeline may</span>
<span class="sd">      go in the retry or aborted state; False to indicate that this pipeline</span>
<span class="sd">      cannot be canceled right now and must remain as-is.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">False</span>

  <span class="c"># Internal methods.</span></div>
  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">_set_class_path</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">module_dict</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sets the absolute path to this class as a string.</span>

<span class="sd">    Used by the Pipeline API to reconstruct the Pipeline sub-class object</span>
<span class="sd">    at execution time instead of passing around a serialized function.</span>

<span class="sd">    Args:</span>
<span class="sd">      module_dict: Used for testing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Do not traverse the class hierarchy fetching the class path attribute.</span>
    <span class="n">found</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;_class_path&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">found</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="c"># Do not set the _class_path for the base-class, otherwise all children&#39;s</span>
    <span class="c"># lookups for _class_path will fall through and return &#39;Pipeline&#39; above.</span>
    <span class="c"># This situation can happen if users call the generic Pipeline.from_id</span>
    <span class="c"># to get the result of a Pipeline without knowing its specific class.</span>
    <span class="k">if</span> <span class="n">cls</span> <span class="ow">is</span> <span class="n">Pipeline</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="n">class_path</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">__module__</span><span class="p">,</span> <span class="n">cls</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
    <span class="c"># When a WSGI handler is invoked as an entry point, any Pipeline class</span>
    <span class="c"># defined in the same file as the handler will get __module__ set to</span>
    <span class="c"># __main__. Thus we need to find out its real fully qualified path.</span>
    <span class="k">if</span> <span class="n">cls</span><span class="o">.</span><span class="n">__module__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">module_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
          <span class="k">continue</span>
        <span class="n">found</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">cls</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">found</span> <span class="ow">is</span> <span class="n">cls</span><span class="p">:</span>
          <span class="n">class_path</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">cls</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
          <span class="k">break</span>
    <span class="n">cls</span><span class="o">.</span><span class="n">_class_path</span> <span class="o">=</span> <span class="n">class_path</span>

  <span class="k">def</span> <span class="nf">_set_values_internal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                           <span class="n">context</span><span class="p">,</span>
                           <span class="n">pipeline_key</span><span class="p">,</span>
                           <span class="n">root_pipeline_key</span><span class="p">,</span>
                           <span class="n">outputs</span><span class="p">,</span>
                           <span class="n">result_status</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sets the user-visible values provided as an API by this class.</span>

<span class="sd">    Args:</span>
<span class="sd">      context: The _PipelineContext used for this Pipeline.</span>
<span class="sd">      pipeline_key: The db.Key of this pipeline.</span>
<span class="sd">      root_pipeline_key: The db.Key of the root pipeline.</span>
<span class="sd">      outputs: The PipelineFuture for this pipeline.</span>
<span class="sd">      result_status: The result status of this pipeline.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_context</span> <span class="o">=</span> <span class="n">context</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_pipeline_key</span> <span class="o">=</span> <span class="n">pipeline_key</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_root_pipeline_key</span> <span class="o">=</span> <span class="n">root_pipeline_key</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_result_status</span> <span class="o">=</span> <span class="n">result_status</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="n">outputs</span>

  <span class="k">def</span> <span class="nf">_callback_internal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Used to execute callbacks on asynchronous pipelines.&quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Callback </span><span class="si">%s</span><span class="s">(*</span><span class="si">%s</span><span class="s">, **</span><span class="si">%s</span><span class="s">)#</span><span class="si">%s</span><span class="s"> with params: </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">_class_path</span><span class="p">,</span> <span class="n">_short_repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">),</span>
                  <span class="n">_short_repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_run_internal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">context</span><span class="p">,</span>
                    <span class="n">pipeline_key</span><span class="p">,</span>
                    <span class="n">root_pipeline_key</span><span class="p">,</span>
                    <span class="n">caller_output</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Used by the Pipeline evaluator to execute this Pipeline.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_set_values_internal</span><span class="p">(</span>
        <span class="n">context</span><span class="p">,</span> <span class="n">pipeline_key</span><span class="p">,</span> <span class="n">root_pipeline_key</span><span class="p">,</span> <span class="n">caller_output</span><span class="p">,</span>
        <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">RUN</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Running </span><span class="si">%s</span><span class="s">(*</span><span class="si">%s</span><span class="s">, **</span><span class="si">%s</span><span class="s">)#</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">_class_path</span><span class="p">,</span> <span class="n">_short_repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">),</span>
                  <span class="n">_short_repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_finalized_internal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                          <span class="n">context</span><span class="p">,</span>
                          <span class="n">pipeline_key</span><span class="p">,</span>
                          <span class="n">root_pipeline_key</span><span class="p">,</span>
                          <span class="n">caller_output</span><span class="p">,</span>
                          <span class="n">aborted</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Used by the Pipeline evaluator to finalize this Pipeline.&quot;&quot;&quot;</span>
    <span class="n">result_status</span> <span class="o">=</span> <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">RUN</span>
    <span class="k">if</span> <span class="n">aborted</span><span class="p">:</span>
      <span class="n">result_status</span> <span class="o">=</span> <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">ABORTED</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_set_values_internal</span><span class="p">(</span>
        <span class="n">context</span><span class="p">,</span> <span class="n">pipeline_key</span><span class="p">,</span> <span class="n">root_pipeline_key</span><span class="p">,</span> <span class="n">caller_output</span><span class="p">,</span> <span class="n">result_status</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Finalizing </span><span class="si">%s</span><span class="s">(*</span><span class="si">%r</span><span class="s">, **</span><span class="si">%r</span><span class="s">)#</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">_class_path</span><span class="p">,</span> <span class="n">_short_repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">),</span>
                  <span class="n">_short_repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">finalized</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
      <span class="k">pass</span>

  <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a string representation of this Pipeline.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">(*</span><span class="si">%s</span><span class="s">, **</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_class_path</span><span class="p">,</span> <span class="n">_short_repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">),</span> <span class="n">_short_repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">))</span>


<span class="c"># TODO: Change InOrder and After to use a common thread-local list of</span>
<span class="c"># execution modifications to apply to the current evaluating pipeline.</span>
</div>
<div class="viewcode-block" id="After"><a class="viewcode-back" href="../../pipeline.html#pipeline.pipeline.After">[docs]</a><span class="k">class</span> <span class="nc">After</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Causes all contained Pipelines to run after the given ones complete.</span>

<span class="sd">  Must be used in a &#39;with&#39; block.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">_local</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">local</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">futures</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initializer.</span>

<span class="sd">    Args:</span>
<span class="sd">      *futures: PipelineFutures that all subsequent pipelines should follow.</span>
<span class="sd">        May be empty, in which case this statement does nothing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">futures</span><span class="p">:</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">PipelineFuture</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;May only pass PipelineFuture instances to After(). </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span>
                        <span class="nb">type</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_futures</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;When entering a &#39;with&#39; block.&quot;&quot;&quot;</span>
    <span class="n">After</span><span class="o">.</span><span class="n">_thread_init</span><span class="p">()</span>
    <span class="n">After</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">_after_all_futures</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_futures</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;When exiting a &#39;with&#39; block.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_futures</span><span class="p">:</span>
      <span class="n">After</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">_after_all_futures</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">False</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">_thread_init</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Ensure thread local is initialized.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">_local</span><span class="p">,</span> <span class="s">&#39;_after_all_futures&#39;</span><span class="p">):</span>
      <span class="n">cls</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">_after_all_futures</span> <span class="o">=</span> <span class="p">[]</span>

</div>
<div class="viewcode-block" id="InOrder"><a class="viewcode-back" href="../../pipeline.html#pipeline.pipeline.InOrder">[docs]</a><span class="k">class</span> <span class="nc">InOrder</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Causes all contained Pipelines to run in order.</span>

<span class="sd">  Must be used in a &#39;with&#39; block.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">_local</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">local</span><span class="p">()</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">_add_future</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">future</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adds a future to the list of in-order futures thus far.</span>

<span class="sd">    Args:</span>
<span class="sd">      future: The future to add to the list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cls</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">_activated</span><span class="p">:</span>
      <span class="n">cls</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">_in_order_futures</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initializer.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;When entering a &#39;with&#39; block.&quot;&quot;&quot;</span>
    <span class="n">InOrder</span><span class="o">.</span><span class="n">_thread_init</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">InOrder</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">_activated</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">UnexpectedPipelineError</span><span class="p">(</span><span class="s">&#39;Already in an InOrder &quot;with&quot; block.&#39;</span><span class="p">)</span>
    <span class="n">InOrder</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">_activated</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">InOrder</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">_in_order_futures</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;When exiting a &#39;with&#39; block.&quot;&quot;&quot;</span>
    <span class="n">InOrder</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">_activated</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">InOrder</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">_in_order_futures</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">False</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">_thread_init</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Ensure thread local is initialized.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">_local</span><span class="p">,</span> <span class="s">&#39;_in_order_futures&#39;</span><span class="p">):</span>
      <span class="n">cls</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">_in_order_futures</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
      <span class="n">cls</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">_activated</span> <span class="o">=</span> <span class="bp">False</span>


<span class="c">################################################################################</span>
</div>
<span class="k">def</span> <span class="nf">_short_repr</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Helper function returns a truncated repr() of an object.&quot;&quot;&quot;</span>
  <span class="n">stringified</span> <span class="o">=</span> <span class="n">pprint</span><span class="o">.</span><span class="n">saferepr</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stringified</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">:</span>
    <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">... (</span><span class="si">%d</span><span class="s"> bytes)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">stringified</span><span class="p">[:</span><span class="mi">200</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">stringified</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">stringified</span>


<span class="k">def</span> <span class="nf">_write_json_blob</span><span class="p">(</span><span class="n">encoded_value</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Writes a JSON encoded value to a Blobstore File.</span>

<span class="sd">  Args:</span>
<span class="sd">    encoded_value: The encoded JSON string.</span>

<span class="sd">  Returns:</span>
<span class="sd">    The blobstore.BlobKey for the file that was created.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">file_name</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">blobstore</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">mime_type</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">)</span>
  <span class="n">handle</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">)</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="c"># Chunk the file into individual writes of less than 1MB, since the files</span>
    <span class="c"># API does not do buffered writes implicitly.</span>
    <span class="k">for</span> <span class="n">start_index</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">encoded_value</span><span class="p">),</span> <span class="n">_MAX_JSON_SIZE</span><span class="p">):</span>
      <span class="n">end_index</span> <span class="o">=</span> <span class="n">start_index</span> <span class="o">+</span> <span class="n">_MAX_JSON_SIZE</span>
      <span class="n">handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">encoded_value</span><span class="p">[</span><span class="n">start_index</span><span class="p">:</span><span class="n">end_index</span><span class="p">])</span>
  <span class="k">finally</span><span class="p">:</span>
    <span class="n">handle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

  <span class="n">files</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">files</span><span class="o">.</span><span class="n">blobstore</span><span class="o">.</span><span class="n">get_blob_key</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_dereference_args</span><span class="p">(</span><span class="n">pipeline_name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Dereference a Pipeline&#39;s arguments that are slots, validating them.</span>

<span class="sd">  Each argument value passed in is assumed to be a dictionary with the format:</span>
<span class="sd">    {&#39;type&#39;: &#39;value&#39;, &#39;value&#39;: &#39;serializable&#39;}  # A resolved value.</span>
<span class="sd">    {&#39;type&#39;: &#39;slot&#39;, &#39;slot_key&#39;: &#39;str() on a db.Key&#39;}  # A pending Slot.</span>

<span class="sd">  Args:</span>
<span class="sd">    pipeline_name: The name of the pipeline class; used for debugging.</span>
<span class="sd">    args: Iterable of positional arguments.</span>
<span class="sd">    kwargs: Dictionary of keyword arguments.</span>

<span class="sd">  Returns:</span>
<span class="sd">    Tuple (args, kwargs) where:</span>
<span class="sd">      Args: A list of positional arguments values that are all dereferenced.</span>
<span class="sd">      Kwargs: A list of keyword arguments values that are all dereferenced.</span>

<span class="sd">  Raises:</span>
<span class="sd">    SlotNotFilledError if any of the supplied &#39;slot_key&#39; records are not</span>
<span class="sd">    present in the Datastore or have not yet been filled.</span>
<span class="sd">    UnexpectedPipelineError if an unknown parameter type was passed.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">lookup_slots</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
  <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">itervalues</span><span class="p">()):</span>
    <span class="k">if</span> <span class="n">arg</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;slot&#39;</span><span class="p">:</span>
      <span class="n">lookup_slots</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Key</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="s">&#39;slot_key&#39;</span><span class="p">]))</span>

  <span class="n">slot_dict</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">slot_record</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lookup_slots</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">lookup_slots</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">slot_record</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">slot_record</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">_SlotRecord</span><span class="o">.</span><span class="n">FILLED</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">SlotNotFilledError</span><span class="p">(</span>
          <span class="s">&#39;Slot &quot;</span><span class="si">%s</span><span class="s">&quot; missing its value. From </span><span class="si">%s</span><span class="s">(*args=</span><span class="si">%s</span><span class="s">, **kwargs=</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span>
          <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">pipeline_name</span><span class="p">,</span> <span class="n">_short_repr</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="n">_short_repr</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)))</span>
    <span class="n">slot_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">slot_record</span><span class="o">.</span><span class="n">value</span>

  <span class="n">arg_list</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">current_arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">current_arg</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;slot&#39;</span><span class="p">:</span>
      <span class="n">arg_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slot_dict</span><span class="p">[</span><span class="n">db</span><span class="o">.</span><span class="n">Key</span><span class="p">(</span><span class="n">current_arg</span><span class="p">[</span><span class="s">&#39;slot_key&#39;</span><span class="p">])])</span>
    <span class="k">elif</span> <span class="n">current_arg</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;value&#39;</span><span class="p">:</span>
      <span class="n">arg_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_arg</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">UnexpectedPipelineError</span><span class="p">(</span><span class="s">&#39;Unknown parameter type: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">current_arg</span><span class="p">)</span>

  <span class="n">kwarg_dict</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">current_arg</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">current_arg</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;slot&#39;</span><span class="p">:</span>
      <span class="n">kwarg_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">slot_dict</span><span class="p">[</span><span class="n">db</span><span class="o">.</span><span class="n">Key</span><span class="p">(</span><span class="n">current_arg</span><span class="p">[</span><span class="s">&#39;slot_key&#39;</span><span class="p">])]</span>
    <span class="k">elif</span> <span class="n">current_arg</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;value&#39;</span><span class="p">:</span>
      <span class="n">kwarg_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_arg</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">UnexpectedPipelineError</span><span class="p">(</span><span class="s">&#39;Unknown parameter type: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">current_arg</span><span class="p">)</span>

  <span class="k">return</span> <span class="p">(</span><span class="n">arg_list</span><span class="p">,</span> <span class="n">kwarg_dict</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_generate_args</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">future</span><span class="p">,</span> <span class="n">queue_name</span><span class="p">,</span> <span class="n">base_path</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Generate the params used to describe a Pipeline&#39;s depedencies.</span>

<span class="sd">  The arguments passed to this method may be normal values, Slot instances</span>
<span class="sd">  (for named outputs), or PipelineFuture instances (for referring to the</span>
<span class="sd">  default output slot).</span>

<span class="sd">  Args:</span>
<span class="sd">    pipeline: The Pipeline instance to generate args for.</span>
<span class="sd">    future: The PipelineFuture for the Pipeline these arguments correspond to.</span>
<span class="sd">    queue_name: The queue to run the pipeline on.</span>
<span class="sd">    base_path: Relative URL for pipeline URL handlers.</span>

<span class="sd">  Returns:</span>
<span class="sd">    Tuple (dependent_slots, output_slot_keys, params_text, params_blob) where:</span>
<span class="sd">      dependent_slots: List of db.Key instances of _SlotRecords on which</span>
<span class="sd">        this pipeline will need to block before execution (passed to</span>
<span class="sd">        create a _BarrierRecord for running the pipeline).</span>
<span class="sd">      output_slot_keys: List of db.Key instances of _SlotRecords that will</span>
<span class="sd">        be filled by this pipeline during its execution (passed to create</span>
<span class="sd">        a _BarrierRecord for finalizing the pipeline).</span>
<span class="sd">      params_text: JSON dictionary of pipeline parameters to be serialized and</span>
<span class="sd">        saved in a corresponding _PipelineRecord. Will be None if the params are</span>
<span class="sd">        too big and must be saved in a blob instead.</span>
<span class="sd">      params_blob: JSON dictionary of pipeline parameters to be serialized and</span>
<span class="sd">        saved in a Blob file, and then attached to a _PipelineRecord. Will be</span>
<span class="sd">        None if the params data size was small enough to fit in the entity.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s">&#39;args&#39;</span><span class="p">:</span> <span class="p">[],</span>
      <span class="s">&#39;kwargs&#39;</span><span class="p">:</span> <span class="p">{},</span>
      <span class="s">&#39;after_all&#39;</span><span class="p">:</span> <span class="p">[],</span>
      <span class="s">&#39;output_slots&#39;</span><span class="p">:</span> <span class="p">{},</span>
      <span class="s">&#39;class_path&#39;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_class_path</span><span class="p">,</span>
      <span class="s">&#39;queue_name&#39;</span><span class="p">:</span> <span class="n">queue_name</span><span class="p">,</span>
      <span class="s">&#39;base_path&#39;</span><span class="p">:</span> <span class="n">base_path</span><span class="p">,</span>
      <span class="s">&#39;backoff_seconds&#39;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">backoff_seconds</span><span class="p">,</span>
      <span class="s">&#39;backoff_factor&#39;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">backoff_factor</span><span class="p">,</span>
      <span class="s">&#39;max_attempts&#39;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">max_attempts</span><span class="p">,</span>
      <span class="s">&#39;task_retry&#39;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">task_retry</span><span class="p">,</span>
      <span class="s">&#39;target&#39;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
  <span class="p">}</span>
  <span class="n">dependent_slots</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

  <span class="n">arg_list</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;args&#39;</span><span class="p">]</span>
  <span class="k">for</span> <span class="n">current_arg</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">current_arg</span><span class="p">,</span> <span class="n">PipelineFuture</span><span class="p">):</span>
      <span class="n">current_arg</span> <span class="o">=</span> <span class="n">current_arg</span><span class="o">.</span><span class="n">default</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">current_arg</span><span class="p">,</span> <span class="n">Slot</span><span class="p">):</span>
      <span class="n">arg_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;slot&#39;</span><span class="p">,</span> <span class="s">&#39;slot_key&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_arg</span><span class="o">.</span><span class="n">key</span><span class="p">)})</span>
      <span class="n">dependent_slots</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">current_arg</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">arg_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;value&#39;</span><span class="p">,</span> <span class="s">&#39;value&#39;</span><span class="p">:</span> <span class="n">current_arg</span><span class="p">})</span>

  <span class="n">kwarg_dict</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;kwargs&#39;</span><span class="p">]</span>
  <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">current_arg</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">current_arg</span><span class="p">,</span> <span class="n">PipelineFuture</span><span class="p">):</span>
      <span class="n">current_arg</span> <span class="o">=</span> <span class="n">current_arg</span><span class="o">.</span><span class="n">default</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">current_arg</span><span class="p">,</span> <span class="n">Slot</span><span class="p">):</span>
      <span class="n">kwarg_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;slot&#39;</span><span class="p">,</span> <span class="s">&#39;slot_key&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_arg</span><span class="o">.</span><span class="n">key</span><span class="p">)}</span>
      <span class="n">dependent_slots</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">current_arg</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">kwarg_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;value&#39;</span><span class="p">,</span> <span class="s">&#39;value&#39;</span><span class="p">:</span> <span class="n">current_arg</span><span class="p">}</span>

  <span class="n">after_all</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;after_all&#39;</span><span class="p">]</span>
  <span class="k">for</span> <span class="n">other_future</span> <span class="ow">in</span> <span class="n">future</span><span class="o">.</span><span class="n">_after_all_pipelines</span><span class="p">:</span>
    <span class="n">slot_key</span> <span class="o">=</span> <span class="n">other_future</span><span class="o">.</span><span class="n">_output_dict</span><span class="p">[</span><span class="s">&#39;default&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">key</span>
    <span class="n">after_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">slot_key</span><span class="p">))</span>
    <span class="n">dependent_slots</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">slot_key</span><span class="p">)</span>

  <span class="n">output_slots</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;output_slots&#39;</span><span class="p">]</span>
  <span class="n">output_slot_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
  <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">future</span><span class="o">.</span><span class="n">_output_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
    <span class="n">output_slot_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">slot</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
    <span class="n">output_slots</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">slot</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>

  <span class="n">params_encoded</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">cls</span><span class="o">=</span><span class="n">mr_util</span><span class="o">.</span><span class="n">JsonEncoder</span><span class="p">)</span>
  <span class="n">params_text</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="n">params_blob</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">params_encoded</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">_MAX_JSON_SIZE</span><span class="p">:</span>
    <span class="n">params_blob</span> <span class="o">=</span> <span class="n">_write_json_blob</span><span class="p">(</span><span class="n">params_encoded</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">params_text</span> <span class="o">=</span> <span class="n">params_encoded</span>

  <span class="k">return</span> <span class="n">dependent_slots</span><span class="p">,</span> <span class="n">output_slot_keys</span><span class="p">,</span> <span class="n">params_text</span><span class="p">,</span> <span class="n">params_blob</span>


<span class="k">class</span> <span class="nc">_PipelineContext</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Internal API for interacting with Pipeline state.&quot;&quot;&quot;</span>

  <span class="n">_gettime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
               <span class="n">task_name</span><span class="p">,</span>
               <span class="n">queue_name</span><span class="p">,</span>
               <span class="n">base_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initializer.</span>

<span class="sd">    Args:</span>
<span class="sd">      task_name: The name of the currently running task or empty if there</span>
<span class="sd">        is no task running.</span>
<span class="sd">      queue_name: The queue this pipeline should run on (may not be the</span>
<span class="sd">        current queue this request is on).</span>
<span class="sd">      base_path: Relative URL for the pipeline&#39;s handlers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">task_name</span> <span class="o">=</span> <span class="n">task_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">queue_name</span> <span class="o">=</span> <span class="n">queue_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">base_path</span> <span class="o">=</span> <span class="n">base_path</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">barrier_handler_path</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/output&#39;</span> <span class="o">%</span> <span class="n">base_path</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_handler_path</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/run&#39;</span> <span class="o">%</span> <span class="n">base_path</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">finalized_handler_path</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/finalized&#39;</span> <span class="o">%</span> <span class="n">base_path</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fanout_handler_path</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/fanout&#39;</span> <span class="o">%</span> <span class="n">base_path</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">abort_handler_path</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/abort&#39;</span> <span class="o">%</span> <span class="n">base_path</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fanout_abort_handler_path</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/fanout_abort&#39;</span> <span class="o">%</span> <span class="n">base_path</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">session_filled_output_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">from_environ</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">environ</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Constructs a _PipelineContext from the task queue environment.&quot;&quot;&quot;</span>
    <span class="n">base_path</span><span class="p">,</span> <span class="n">unused</span> <span class="o">=</span> <span class="p">(</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;PATH_INFO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">])[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">cls</span><span class="p">(</span>
        <span class="n">environ</span><span class="p">[</span><span class="s">&#39;HTTP_X_APPENGINE_TASKNAME&#39;</span><span class="p">],</span>
        <span class="n">environ</span><span class="p">[</span><span class="s">&#39;HTTP_X_APPENGINE_QUEUENAME&#39;</span><span class="p">],</span>
        <span class="n">base_path</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">fill_slot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filler_pipeline_key</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fills a slot, enqueueing a task to trigger pending barriers.</span>

<span class="sd">    Args:</span>
<span class="sd">      filler_pipeline_key: db.Key or stringified key of the _PipelineRecord</span>
<span class="sd">        that filled this slot.</span>
<span class="sd">      slot: The Slot instance to fill.</span>
<span class="sd">      value: The serializable value to assign.</span>

<span class="sd">    Raises:</span>
<span class="sd">      UnexpectedPipelineError if the _SlotRecord for the &#39;slot&#39; could not</span>
<span class="sd">      be found in the Datastore.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filler_pipeline_key</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Key</span><span class="p">):</span>
      <span class="n">filler_pipeline_key</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Key</span><span class="p">(</span><span class="n">filler_pipeline_key</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">_TEST_MODE</span><span class="p">:</span>
      <span class="n">slot</span><span class="o">.</span><span class="n">_set_value_test</span><span class="p">(</span><span class="n">filler_pipeline_key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">encoded_value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">,</span>
                                       <span class="n">sort_keys</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                       <span class="n">cls</span><span class="o">=</span><span class="n">mr_util</span><span class="o">.</span><span class="n">JsonEncoder</span><span class="p">)</span>
      <span class="n">value_text</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="n">value_blob</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">encoded_value</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">_MAX_JSON_SIZE</span><span class="p">:</span>
        <span class="n">value_text</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">encoded_value</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="c"># The encoded value is too big. Save it as a blob.</span>
        <span class="n">value_blob</span> <span class="o">=</span> <span class="n">_write_json_blob</span><span class="p">(</span><span class="n">encoded_value</span><span class="p">)</span>

      <span class="k">def</span> <span class="nf">txn</span><span class="p">():</span>
        <span class="n">slot_record</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">slot</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">slot_record</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
          <span class="k">raise</span> <span class="n">UnexpectedPipelineError</span><span class="p">(</span>
              <span class="s">&#39;Tried to fill missing slot &quot;</span><span class="si">%s</span><span class="s">&quot; &#39;</span>
              <span class="s">&#39;by pipeline ID &quot;</span><span class="si">%s</span><span class="s">&quot; with value: </span><span class="si">%r</span><span class="s">&#39;</span>
              <span class="o">%</span> <span class="p">(</span><span class="n">slot</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">filler_pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">value</span><span class="p">))</span>
        <span class="c"># NOTE: Always take the override value here. If down-stream pipelines</span>
        <span class="c"># need a consitent view of all up-stream outputs (meaning, all of the</span>
        <span class="c"># outputs came from the same retry attempt of the upstream pipeline),</span>
        <span class="c"># the down-stream pipeline must also wait for the &#39;default&#39; output</span>
        <span class="c"># of these up-stream pipelines.</span>
        <span class="n">slot_record</span><span class="o">.</span><span class="n">filler</span> <span class="o">=</span> <span class="n">filler_pipeline_key</span>
        <span class="n">slot_record</span><span class="o">.</span><span class="n">value_text</span> <span class="o">=</span> <span class="n">value_text</span>
        <span class="n">slot_record</span><span class="o">.</span><span class="n">value_blob</span> <span class="o">=</span> <span class="n">value_blob</span>
        <span class="n">slot_record</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">_SlotRecord</span><span class="o">.</span><span class="n">FILLED</span>
        <span class="n">slot_record</span><span class="o">.</span><span class="n">fill_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gettime</span><span class="p">()</span>
        <span class="n">slot_record</span><span class="o">.</span><span class="n">put</span><span class="p">()</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">taskqueue</span><span class="o">.</span><span class="n">Task</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">barrier_handler_path</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">slot_key</span><span class="o">=</span><span class="n">slot</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
                <span class="n">use_barrier_indexes</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;X-Ae-Slot-Key&#39;</span><span class="p">:</span> <span class="n">slot</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
                     <span class="s">&#39;X-Ae-Filler-Pipeline-Key&#39;</span><span class="p">:</span> <span class="n">filler_pipeline_key</span><span class="p">})</span>
        <span class="n">task</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">queue_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">queue_name</span><span class="p">,</span> <span class="n">transactional</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
      <span class="n">db</span><span class="o">.</span><span class="n">run_in_transaction_options</span><span class="p">(</span>
          <span class="n">db</span><span class="o">.</span><span class="n">create_transaction_options</span><span class="p">(</span><span class="n">propagation</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">ALLOWED</span><span class="p">),</span> <span class="n">txn</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">session_filled_output_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">slot</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">notify_barriers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                      <span class="n">slot_key</span><span class="p">,</span>
                      <span class="n">cursor</span><span class="p">,</span>
                      <span class="n">use_barrier_indexes</span><span class="p">,</span>
                      <span class="n">max_to_notify</span><span class="o">=</span><span class="n">_MAX_BARRIERS_TO_NOTIFY</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Searches for barriers affected by a slot and triggers completed ones.</span>

<span class="sd">    Args:</span>
<span class="sd">      slot_key: db.Key or stringified key of the _SlotRecord that was filled.</span>
<span class="sd">      cursor: Stringified Datastore cursor where the notification query</span>
<span class="sd">        should pick up.</span>
<span class="sd">      use_barrier_indexes: When True, use _BarrierIndex records to determine</span>
<span class="sd">        which _Barriers to trigger by having this _SlotRecord filled. When</span>
<span class="sd">        False, use the old method that queries for _BarrierRecords by</span>
<span class="sd">        the blocking_slots parameter.</span>
<span class="sd">      max_to_notify: Used for testing.</span>

<span class="sd">    Raises:</span>
<span class="sd">      PipelineStatusError: If any of the barriers are in a bad state.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">slot_key</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Key</span><span class="p">):</span>
      <span class="n">slot_key</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Key</span><span class="p">(</span><span class="n">slot_key</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Notifying slot </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">slot_key</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">use_barrier_indexes</span><span class="p">:</span>
      <span class="c"># Please see models.py:_BarrierIndex to understand how _BarrierIndex</span>
      <span class="c"># entities relate to _BarrierRecord entities.</span>
      <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
          <span class="n">_BarrierIndex</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">cursor</span><span class="o">=</span><span class="n">cursor</span><span class="p">,</span> <span class="n">keys_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
          <span class="o">.</span><span class="n">ancestor</span><span class="p">(</span><span class="n">slot_key</span><span class="p">))</span>
      <span class="n">barrier_index_list</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">max_to_notify</span><span class="p">)</span>
      <span class="n">barrier_key_list</span> <span class="o">=</span> <span class="p">[</span>
          <span class="n">_BarrierIndex</span><span class="o">.</span><span class="n">to_barrier_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">barrier_index_list</span><span class="p">]</span>

      <span class="c"># If there are task and pipeline kickoff retries it&#39;s possible for a</span>
      <span class="c"># _BarrierIndex to exist for a _BarrierRecord that was not successfully</span>
      <span class="c"># written. It&#39;s safe to ignore this because the original task that wrote</span>
      <span class="c"># the _BarrierIndex and _BarrierRecord would not have made progress to</span>
      <span class="c"># kick off a real pipeline or child pipeline unless all of the writes for</span>
      <span class="c"># these dependent entities went through. We assume that the instigator</span>
      <span class="c"># retried from scratch and somehwere there exists a good _BarrierIndex and</span>
      <span class="c"># corresponding _BarrierRecord that tries to accomplish the same thing.</span>
      <span class="n">barriers</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">barrier_key_list</span><span class="p">)</span>
      <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="n">barrier_key</span><span class="p">,</span> <span class="n">barrier</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">barrier_key_list</span><span class="p">,</span> <span class="n">barriers</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">barrier</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Ignoring that Barrier &quot;</span><span class="si">%r</span><span class="s">&quot; is missing, &#39;</span>
                        <span class="s">&#39;relies on Slot &quot;</span><span class="si">%r</span><span class="s">&quot;&#39;</span><span class="p">,</span> <span class="n">barrier_key</span><span class="p">,</span> <span class="n">slot_key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">barrier</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c"># TODO(user): Delete this backwards compatible codepath and</span>
      <span class="c"># make use_barrier_indexes the assumed default in all cases.</span>
      <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
          <span class="n">_BarrierRecord</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">cursor</span><span class="o">=</span><span class="n">cursor</span><span class="p">)</span>
          <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s">&#39;blocking_slots =&#39;</span><span class="p">,</span> <span class="n">slot_key</span><span class="p">))</span>
      <span class="n">results</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">max_to_notify</span><span class="p">)</span>

    <span class="c"># Fetch all blocking _SlotRecords for any potentially triggered barriers.</span>
    <span class="n">blocking_slot_keys</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">barrier</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
      <span class="n">blocking_slot_keys</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">barrier</span><span class="o">.</span><span class="n">blocking_slots</span><span class="p">)</span>

    <span class="n">blocking_slot_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">slot_record</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blocking_slot_keys</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">slot_record</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">continue</span>
      <span class="n">blocking_slot_dict</span><span class="p">[</span><span class="n">slot_record</span><span class="o">.</span><span class="n">key</span><span class="p">()]</span> <span class="o">=</span> <span class="n">slot_record</span>

    <span class="n">task_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">updated_barriers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">barrier</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
      <span class="n">ready_slots</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="n">blocking_slot_key</span> <span class="ow">in</span> <span class="n">barrier</span><span class="o">.</span><span class="n">blocking_slots</span><span class="p">:</span>
        <span class="n">slot_record</span> <span class="o">=</span> <span class="n">blocking_slot_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blocking_slot_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">slot_record</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
          <span class="k">raise</span> <span class="n">UnexpectedPipelineError</span><span class="p">(</span>
              <span class="s">&#39;Barrier &quot;</span><span class="si">%r</span><span class="s">&quot; relies on Slot &quot;</span><span class="si">%r</span><span class="s">&quot; which is missing.&#39;</span> <span class="o">%</span>
              <span class="p">(</span><span class="n">barrier</span><span class="o">.</span><span class="n">key</span><span class="p">(),</span> <span class="n">blocking_slot_key</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">slot_record</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">_SlotRecord</span><span class="o">.</span><span class="n">FILLED</span><span class="p">:</span>
          <span class="n">ready_slots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">blocking_slot_key</span><span class="p">)</span>

      <span class="c"># When all of the blocking_slots have been filled, consider the barrier</span>
      <span class="c"># ready to trigger. We&#39;ll trigger it regardless of the current</span>
      <span class="c"># _BarrierRecord status, since there could be task queue failures at any</span>
      <span class="c"># point in this flow; this rolls forward the state and de-dupes using</span>
      <span class="c"># the task name tombstones.</span>
      <span class="n">pending_slots</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">barrier</span><span class="o">.</span><span class="n">blocking_slots</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">ready_slots</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">pending_slots</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">barrier</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">_BarrierRecord</span><span class="o">.</span><span class="n">FIRED</span><span class="p">:</span>
          <span class="n">barrier</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">_BarrierRecord</span><span class="o">.</span><span class="n">FIRED</span>
          <span class="n">barrier</span><span class="o">.</span><span class="n">trigger_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gettime</span><span class="p">()</span>
          <span class="n">updated_barriers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">barrier</span><span class="p">)</span>

        <span class="n">purpose</span> <span class="o">=</span> <span class="n">barrier</span><span class="o">.</span><span class="n">key</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">purpose</span> <span class="o">==</span> <span class="n">_BarrierRecord</span><span class="o">.</span><span class="n">START</span><span class="p">:</span>
          <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_handler_path</span>
          <span class="n">countdown</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalized_handler_path</span>
          <span class="c"># NOTE: Wait one second before finalization to prevent</span>
          <span class="c"># contention on the _PipelineRecord entity.</span>
          <span class="n">countdown</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">pipeline_key</span> <span class="o">=</span> <span class="n">_BarrierRecord</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">get_value_for_datastore</span><span class="p">(</span><span class="n">barrier</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Firing barrier </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">barrier</span><span class="o">.</span><span class="n">key</span><span class="p">())</span>
        <span class="n">task_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">taskqueue</span><span class="o">.</span><span class="n">Task</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
            <span class="n">countdown</span><span class="o">=</span><span class="n">countdown</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s">&#39;ae-barrier-fire-</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">purpose</span><span class="p">),</span>
            <span class="n">params</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">pipeline_key</span><span class="o">=</span><span class="n">pipeline_key</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="n">purpose</span><span class="p">),</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;X-Ae-Pipeline-Key&#39;</span><span class="p">:</span> <span class="n">pipeline_key</span><span class="p">}))</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Not firing barrier </span><span class="si">%r</span><span class="s">, Waiting for slots: </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span>
                      <span class="n">barrier</span><span class="o">.</span><span class="n">key</span><span class="p">(),</span> <span class="n">pending_slots</span><span class="p">)</span>

    <span class="c"># Blindly overwrite _BarrierRecords that have an updated status. This is</span>
    <span class="c"># acceptable because by this point all finalization barriers for</span>
    <span class="c"># generator children should have already had their final outputs assigned.</span>
    <span class="k">if</span> <span class="n">updated_barriers</span><span class="p">:</span>
      <span class="n">db</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">updated_barriers</span><span class="p">)</span>

    <span class="c"># Task continuation with sequence number to prevent fork-bombs.</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="n">max_to_notify</span><span class="p">:</span>
      <span class="n">the_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;(.*)-ae-barrier-notify-([0-9]+)&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_name</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">the_match</span><span class="p">:</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">the_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">the_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_name</span>
        <span class="n">end</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">task_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">taskqueue</span><span class="o">.</span><span class="n">Task</span><span class="p">(</span>
          <span class="n">name</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">-ae-barrier-notify-</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">end</span><span class="p">),</span>
          <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">barrier_handler_path</span><span class="p">,</span>
          <span class="n">params</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
              <span class="n">slot_key</span><span class="o">=</span><span class="n">slot_key</span><span class="p">,</span>
              <span class="n">cursor</span><span class="o">=</span><span class="n">query</span><span class="o">.</span><span class="n">cursor</span><span class="p">(),</span>
              <span class="n">use_barrier_indexes</span><span class="o">=</span><span class="n">use_barrier_indexes</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">task_list</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">taskqueue</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queue_name</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">task_list</span><span class="p">)</span>
      <span class="k">except</span> <span class="p">(</span><span class="n">taskqueue</span><span class="o">.</span><span class="n">TombstonedTaskError</span><span class="p">,</span> <span class="n">taskqueue</span><span class="o">.</span><span class="n">TaskAlreadyExistsError</span><span class="p">):</span>
        <span class="k">pass</span>

  <span class="k">def</span> <span class="nf">begin_abort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root_pipeline_key</span><span class="p">,</span> <span class="n">abort_message</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Kicks off the abort process for a root pipeline and all its children.</span>

<span class="sd">    Args:</span>
<span class="sd">      root_pipeline_key: db.Key of the root pipeline to abort.</span>
<span class="sd">      abort_message: Message explaining why the abort happened, only saved</span>
<span class="sd">          into the root pipeline.</span>

<span class="sd">    Returns:</span>
<span class="sd">      True if the abort signal was sent successfully; False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">txn</span><span class="p">():</span>
      <span class="n">pipeline_record</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">root_pipeline_key</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">pipeline_record</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s">&#39;Tried to abort root pipeline ID &quot;</span><span class="si">%s</span><span class="s">&quot; but it does not exist.&#39;</span><span class="p">,</span>
            <span class="n">root_pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
        <span class="k">raise</span> <span class="n">db</span><span class="o">.</span><span class="n">Rollback</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">ABORTED</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s">&#39;Tried to abort root pipeline ID &quot;</span><span class="si">%s</span><span class="s">&quot;; already in state: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
            <span class="n">root_pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">db</span><span class="o">.</span><span class="n">Rollback</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">abort_requested</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s">&#39;Tried to abort root pipeline ID &quot;</span><span class="si">%s</span><span class="s">&quot;; abort signal already sent.&#39;</span><span class="p">,</span>
            <span class="n">root_pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
        <span class="k">raise</span> <span class="n">db</span><span class="o">.</span><span class="n">Rollback</span><span class="p">()</span>

      <span class="n">pipeline_record</span><span class="o">.</span><span class="n">abort_requested</span> <span class="o">=</span> <span class="bp">True</span>
      <span class="n">pipeline_record</span><span class="o">.</span><span class="n">abort_message</span> <span class="o">=</span> <span class="n">abort_message</span>
      <span class="n">pipeline_record</span><span class="o">.</span><span class="n">put</span><span class="p">()</span>

      <span class="n">task</span> <span class="o">=</span> <span class="n">taskqueue</span><span class="o">.</span><span class="n">Task</span><span class="p">(</span>
          <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fanout_abort_handler_path</span><span class="p">,</span>
          <span class="n">params</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">root_pipeline_key</span><span class="o">=</span><span class="n">root_pipeline_key</span><span class="p">))</span>
      <span class="n">task</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">queue_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">queue_name</span><span class="p">,</span> <span class="n">transactional</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
      <span class="k">return</span> <span class="bp">True</span>

    <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">run_in_transaction</span><span class="p">(</span><span class="n">txn</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">continue_abort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                     <span class="n">root_pipeline_key</span><span class="p">,</span>
                     <span class="n">cursor</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">max_to_notify</span><span class="o">=</span><span class="n">_MAX_ABORTS_TO_BEGIN</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sends the abort signal to all children for a root pipeline.</span>

<span class="sd">    Args:</span>
<span class="sd">      root_pipeline_key: db.Key of the root pipeline to abort.</span>
<span class="sd">      cursor: The query cursor for enumerating _PipelineRecords when inserting</span>
<span class="sd">        tasks to cause child pipelines to terminate.</span>
<span class="sd">      max_to_notify: Used for testing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">root_pipeline_key</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Key</span><span class="p">):</span>
      <span class="n">root_pipeline_key</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Key</span><span class="p">(</span><span class="n">root_pipeline_key</span><span class="p">)</span>
    <span class="c"># NOTE: The results of this query may include _PipelineRecord instances</span>
    <span class="c"># that are not actually &quot;reachable&quot;, meaning you cannot get to them by</span>
    <span class="c"># starting at the root pipeline and following &quot;fanned_out&quot; onward. This</span>
    <span class="c"># is acceptable because even these defunct _PipelineRecords will properly</span>
    <span class="c"># set their status to ABORTED when the signal comes, regardless of any</span>
    <span class="c"># other status they may have had.</span>
    <span class="c">#</span>
    <span class="c"># The only gotcha here is if a Pipeline&#39;s finalize method somehow modifies</span>
    <span class="c"># its inputs (like deleting an input file). In the case there are</span>
    <span class="c"># unreachable child pipelines, it will appear as if two finalize methods</span>
    <span class="c"># have been called instead of just one. The saving grace here is that</span>
    <span class="c"># finalize must be idempotent, so this *should* be harmless.</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">cursor</span><span class="o">=</span><span class="n">cursor</span><span class="p">)</span>
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s">&#39;root_pipeline =&#39;</span><span class="p">,</span> <span class="n">root_pipeline_key</span><span class="p">))</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">max_to_notify</span><span class="p">)</span>

    <span class="n">task_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pipeline_record</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
          <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">RUN</span><span class="p">,</span> <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">WAITING</span><span class="p">):</span>
        <span class="k">continue</span>

      <span class="n">pipeline_key</span> <span class="o">=</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">key</span><span class="p">()</span>
      <span class="n">task_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">taskqueue</span><span class="o">.</span><span class="n">Task</span><span class="p">(</span>
          <span class="n">name</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">-abort&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_name</span><span class="p">,</span> <span class="n">pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">()),</span>
          <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">abort_handler_path</span><span class="p">,</span>
          <span class="n">params</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">pipeline_key</span><span class="o">=</span><span class="n">pipeline_key</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="n">_BarrierRecord</span><span class="o">.</span><span class="n">ABORT</span><span class="p">),</span>
          <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;X-Ae-Pipeline-Key&#39;</span><span class="p">:</span> <span class="n">pipeline_key</span><span class="p">}))</span>

    <span class="c"># Task continuation with sequence number to prevent fork-bombs.</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="n">max_to_notify</span><span class="p">:</span>
      <span class="n">the_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;(.*)-([0-9]+)&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_name</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">the_match</span><span class="p">:</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">the_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">the_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_name</span>
        <span class="n">end</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">task_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">taskqueue</span><span class="o">.</span><span class="n">Task</span><span class="p">(</span>
          <span class="n">name</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">-</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">end</span><span class="p">),</span>
          <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fanout_abort_handler_path</span><span class="p">,</span>
          <span class="n">params</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">root_pipeline_key</span><span class="o">=</span><span class="n">root_pipeline_key</span><span class="p">,</span>
                      <span class="n">cursor</span><span class="o">=</span><span class="n">query</span><span class="o">.</span><span class="n">cursor</span><span class="p">())))</span>

    <span class="k">if</span> <span class="n">task_list</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">taskqueue</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queue_name</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">task_list</span><span class="p">)</span>
      <span class="k">except</span> <span class="p">(</span><span class="n">taskqueue</span><span class="o">.</span><span class="n">TombstonedTaskError</span><span class="p">,</span> <span class="n">taskqueue</span><span class="o">.</span><span class="n">TaskAlreadyExistsError</span><span class="p">):</span>
        <span class="k">pass</span>

  <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">,</span> <span class="n">return_task</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">countdown</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Starts a pipeline.</span>

<span class="sd">    Args:</span>
<span class="sd">      pipeline: Pipeline instance to run.</span>
<span class="sd">      return_task: When True, do not submit the task to start the pipeline</span>
<span class="sd">        but instead return it for someone else to enqueue.</span>
<span class="sd">      countdown: Time in seconds into the future that this Task should execute.</span>
<span class="sd">        Defaults to zero.</span>
<span class="sd">      eta: A datetime.datetime specifying the absolute time at which the task</span>
<span class="sd">        should be executed. Must not be specified if &#39;countdown&#39; is specified.</span>
<span class="sd">        This may be timezone-aware or timezone-naive. If None, defaults to now.</span>
<span class="sd">        For pull tasks, no worker will be able to lease this task before the</span>
<span class="sd">        time indicated by eta.</span>

<span class="sd">    Returns:</span>
<span class="sd">      The task to start this pipeline if return_task was True.</span>

<span class="sd">    Raises:</span>
<span class="sd">      PipelineExistsError if the pipeline with the given ID already exists.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Adjust all pipeline output keys for this Pipeline to be children of</span>
    <span class="c"># the _PipelineRecord, that way we can write them all and submit in a</span>
    <span class="c"># single transaction.</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">_output_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
      <span class="n">slot</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Key</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span>
          <span class="o">*</span><span class="n">slot</span><span class="o">.</span><span class="n">key</span><span class="o">.</span><span class="n">to_path</span><span class="p">(),</span> <span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">pipeline</span><span class="o">.</span><span class="n">_pipeline_key</span><span class="p">))</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">output_slots</span><span class="p">,</span> <span class="n">params_text</span><span class="p">,</span> <span class="n">params_blob</span> <span class="o">=</span> <span class="n">_generate_args</span><span class="p">(</span>
        <span class="n">pipeline</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">outputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_path</span><span class="p">)</span>

    <span class="nd">@db.transactional</span><span class="p">(</span><span class="n">propagation</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">INDEPENDENT</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">txn</span><span class="p">():</span>
      <span class="n">pipeline_record</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">_pipeline_key</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">pipeline_record</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">PipelineExistsError</span><span class="p">(</span>
            <span class="s">&#39;Pipeline with idempotence key &quot;</span><span class="si">%s</span><span class="s">&quot; already exists; params=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">_pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span>
             <span class="n">_short_repr</span><span class="p">(</span><span class="n">pipeline_record</span><span class="o">.</span><span class="n">params</span><span class="p">)))</span>

      <span class="n">entities_to_put</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">_output_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="n">entities_to_put</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_SlotRecord</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="n">slot</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
            <span class="n">root_pipeline</span><span class="o">=</span><span class="n">pipeline</span><span class="o">.</span><span class="n">_pipeline_key</span><span class="p">))</span>

      <span class="n">entities_to_put</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_PipelineRecord</span><span class="p">(</span>
          <span class="n">key</span><span class="o">=</span><span class="n">pipeline</span><span class="o">.</span><span class="n">_pipeline_key</span><span class="p">,</span>
          <span class="n">root_pipeline</span><span class="o">=</span><span class="n">pipeline</span><span class="o">.</span><span class="n">_pipeline_key</span><span class="p">,</span>
          <span class="n">is_root_pipeline</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
          <span class="c"># Bug in DB means we need to use the storage name here,</span>
          <span class="c"># not the local property name.</span>
          <span class="n">params</span><span class="o">=</span><span class="n">params_text</span><span class="p">,</span>
          <span class="n">params_blob</span><span class="o">=</span><span class="n">params_blob</span><span class="p">,</span>
          <span class="n">start_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_gettime</span><span class="p">(),</span>
          <span class="n">class_path</span><span class="o">=</span><span class="n">pipeline</span><span class="o">.</span><span class="n">_class_path</span><span class="p">,</span>
          <span class="n">max_attempts</span><span class="o">=</span><span class="n">pipeline</span><span class="o">.</span><span class="n">max_attempts</span><span class="p">))</span>

      <span class="n">entities_to_put</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_PipelineContext</span><span class="o">.</span><span class="n">_create_barrier_entities</span><span class="p">(</span>
          <span class="n">pipeline</span><span class="o">.</span><span class="n">_pipeline_key</span><span class="p">,</span>
          <span class="n">pipeline</span><span class="o">.</span><span class="n">_pipeline_key</span><span class="p">,</span>
          <span class="n">_BarrierRecord</span><span class="o">.</span><span class="n">FINALIZE</span><span class="p">,</span>
          <span class="n">output_slots</span><span class="p">))</span>

      <span class="n">db</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">entities_to_put</span><span class="p">)</span>

      <span class="n">task</span> <span class="o">=</span> <span class="n">taskqueue</span><span class="o">.</span><span class="n">Task</span><span class="p">(</span>
          <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pipeline_handler_path</span><span class="p">,</span>
          <span class="n">params</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">pipeline_key</span><span class="o">=</span><span class="n">pipeline</span><span class="o">.</span><span class="n">_pipeline_key</span><span class="p">),</span>
          <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;X-Ae-Pipeline-Key&#39;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_pipeline_key</span><span class="p">},</span>
          <span class="n">target</span><span class="o">=</span><span class="n">pipeline</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
          <span class="n">countdown</span><span class="o">=</span><span class="n">countdown</span><span class="p">,</span>
          <span class="n">eta</span><span class="o">=</span><span class="n">eta</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">return_task</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">task</span>
      <span class="n">task</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">queue_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">queue_name</span><span class="p">,</span> <span class="n">transactional</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">task</span> <span class="o">=</span> <span class="n">txn</span><span class="p">()</span>
    <span class="c"># Immediately mark the output slots as existing so they can be filled</span>
    <span class="c"># by asynchronous pipelines or used in test mode.</span>
    <span class="k">for</span> <span class="n">output_slot</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">_output_dict</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
      <span class="n">output_slot</span><span class="o">.</span><span class="n">_exists</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="n">task</span>

  <span class="k">def</span> <span class="nf">start_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Starts a pipeline in the test mode.</span>

<span class="sd">    Args:</span>
<span class="sd">      pipeline: The Pipeline instance to test.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_TEST_MODE</span><span class="p">,</span> <span class="n">_TEST_ROOT_PIPELINE_KEY</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">return_task</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">_TEST_MODE</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">_TEST_ROOT_PIPELINE_KEY</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_pipeline_key</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_test</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
      <span class="n">_TEST_MODE</span> <span class="o">=</span> <span class="bp">False</span>

  <span class="k">def</span> <span class="nf">evaluate_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Recursively evaluates the given pipeline in test mode.</span>

<span class="sd">    Args:</span>
<span class="sd">      stage: The Pipeline instance to run at this stage in the flow.</span>
<span class="sd">      root: True if the supplied stage is the root of the pipeline.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">args_adjusted</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">stage</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">PipelineFuture</span><span class="p">):</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">default</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Slot</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">value</span>
        <span class="n">arg</span><span class="o">.</span><span class="n">_touched</span> <span class="o">=</span> <span class="bp">True</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">arg</span>
      <span class="n">args_adjusted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="n">kwargs_adjusted</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">stage</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">PipelineFuture</span><span class="p">):</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">default</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Slot</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">value</span>
        <span class="n">arg</span><span class="o">.</span><span class="n">_touched</span> <span class="o">=</span> <span class="bp">True</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">arg</span>
      <span class="n">kwargs_adjusted</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="n">stage</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">stage</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">args_adjusted</span><span class="p">,</span> <span class="n">kwargs_adjusted</span>
    <span class="n">pipeline_generator</span> <span class="o">=</span> <span class="n">mr_util</span><span class="o">.</span><span class="n">is_generator_function</span><span class="p">(</span><span class="n">stage</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Running </span><span class="si">%s</span><span class="s">(*</span><span class="si">%s</span><span class="s">, **</span><span class="si">%s</span><span class="s">)&#39;</span><span class="p">,</span> <span class="n">stage</span><span class="o">.</span><span class="n">_class_path</span><span class="p">,</span>
                  <span class="n">_short_repr</span><span class="p">(</span><span class="n">stage</span><span class="o">.</span><span class="n">args</span><span class="p">),</span> <span class="n">_short_repr</span><span class="p">(</span><span class="n">stage</span><span class="o">.</span><span class="n">kwargs</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">stage</span><span class="o">.</span><span class="n">async</span><span class="p">:</span>
      <span class="n">stage</span><span class="o">.</span><span class="n">run_test</span><span class="p">(</span><span class="o">*</span><span class="n">stage</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">stage</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">pipeline_generator</span><span class="p">:</span>
      <span class="n">all_output_slots</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">pipeline_iter</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">run_test</span><span class="p">(</span><span class="o">*</span><span class="n">stage</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">stage</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
        <span class="n">pipeline_iter</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">*</span><span class="n">stage</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">stage</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>

      <span class="n">all_substages</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
      <span class="n">next_value</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="n">last_sub_stage</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="n">yielded</span> <span class="o">=</span> <span class="n">pipeline_iter</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">next_value</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
          <span class="k">break</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">yielded</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">):</span>
          <span class="k">if</span> <span class="n">yielded</span> <span class="ow">in</span> <span class="n">all_substages</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UnexpectedPipelineError</span><span class="p">(</span>
                <span class="s">&#39;Already yielded pipeline object </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">yielded</span><span class="p">)</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">all_substages</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">yielded</span><span class="p">)</span>

          <span class="n">last_sub_stage</span> <span class="o">=</span> <span class="n">yielded</span>
          <span class="n">next_value</span> <span class="o">=</span> <span class="n">yielded</span><span class="o">.</span><span class="n">outputs</span>
          <span class="n">all_output_slots</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">next_value</span><span class="o">.</span><span class="n">_output_dict</span><span class="o">.</span><span class="n">itervalues</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="k">raise</span> <span class="n">UnexpectedPipelineError</span><span class="p">(</span>
              <span class="s">&#39;Yielded a disallowed value: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">yielded</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">last_sub_stage</span><span class="p">:</span>
        <span class="c"># Generator&#39;s outputs inherited from last running sub-stage.</span>
        <span class="c"># If the generator changes its mind and doesn&#39;t yield anything, this</span>
        <span class="c"># may not happen at all. Missing outputs will be caught when they</span>
        <span class="c"># are passed to the stage as inputs, or verified from the outside by</span>
        <span class="c"># the test runner.</span>
        <span class="k">for</span> <span class="n">slot_name</span><span class="p">,</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">last_sub_stage</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">_output_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
          <span class="n">stage</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">_output_dict</span><span class="p">[</span><span class="n">slot_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">slot</span>
          <span class="c"># Any inherited slots won&#39;t be checked for declaration.</span>
          <span class="n">all_output_slots</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">slot</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="c"># Generator yielded no children, so treat it as a sync function.</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">_set_value_test</span><span class="p">(</span><span class="n">stage</span><span class="o">.</span><span class="n">_pipeline_key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

      <span class="c"># Enforce the policy of requiring all undeclared output slots from</span>
      <span class="c"># child pipelines to be consumed by their parent generator.</span>
      <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">all_output_slots</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">slot</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;default&#39;</span><span class="p">:</span>
          <span class="k">continue</span>
        <span class="k">if</span> <span class="n">slot</span><span class="o">.</span><span class="n">filled</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">slot</span><span class="o">.</span><span class="n">_strict</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">slot</span><span class="o">.</span><span class="n">_touched</span><span class="p">:</span>
          <span class="k">raise</span> <span class="n">SlotNotDeclaredError</span><span class="p">(</span>
              <span class="s">&#39;Undeclared output &quot;</span><span class="si">%s</span><span class="s">&quot;; all dynamic outputs from child &#39;</span>
              <span class="s">&#39;pipelines must be consumed.&#39;</span> <span class="o">%</span> <span class="n">slot</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">run_test</span><span class="p">(</span><span class="o">*</span><span class="n">stage</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">stage</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">*</span><span class="n">stage</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">stage</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
      <span class="n">stage</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">_set_value_test</span><span class="p">(</span><span class="n">stage</span><span class="o">.</span><span class="n">_pipeline_key</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

    <span class="c"># Enforce strict output usage at the top level.</span>
    <span class="k">if</span> <span class="n">root</span><span class="p">:</span>
      <span class="n">found_outputs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
      <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">stage</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">_output_dict</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">slot</span><span class="o">.</span><span class="n">filled</span><span class="p">:</span>
          <span class="n">found_outputs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">slot</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">slot</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;default&#39;</span><span class="p">:</span>
          <span class="k">continue</span>
        <span class="k">if</span> <span class="n">slot</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stage</span><span class="o">.</span><span class="n">output_names</span><span class="p">:</span>
          <span class="k">raise</span> <span class="n">SlotNotDeclaredError</span><span class="p">(</span>
              <span class="s">&#39;Undeclared output from root pipeline &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">slot</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

      <span class="n">missing_outputs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">stage</span><span class="o">.</span><span class="n">output_names</span><span class="p">)</span> <span class="o">-</span> <span class="n">found_outputs</span>
      <span class="k">if</span> <span class="n">missing_outputs</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SlotNotFilledError</span><span class="p">(</span>
            <span class="s">&#39;Outputs </span><span class="si">%r</span><span class="s"> were never filled.&#39;</span> <span class="o">%</span> <span class="n">missing_outputs</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Finalizing </span><span class="si">%s</span><span class="s">(*</span><span class="si">%s</span><span class="s">, **</span><span class="si">%s</span><span class="s">)&#39;</span><span class="p">,</span> <span class="n">stage</span><span class="o">.</span><span class="n">_class_path</span><span class="p">,</span>
                  <span class="n">_short_repr</span><span class="p">(</span><span class="n">stage</span><span class="o">.</span><span class="n">args</span><span class="p">),</span> <span class="n">_short_repr</span><span class="p">(</span><span class="n">stage</span><span class="o">.</span><span class="n">kwargs</span><span class="p">))</span>
    <span class="n">ran</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">stage</span><span class="o">.</span><span class="n">finalized_test</span><span class="p">()</span>
      <span class="n">ran</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
      <span class="k">pass</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ran</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">finalized</span><span class="p">()</span>
      <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
        <span class="k">pass</span>

  <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline_key</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">attempt</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Evaluates the given Pipeline and enqueues sub-stages for execution.</span>

<span class="sd">    Args:</span>
<span class="sd">      pipeline_key: The db.Key or stringified key of the _PipelineRecord to run.</span>
<span class="sd">      purpose: Why evaluate was called (&#39;start&#39;, &#39;finalize&#39;, or &#39;abort&#39;).</span>
<span class="sd">      attempt: The attempt number that should be tried.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">After</span><span class="o">.</span><span class="n">_thread_init</span><span class="p">()</span>
    <span class="n">InOrder</span><span class="o">.</span><span class="n">_thread_init</span><span class="p">()</span>
    <span class="n">InOrder</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">_activated</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pipeline_key</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Key</span><span class="p">):</span>
      <span class="n">pipeline_key</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Key</span><span class="p">(</span><span class="n">pipeline_key</span><span class="p">)</span>
    <span class="n">pipeline_record</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pipeline_key</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pipeline_record</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Pipeline ID &quot;</span><span class="si">%s</span><span class="s">&quot; does not exist.&#39;</span><span class="p">,</span> <span class="n">pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
      <span class="k">return</span>
    <span class="k">if</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">WAITING</span><span class="p">,</span> <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">RUN</span><span class="p">):</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Pipeline ID &quot;</span><span class="si">%s</span><span class="s">&quot; in bad state for purpose &quot;</span><span class="si">%s</span><span class="s">&quot;: &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span><span class="p">,</span>
                    <span class="n">pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">purpose</span> <span class="ow">or</span> <span class="n">_BarrierRecord</span><span class="o">.</span><span class="n">START</span><span class="p">,</span>
                    <span class="n">pipeline_record</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
      <span class="k">return</span>

    <span class="n">params</span> <span class="o">=</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">params</span>
    <span class="n">root_pipeline_key</span> <span class="o">=</span> \
        <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">root_pipeline</span><span class="o">.</span><span class="n">get_value_for_datastore</span><span class="p">(</span><span class="n">pipeline_record</span><span class="p">)</span>
    <span class="n">default_slot_key</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Key</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;output_slots&#39;</span><span class="p">][</span><span class="s">&#39;default&#39;</span><span class="p">])</span>

    <span class="n">default_slot_record</span><span class="p">,</span> <span class="n">root_pipeline_record</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">([</span>
        <span class="n">default_slot_key</span><span class="p">,</span> <span class="n">root_pipeline_key</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">default_slot_record</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Pipeline ID &quot;</span><span class="si">%s</span><span class="s">&quot; default slot &quot;</span><span class="si">%s</span><span class="s">&quot; does not exist.&#39;</span><span class="p">,</span>
                    <span class="n">pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">default_slot_key</span><span class="p">)</span>
      <span class="k">return</span>
    <span class="k">if</span> <span class="n">root_pipeline_record</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Pipeline ID &quot;</span><span class="si">%s</span><span class="s">&quot; root pipeline ID &quot;</span><span class="si">%s</span><span class="s">&quot; is missing.&#39;</span><span class="p">,</span>
                    <span class="n">pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">root_pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
      <span class="k">return</span>

    <span class="c"># Always finalize if we&#39;re aborting so pipelines have a chance to cleanup</span>
    <span class="c"># before they terminate. Pipelines must access &#39;was_aborted&#39; to find</span>
    <span class="c"># out how their finalization should work.</span>
    <span class="n">abort_signal</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">purpose</span> <span class="o">==</span> <span class="n">_BarrierRecord</span><span class="o">.</span><span class="n">ABORT</span> <span class="ow">or</span>
        <span class="n">root_pipeline_record</span><span class="o">.</span><span class="n">abort_requested</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">finalize_signal</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">default_slot_record</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">_SlotRecord</span><span class="o">.</span><span class="n">FILLED</span> <span class="ow">and</span>
         <span class="n">purpose</span> <span class="o">==</span> <span class="n">_BarrierRecord</span><span class="o">.</span><span class="n">FINALIZE</span><span class="p">)</span> <span class="ow">or</span> <span class="n">abort_signal</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="n">pipeline_func_class</span> <span class="o">=</span> <span class="n">mr_util</span><span class="o">.</span><span class="n">for_name</span><span class="p">(</span><span class="n">pipeline_record</span><span class="o">.</span><span class="n">class_path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
      <span class="c"># This means something is wrong with the deployed code. Rely on the</span>
      <span class="c"># taskqueue system to do retries.</span>
      <span class="n">retry_message</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
          <span class="s">&#39;Could not locate </span><span class="si">%s</span><span class="s">#</span><span class="si">%s</span><span class="s">. </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
          <span class="n">pipeline_record</span><span class="o">.</span><span class="n">class_path</span><span class="p">,</span> <span class="n">pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">retry_message</span><span class="p">)</span>
      <span class="k">raise</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="n">pipeline_func</span> <span class="o">=</span> <span class="n">pipeline_func_class</span><span class="o">.</span><span class="n">from_id</span><span class="p">(</span>
          <span class="n">pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span>
          <span class="n">resolve_outputs</span><span class="o">=</span><span class="n">finalize_signal</span><span class="p">,</span>
          <span class="n">_pipeline_record</span><span class="o">=</span><span class="n">pipeline_record</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">SlotNotFilledError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
          <span class="s">&#39;Could not resolve arguments for </span><span class="si">%s</span><span class="s">#</span><span class="si">%s</span><span class="s">. Most likely this means there &#39;</span>
          <span class="s">&#39;is a bug in the Pipeline runtime or some intermediate data has been &#39;</span>
          <span class="s">&#39;deleted from the Datastore. Giving up.&#39;</span><span class="p">,</span>
          <span class="n">pipeline_record</span><span class="o">.</span><span class="n">class_path</span><span class="p">,</span> <span class="n">pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">transition_aborted</span><span class="p">(</span><span class="n">pipeline_key</span><span class="p">)</span>
      <span class="k">return</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
      <span class="n">retry_message</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
          <span class="s">&#39;Instantiating </span><span class="si">%s</span><span class="s">#</span><span class="si">%s</span><span class="s"> raised exception. </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
          <span class="n">pipeline_record</span><span class="o">.</span><span class="n">class_path</span><span class="p">,</span> <span class="n">pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">retry_message</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">transition_retry</span><span class="p">(</span><span class="n">pipeline_key</span><span class="p">,</span> <span class="n">retry_message</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;task_retry&#39;</span><span class="p">]:</span>
        <span class="k">raise</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">pipeline_generator</span> <span class="o">=</span> <span class="n">mr_util</span><span class="o">.</span><span class="n">is_generator_function</span><span class="p">(</span>
          <span class="n">pipeline_func_class</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
      <span class="n">caller_output</span> <span class="o">=</span> <span class="n">pipeline_func</span><span class="o">.</span><span class="n">outputs</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">abort_signal</span> <span class="ow">and</span> <span class="n">pipeline_func</span><span class="o">.</span><span class="n">async</span> <span class="ow">and</span>
        <span class="n">pipeline_record</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">RUN</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="n">pipeline_func</span><span class="o">.</span><span class="n">try_cancel</span><span class="p">()):</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
          <span class="s">&#39;Could not cancel and abort mid-flight async pipeline: </span><span class="si">%r</span><span class="s">#</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
          <span class="n">pipeline_func</span><span class="p">,</span> <span class="n">pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
      <span class="k">return</span>

    <span class="k">if</span> <span class="n">finalize_signal</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">pipeline_func</span><span class="o">.</span><span class="n">_finalized_internal</span><span class="p">(</span>
              <span class="bp">self</span><span class="p">,</span> <span class="n">pipeline_key</span><span class="p">,</span> <span class="n">root_pipeline_key</span><span class="p">,</span>
              <span class="n">caller_output</span><span class="p">,</span> <span class="n">abort_signal</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="c"># This means something is wrong with the deployed finalization code.</span>
        <span class="c"># Rely on the taskqueue system to do retries.</span>
        <span class="n">retry_message</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s">&#39;Finalizing </span><span class="si">%r</span><span class="s">#</span><span class="si">%s</span><span class="s"> raised exception. </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
                          <span class="n">pipeline_func</span><span class="p">,</span> <span class="n">pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">retry_message</span><span class="p">)</span>
        <span class="k">raise</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">abort_signal</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">transition_complete</span><span class="p">(</span><span class="n">pipeline_key</span><span class="p">)</span>
          <span class="k">return</span>

    <span class="k">if</span> <span class="n">abort_signal</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Marking as aborted </span><span class="si">%s</span><span class="s">#</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">pipeline_func</span><span class="p">,</span>
                    <span class="n">pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">transition_aborted</span><span class="p">(</span><span class="n">pipeline_key</span><span class="p">)</span>
      <span class="k">return</span>

    <span class="k">if</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">current_attempt</span> <span class="o">!=</span> <span class="n">attempt</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
          <span class="s">&#39;Received evaluation task for pipeline ID &quot;</span><span class="si">%s</span><span class="s">&quot; attempt </span><span class="si">%d</span><span class="s"> but &#39;</span>
          <span class="s">&#39;current pending attempt is </span><span class="si">%d</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">attempt</span><span class="p">,</span>
          <span class="n">pipeline_record</span><span class="o">.</span><span class="n">current_attempt</span><span class="p">)</span>
      <span class="k">return</span>

    <span class="k">if</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">current_attempt</span> <span class="o">&gt;=</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">max_attempts</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
          <span class="s">&#39;Received evaluation task for pipeline ID &quot;</span><span class="si">%s</span><span class="s">&quot; on attempt </span><span class="si">%d</span><span class="s"> &#39;</span>
          <span class="s">&#39;but that exceeds max attempts </span><span class="si">%d</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">attempt</span><span class="p">,</span>
          <span class="n">pipeline_record</span><span class="o">.</span><span class="n">max_attempts</span><span class="p">)</span>
      <span class="k">return</span>

    <span class="k">if</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">next_retry_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">retry_time</span> <span class="o">=</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">next_retry_time</span> <span class="o">-</span> <span class="n">_RETRY_WIGGLE_TIMEDELTA</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gettime</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">retry_time</span><span class="p">:</span>
        <span class="n">detail_message</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s">&#39;Received evaluation task for pipeline ID &quot;</span><span class="si">%s</span><span class="s">&quot; on attempt </span><span class="si">%d</span><span class="s">, &#39;</span>
            <span class="s">&#39;which will not be ready until: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span>
            <span class="n">pipeline_record</span><span class="o">.</span><span class="n">current_attempt</span><span class="p">,</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">next_retry_time</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">detail_message</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">UnexpectedPipelineError</span><span class="p">(</span><span class="n">detail_message</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">RUN</span> <span class="ow">and</span> <span class="n">pipeline_generator</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">default_slot_record</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">_SlotRecord</span><span class="o">.</span><span class="n">WAITING</span> <span class="ow">and</span>
          <span class="ow">not</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">fanned_out</span><span class="p">):</span>
        <span class="c"># This properly handles the yield-less generator case when the</span>
        <span class="c"># RUN state transition worked properly but outputting to the default</span>
        <span class="c"># slot failed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_slot</span><span class="p">(</span><span class="n">pipeline_key</span><span class="p">,</span> <span class="n">caller_output</span><span class="o">.</span><span class="n">default</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
      <span class="k">return</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pipeline_record</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">WAITING</span> <span class="ow">and</span>
        <span class="n">pipeline_func</span><span class="o">.</span><span class="n">async</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">transition_run</span><span class="p">(</span><span class="n">pipeline_key</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">pipeline_func</span><span class="o">.</span><span class="n">_run_internal</span><span class="p">(</span>
          <span class="bp">self</span><span class="p">,</span> <span class="n">pipeline_key</span><span class="p">,</span> <span class="n">root_pipeline_key</span><span class="p">,</span> <span class="n">caller_output</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_run_exception</span><span class="p">(</span><span class="n">pipeline_key</span><span class="p">,</span> <span class="n">pipeline_func</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
        <span class="k">raise</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">pipeline_func</span><span class="o">.</span><span class="n">async</span><span class="p">:</span>
      <span class="k">return</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">pipeline_generator</span><span class="p">:</span>
      <span class="c"># Catch any exceptions that are thrown when the pipeline&#39;s return</span>
      <span class="c"># value is being serialized. This ensures that serialization errors</span>
      <span class="c"># will cause normal abort/retry behavior.</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_slot</span><span class="p">(</span><span class="n">pipeline_key</span><span class="p">,</span> <span class="n">caller_output</span><span class="o">.</span><span class="n">default</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">retry_message</span> <span class="o">=</span> <span class="s">&#39;Bad return value. </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">e</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
            <span class="s">&#39;Generator </span><span class="si">%r</span><span class="s">#</span><span class="si">%s</span><span class="s"> caused exception while serializing return &#39;</span>
            <span class="s">&#39;value </span><span class="si">%r</span><span class="s">. </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">pipeline_func</span><span class="p">,</span> <span class="n">pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">result</span><span class="p">,</span>
            <span class="n">retry_message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transition_retry</span><span class="p">(</span><span class="n">pipeline_key</span><span class="p">,</span> <span class="n">retry_message</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pipeline_func</span><span class="o">.</span><span class="n">task_retry</span><span class="p">:</span>
          <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="k">return</span>

      <span class="n">expected_outputs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">caller_output</span><span class="o">.</span><span class="n">_output_dict</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">())</span>
      <span class="n">found_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_filled_output_names</span>
      <span class="k">if</span> <span class="n">expected_outputs</span> <span class="o">!=</span> <span class="n">found_outputs</span><span class="p">:</span>
        <span class="n">exception</span> <span class="o">=</span> <span class="n">SlotNotFilledError</span><span class="p">(</span>
            <span class="s">&#39;Outputs </span><span class="si">%r</span><span class="s"> for pipeline ID &quot;</span><span class="si">%s</span><span class="s">&quot; were never filled by &quot;</span><span class="si">%s</span><span class="s">&quot;.&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">expected_outputs</span> <span class="o">-</span> <span class="n">found_outputs</span><span class="p">,</span>
            <span class="n">pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">pipeline_func</span><span class="o">.</span><span class="n">_class_path</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_run_exception</span><span class="p">(</span><span class="n">pipeline_key</span><span class="p">,</span> <span class="n">pipeline_func</span><span class="p">,</span> <span class="n">exception</span><span class="p">):</span>
          <span class="k">raise</span> <span class="n">exception</span>
      <span class="k">return</span>

    <span class="n">pipeline_iter</span> <span class="o">=</span> <span class="n">result</span>
    <span class="n">next_value</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">last_sub_stage</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">sub_stage</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">sub_stage_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">sub_stage_ordering</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">yielded</span> <span class="o">=</span> <span class="n">pipeline_iter</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">next_value</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="k">break</span>
      <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_run_exception</span><span class="p">(</span><span class="n">pipeline_key</span><span class="p">,</span> <span class="n">pipeline_func</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
          <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="k">return</span>

      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">yielded</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">yielded</span> <span class="ow">in</span> <span class="n">sub_stage_dict</span><span class="p">:</span>
          <span class="k">raise</span> <span class="n">UnexpectedPipelineError</span><span class="p">(</span>
              <span class="s">&#39;Already yielded pipeline object </span><span class="si">%r</span><span class="s"> with pipeline ID </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
              <span class="p">(</span><span class="n">yielded</span><span class="p">,</span> <span class="n">yielded</span><span class="o">.</span><span class="n">pipeline_id</span><span class="p">))</span>

        <span class="n">last_sub_stage</span> <span class="o">=</span> <span class="n">yielded</span>
        <span class="n">next_value</span> <span class="o">=</span> <span class="n">PipelineFuture</span><span class="p">(</span><span class="n">yielded</span><span class="o">.</span><span class="n">output_names</span><span class="p">)</span>
        <span class="n">next_value</span><span class="o">.</span><span class="n">_after_all_pipelines</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">After</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">_after_all_futures</span><span class="p">)</span>
        <span class="n">next_value</span><span class="o">.</span><span class="n">_after_all_pipelines</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">InOrder</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">_in_order_futures</span><span class="p">)</span>
        <span class="n">sub_stage_dict</span><span class="p">[</span><span class="n">yielded</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_value</span>
        <span class="n">sub_stage_ordering</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yielded</span><span class="p">)</span>
        <span class="n">InOrder</span><span class="o">.</span><span class="n">_add_future</span><span class="p">(</span><span class="n">next_value</span><span class="p">)</span>

        <span class="c"># To aid local testing, the task_retry flag (which instructs the</span>
        <span class="c"># evaluator to raise all exceptions back up to the task queue) is</span>
        <span class="c"># inherited by all children from the root down.</span>
        <span class="n">yielded</span><span class="o">.</span><span class="n">task_retry</span> <span class="o">=</span> <span class="n">pipeline_func</span><span class="o">.</span><span class="n">task_retry</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UnexpectedPipelineError</span><span class="p">(</span>
            <span class="s">&#39;Yielded a disallowed value: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">yielded</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">last_sub_stage</span><span class="p">:</span>
      <span class="c"># Final yielded stage inherits outputs from calling pipeline that were not</span>
      <span class="c"># already filled during the generator&#39;s execution.</span>
      <span class="n">inherited_outputs</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;output_slots&#39;</span><span class="p">]</span>
      <span class="k">for</span> <span class="n">slot_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_filled_output_names</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">inherited_outputs</span><span class="p">[</span><span class="n">slot_name</span><span class="p">]</span>
      <span class="n">sub_stage_dict</span><span class="p">[</span><span class="n">last_sub_stage</span><span class="p">]</span><span class="o">.</span><span class="n">_inherit_outputs</span><span class="p">(</span>
          <span class="n">pipeline_record</span><span class="o">.</span><span class="n">class_path</span><span class="p">,</span> <span class="n">inherited_outputs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c"># Here the generator has yielded nothing, and thus acts as a synchronous</span>
      <span class="c"># function. We can skip the rest of the generator steps completely and</span>
      <span class="c"># fill the default output slot to cause finalizing.</span>
      <span class="n">expected_outputs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">caller_output</span><span class="o">.</span><span class="n">_output_dict</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">())</span>
      <span class="n">expected_outputs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span>
      <span class="n">found_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_filled_output_names</span>
      <span class="k">if</span> <span class="n">expected_outputs</span> <span class="o">!=</span> <span class="n">found_outputs</span><span class="p">:</span>
        <span class="n">exception</span> <span class="o">=</span> <span class="n">SlotNotFilledError</span><span class="p">(</span>
            <span class="s">&#39;Outputs </span><span class="si">%r</span><span class="s"> for pipeline ID &quot;</span><span class="si">%s</span><span class="s">&quot; were never filled by &quot;</span><span class="si">%s</span><span class="s">&quot;.&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">expected_outputs</span> <span class="o">-</span> <span class="n">found_outputs</span><span class="p">,</span>
            <span class="n">pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">pipeline_func</span><span class="o">.</span><span class="n">_class_path</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_run_exception</span><span class="p">(</span><span class="n">pipeline_key</span><span class="p">,</span> <span class="n">pipeline_func</span><span class="p">,</span> <span class="n">exception</span><span class="p">):</span>
          <span class="k">raise</span> <span class="n">exception</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_slot</span><span class="p">(</span><span class="n">pipeline_key</span><span class="p">,</span> <span class="n">caller_output</span><span class="o">.</span><span class="n">default</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transition_run</span><span class="p">(</span><span class="n">pipeline_key</span><span class="p">)</span>
      <span class="k">return</span>

    <span class="c"># Allocate any SlotRecords that do not yet exist.</span>
    <span class="n">entities_to_put</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">sub_stage_dict</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
      <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">future</span><span class="o">.</span><span class="n">_output_dict</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">slot</span><span class="o">.</span><span class="n">_exists</span><span class="p">:</span>
          <span class="n">entities_to_put</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_SlotRecord</span><span class="p">(</span>
              <span class="n">key</span><span class="o">=</span><span class="n">slot</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">root_pipeline</span><span class="o">=</span><span class="n">root_pipeline_key</span><span class="p">))</span>

    <span class="c"># Allocate PipelineRecords and BarrierRecords for generator-run Pipelines.</span>
    <span class="n">pipelines_to_run</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">all_children_keys</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">all_output_slots</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">sub_stage</span> <span class="ow">in</span> <span class="n">sub_stage_ordering</span><span class="p">:</span>
      <span class="n">future</span> <span class="o">=</span> <span class="n">sub_stage_dict</span><span class="p">[</span><span class="n">sub_stage</span><span class="p">]</span>

      <span class="c"># Catch any exceptions that are thrown when the pipeline&#39;s parameters</span>
      <span class="c"># are being serialized. This ensures that serialization errors will</span>
      <span class="c"># cause normal retry/abort behavior.</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">dependent_slots</span><span class="p">,</span> <span class="n">output_slots</span><span class="p">,</span> <span class="n">params_text</span><span class="p">,</span> <span class="n">params_blob</span> <span class="o">=</span> \
            <span class="n">_generate_args</span><span class="p">(</span><span class="n">sub_stage</span><span class="p">,</span> <span class="n">future</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_path</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">retry_message</span> <span class="o">=</span> <span class="s">&#39;Bad child arguments. </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">e</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
            <span class="s">&#39;Generator </span><span class="si">%r</span><span class="s">#</span><span class="si">%s</span><span class="s"> caused exception while serializing args for &#39;</span>
            <span class="s">&#39;child pipeline </span><span class="si">%r</span><span class="s">. </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">pipeline_func</span><span class="p">,</span> <span class="n">pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span>
            <span class="n">sub_stage</span><span class="p">,</span> <span class="n">retry_message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transition_retry</span><span class="p">(</span><span class="n">pipeline_key</span><span class="p">,</span> <span class="n">retry_message</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pipeline_func</span><span class="o">.</span><span class="n">task_retry</span><span class="p">:</span>
          <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="k">return</span>

      <span class="n">child_pipeline_key</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Key</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span>
          <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">kind</span><span class="p">(),</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">)</span>
      <span class="n">all_output_slots</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">output_slots</span><span class="p">)</span>
      <span class="n">all_children_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child_pipeline_key</span><span class="p">)</span>

      <span class="n">child_pipeline</span> <span class="o">=</span> <span class="n">_PipelineRecord</span><span class="p">(</span>
          <span class="n">key</span><span class="o">=</span><span class="n">child_pipeline_key</span><span class="p">,</span>
          <span class="n">root_pipeline</span><span class="o">=</span><span class="n">root_pipeline_key</span><span class="p">,</span>
          <span class="c"># Bug in DB means we need to use the storage name here,</span>
          <span class="c"># not the local property name.</span>
          <span class="n">params</span><span class="o">=</span><span class="n">params_text</span><span class="p">,</span>
          <span class="n">params_blob</span><span class="o">=</span><span class="n">params_blob</span><span class="p">,</span>
          <span class="n">class_path</span><span class="o">=</span><span class="n">sub_stage</span><span class="o">.</span><span class="n">_class_path</span><span class="p">,</span>
          <span class="n">max_attempts</span><span class="o">=</span><span class="n">sub_stage</span><span class="o">.</span><span class="n">max_attempts</span><span class="p">)</span>
      <span class="n">entities_to_put</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child_pipeline</span><span class="p">)</span>

      <span class="k">if</span> <span class="ow">not</span> <span class="n">dependent_slots</span><span class="p">:</span>
        <span class="c"># This child pipeline will run immediately.</span>
        <span class="n">pipelines_to_run</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">child_pipeline_key</span><span class="p">)</span>
        <span class="n">child_pipeline</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gettime</span><span class="p">()</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">entities_to_put</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_PipelineContext</span><span class="o">.</span><span class="n">_create_barrier_entities</span><span class="p">(</span>
            <span class="n">root_pipeline_key</span><span class="p">,</span>
            <span class="n">child_pipeline_key</span><span class="p">,</span>
            <span class="n">_BarrierRecord</span><span class="o">.</span><span class="n">START</span><span class="p">,</span>
            <span class="n">dependent_slots</span><span class="p">))</span>

      <span class="n">entities_to_put</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_PipelineContext</span><span class="o">.</span><span class="n">_create_barrier_entities</span><span class="p">(</span>
          <span class="n">root_pipeline_key</span><span class="p">,</span>
          <span class="n">child_pipeline_key</span><span class="p">,</span>
          <span class="n">_BarrierRecord</span><span class="o">.</span><span class="n">FINALIZE</span><span class="p">,</span>
          <span class="n">output_slots</span><span class="p">))</span>

    <span class="c"># This generator pipeline&#39;s finalization barrier must include all of the</span>
    <span class="c"># outputs of any child pipelines that it runs. This ensures the finalized</span>
    <span class="c"># calls will not happen until all child pipelines have completed.</span>
    <span class="c">#</span>
    <span class="c"># The transition_run() call below will update the FINALIZE _BarrierRecord</span>
    <span class="c"># for this generator pipeline to include all of these child outputs in</span>
    <span class="c"># its list of blocking_slots. That update is done transactionally to</span>
    <span class="c"># make sure the _BarrierRecord only lists the slots that matter.</span>
    <span class="c">#</span>
    <span class="c"># However, the notify_barriers() method doesn&#39;t find _BarrierRecords</span>
    <span class="c"># through the blocking_slots field. It finds them through _BarrierIndexes</span>
    <span class="c"># entities. Thus, before we update the FINALIZE _BarrierRecord in</span>
    <span class="c"># transition_run(), we need to write _BarrierIndexes for all child outputs.</span>
    <span class="n">barrier_entities</span> <span class="o">=</span> <span class="n">_PipelineContext</span><span class="o">.</span><span class="n">_create_barrier_entities</span><span class="p">(</span>
        <span class="n">root_pipeline_key</span><span class="p">,</span>
        <span class="n">pipeline_key</span><span class="p">,</span>
        <span class="n">_BarrierRecord</span><span class="o">.</span><span class="n">FINALIZE</span><span class="p">,</span>
        <span class="n">all_output_slots</span><span class="p">)</span>
    <span class="c"># Ignore the first element which is the _BarrierRecord. That entity must</span>
    <span class="c"># have already been created and put in the datastore for the parent</span>
    <span class="c"># pipeline before this code generated child pipelines.</span>
    <span class="n">barrier_indexes</span> <span class="o">=</span> <span class="n">barrier_entities</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">entities_to_put</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">barrier_indexes</span><span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">entities_to_put</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">transition_run</span><span class="p">(</span><span class="n">pipeline_key</span><span class="p">,</span>
                        <span class="n">blocking_slot_keys</span><span class="o">=</span><span class="n">all_output_slots</span><span class="p">,</span>
                        <span class="n">fanned_out_pipelines</span><span class="o">=</span><span class="n">all_children_keys</span><span class="p">,</span>
                        <span class="n">pipelines_to_run</span><span class="o">=</span><span class="n">pipelines_to_run</span><span class="p">)</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">_create_barrier_entities</span><span class="p">(</span><span class="n">root_pipeline_key</span><span class="p">,</span>
                               <span class="n">child_pipeline_key</span><span class="p">,</span>
                               <span class="n">purpose</span><span class="p">,</span>
                               <span class="n">blocking_slot_keys</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates all of the entities required for a _BarrierRecord.</span>

<span class="sd">    Args:</span>
<span class="sd">      root_pipeline_key: The root pipeline this is part of.</span>
<span class="sd">      child_pipeline_key: The pipeline this barrier is for.</span>
<span class="sd">      purpose: _BarrierRecord.START or _BarrierRecord.FINALIZE.</span>
<span class="sd">      blocking_slot_keys: Set of db.Keys corresponding to _SlotRecords that</span>
<span class="sd">        this barrier should wait on before firing.</span>

<span class="sd">    Returns:</span>
<span class="sd">      List of entities, starting with the _BarrierRecord entity, followed by</span>
<span class="sd">      _BarrierIndexes used for firing when _SlotRecords are filled in the same</span>
<span class="sd">      order as the blocking_slot_keys list provided. All of these entities</span>
<span class="sd">      should be put in the Datastore to ensure the barrier fires properly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">blocking_slot_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">blocking_slot_keys</span><span class="p">)</span>

    <span class="n">barrier</span> <span class="o">=</span> <span class="n">_BarrierRecord</span><span class="p">(</span>
        <span class="n">parent</span><span class="o">=</span><span class="n">child_pipeline_key</span><span class="p">,</span>
        <span class="n">key_name</span><span class="o">=</span><span class="n">purpose</span><span class="p">,</span>
        <span class="n">target</span><span class="o">=</span><span class="n">child_pipeline_key</span><span class="p">,</span>
        <span class="n">root_pipeline</span><span class="o">=</span><span class="n">root_pipeline_key</span><span class="p">,</span>
        <span class="n">blocking_slots</span><span class="o">=</span><span class="n">blocking_slot_keys</span><span class="p">)</span>

    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">barrier</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">slot_key</span> <span class="ow">in</span> <span class="n">blocking_slot_keys</span><span class="p">:</span>
      <span class="n">barrier_index_path</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="n">barrier_index_path</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">slot_key</span><span class="o">.</span><span class="n">to_path</span><span class="p">())</span>
      <span class="n">barrier_index_path</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">child_pipeline_key</span><span class="o">.</span><span class="n">to_path</span><span class="p">())</span>
      <span class="n">barrier_index_path</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">_BarrierIndex</span><span class="o">.</span><span class="n">kind</span><span class="p">(),</span> <span class="n">purpose</span><span class="p">])</span>
      <span class="n">barrier_index_key</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Key</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="o">*</span><span class="n">barrier_index_path</span><span class="p">)</span>
      <span class="n">barrier_index</span> <span class="o">=</span> <span class="n">_BarrierIndex</span><span class="p">(</span>
          <span class="n">key</span><span class="o">=</span><span class="n">barrier_index_key</span><span class="p">,</span>
          <span class="n">root_pipeline</span><span class="o">=</span><span class="n">root_pipeline_key</span><span class="p">)</span>
      <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">barrier_index</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>

  <span class="k">def</span> <span class="nf">handle_run_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline_key</span><span class="p">,</span> <span class="n">pipeline_func</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Handles an exception raised by a Pipeline&#39;s user code.</span>

<span class="sd">    Args:</span>
<span class="sd">      pipeline_key: The pipeline that raised the error.</span>
<span class="sd">      pipeline_func: The class path name of the Pipeline that was running.</span>
<span class="sd">      e: The exception that was raised.</span>

<span class="sd">    Returns:</span>
<span class="sd">      True if the exception should be re-raised up through the calling stack</span>
<span class="sd">      by the caller of this method.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">Retry</span><span class="p">):</span>
      <span class="n">retry_message</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;User forced retry for pipeline ID &quot;</span><span class="si">%s</span><span class="s">&quot; of </span><span class="si">%r</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
                      <span class="n">pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">pipeline_func</span><span class="p">,</span> <span class="n">retry_message</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">transition_retry</span><span class="p">(</span><span class="n">pipeline_key</span><span class="p">,</span> <span class="n">retry_message</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">Abort</span><span class="p">):</span>
      <span class="n">abort_message</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;User forced abort for pipeline ID &quot;</span><span class="si">%s</span><span class="s">&quot; of </span><span class="si">%r</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
                      <span class="n">pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">pipeline_func</span><span class="p">,</span> <span class="n">abort_message</span><span class="p">)</span>
      <span class="n">pipeline_func</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="n">abort_message</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">retry_message</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s">&#39;Generator </span><span class="si">%r</span><span class="s">#</span><span class="si">%s</span><span class="s"> raised exception. </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
                        <span class="n">pipeline_func</span><span class="p">,</span> <span class="n">pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">retry_message</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">transition_retry</span><span class="p">(</span><span class="n">pipeline_key</span><span class="p">,</span> <span class="n">retry_message</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pipeline_func</span><span class="o">.</span><span class="n">task_retry</span>

  <span class="k">def</span> <span class="nf">transition_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                     <span class="n">pipeline_key</span><span class="p">,</span>
                     <span class="n">blocking_slot_keys</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">fanned_out_pipelines</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">pipelines_to_run</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Marks an asynchronous or generator pipeline as running.</span>

<span class="sd">    Does nothing if the pipeline is no longer in a runnable state.</span>

<span class="sd">    Args:</span>
<span class="sd">      pipeline_key: The db.Key of the _PipelineRecord to update.</span>
<span class="sd">      blocking_slot_keys: List of db.Key instances that this pipeline&#39;s</span>
<span class="sd">        finalization barrier should wait on in addition to the existing one.</span>
<span class="sd">        This is used to update the barrier to include all child outputs. When</span>
<span class="sd">        None, the barrier will not be updated.</span>
<span class="sd">      fanned_out_pipelines: List of db.Key instances of _PipelineRecords that</span>
<span class="sd">        were fanned out by this generator pipeline. This is distinct from the</span>
<span class="sd">        &#39;pipelines_to_run&#39; list because not all of the pipelines listed here</span>
<span class="sd">        will be immediately ready to execute. When None, then this generator</span>
<span class="sd">        yielded no children.</span>
<span class="sd">      pipelines_to_run: List of db.Key instances of _PipelineRecords that should</span>
<span class="sd">        be kicked off (fan-out) transactionally as part of this transition.</span>
<span class="sd">        When None, no child pipelines will run. All db.Keys in this list must</span>
<span class="sd">        also be present in the fanned_out_pipelines list.</span>

<span class="sd">    Raises:</span>
<span class="sd">      UnexpectedPipelineError if blocking_slot_keys was not empty and the</span>
<span class="sd">      _BarrierRecord has gone missing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">txn</span><span class="p">():</span>
      <span class="n">pipeline_record</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pipeline_key</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">pipeline_record</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Pipeline ID &quot;</span><span class="si">%s</span><span class="s">&quot; cannot be marked as run. &#39;</span>
                        <span class="s">&#39;Does not exist.&#39;</span><span class="p">,</span> <span class="n">pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
        <span class="k">raise</span> <span class="n">db</span><span class="o">.</span><span class="n">Rollback</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">WAITING</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Pipeline ID &quot;</span><span class="si">%s</span><span class="s">&quot; in bad state to be marked as run: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
                        <span class="n">pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">db</span><span class="o">.</span><span class="n">Rollback</span><span class="p">()</span>

      <span class="n">pipeline_record</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">RUN</span>

      <span class="k">if</span> <span class="n">fanned_out_pipelines</span><span class="p">:</span>
        <span class="c"># NOTE: We must model the pipeline relationship in a top-down manner,</span>
        <span class="c"># meaning each pipeline must point forward to the pipelines that it</span>
        <span class="c"># fanned out to. The reason is race conditions. If evaluate()</span>
        <span class="c"># dies early, it may create many unused _PipelineRecord and _SlotRecord</span>
        <span class="c"># instances that never progress. The only way we know which of these</span>
        <span class="c"># are valid is by traversing the graph from the root, where the</span>
        <span class="c"># fanned_out property refers to those pipelines that were run using a</span>
        <span class="c"># transactional task.</span>
        <span class="n">child_pipeline_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fanned_out_pipelines</span><span class="p">)</span>
        <span class="n">pipeline_record</span><span class="o">.</span><span class="n">fanned_out</span> <span class="o">=</span> <span class="n">child_pipeline_list</span>

        <span class="k">if</span> <span class="n">pipelines_to_run</span><span class="p">:</span>
          <span class="n">child_indexes</span> <span class="o">=</span> <span class="p">[</span>
              <span class="n">child_pipeline_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pipelines_to_run</span><span class="p">]</span>
          <span class="n">child_indexes</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
          <span class="n">task</span> <span class="o">=</span> <span class="n">taskqueue</span><span class="o">.</span><span class="n">Task</span><span class="p">(</span>
              <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fanout_handler_path</span><span class="p">,</span>
              <span class="n">params</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">parent_key</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">pipeline_key</span><span class="p">),</span>
                          <span class="n">child_indexes</span><span class="o">=</span><span class="n">child_indexes</span><span class="p">))</span>
          <span class="n">task</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">queue_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">queue_name</span><span class="p">,</span> <span class="n">transactional</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

      <span class="n">pipeline_record</span><span class="o">.</span><span class="n">put</span><span class="p">()</span>

      <span class="k">if</span> <span class="n">blocking_slot_keys</span><span class="p">:</span>
        <span class="c"># NOTE: Always update a generator pipeline&#39;s finalization barrier to</span>
        <span class="c"># include all of the outputs of any pipelines that it runs, to ensure</span>
        <span class="c"># that finalized calls will not happen until all child pipelines have</span>
        <span class="c"># completed. This must happen transactionally with the enqueue of</span>
        <span class="c"># the fan-out kickoff task above to ensure the child output slots and</span>
        <span class="c"># the barrier blocking slots are the same.</span>
        <span class="n">barrier_key</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Key</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span>
            <span class="n">_BarrierRecord</span><span class="o">.</span><span class="n">kind</span><span class="p">(),</span> <span class="n">_BarrierRecord</span><span class="o">.</span><span class="n">FINALIZE</span><span class="p">,</span>
            <span class="n">parent</span><span class="o">=</span><span class="n">pipeline_key</span><span class="p">)</span>
        <span class="n">finalize_barrier</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">barrier_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">finalize_barrier</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
          <span class="k">raise</span> <span class="n">UnexpectedPipelineError</span><span class="p">(</span>
              <span class="s">&#39;Pipeline ID &quot;</span><span class="si">%s</span><span class="s">&quot; cannot update finalize barrier. &#39;</span>
              <span class="s">&#39;Does not exist.&#39;</span> <span class="o">%</span> <span class="n">pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">finalize_barrier</span><span class="o">.</span><span class="n">blocking_slots</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
              <span class="n">blocking_slot_keys</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">finalize_barrier</span><span class="o">.</span><span class="n">blocking_slots</span><span class="p">)))</span>
          <span class="n">finalize_barrier</span><span class="o">.</span><span class="n">put</span><span class="p">()</span>

    <span class="n">db</span><span class="o">.</span><span class="n">run_in_transaction</span><span class="p">(</span><span class="n">txn</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">transition_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline_key</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Marks the given pipeline as complete.</span>

<span class="sd">    Does nothing if the pipeline is no longer in a state that can be completed.</span>

<span class="sd">    Args:</span>
<span class="sd">      pipeline_key: db.Key of the _PipelineRecord that has completed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">txn</span><span class="p">():</span>
      <span class="n">pipeline_record</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pipeline_key</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">pipeline_record</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s">&#39;Tried to mark pipeline ID &quot;</span><span class="si">%s</span><span class="s">&quot; as complete but it does not exist.&#39;</span><span class="p">,</span>
            <span class="n">pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
        <span class="k">raise</span> <span class="n">db</span><span class="o">.</span><span class="n">Rollback</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
          <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">WAITING</span><span class="p">,</span> <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">RUN</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s">&#39;Tried to mark pipeline ID &quot;</span><span class="si">%s</span><span class="s">&quot; as complete, found bad state: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
            <span class="n">pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">db</span><span class="o">.</span><span class="n">Rollback</span><span class="p">()</span>

      <span class="n">pipeline_record</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">DONE</span>
      <span class="n">pipeline_record</span><span class="o">.</span><span class="n">finalized_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gettime</span><span class="p">()</span>
      <span class="n">pipeline_record</span><span class="o">.</span><span class="n">put</span><span class="p">()</span>

    <span class="n">db</span><span class="o">.</span><span class="n">run_in_transaction</span><span class="p">(</span><span class="n">txn</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">transition_retry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline_key</span><span class="p">,</span> <span class="n">retry_message</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Marks the given pipeline as requiring another retry.</span>

<span class="sd">    Does nothing if all attempts have been exceeded.</span>

<span class="sd">    Args:</span>
<span class="sd">      pipeline_key: db.Key of the _PipelineRecord that needs to be retried.</span>
<span class="sd">      retry_message: User-supplied message indicating the reason for the retry.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">txn</span><span class="p">():</span>
      <span class="n">pipeline_record</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pipeline_key</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">pipeline_record</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s">&#39;Tried to retry pipeline ID &quot;</span><span class="si">%s</span><span class="s">&quot; but it does not exist.&#39;</span><span class="p">,</span>
            <span class="n">pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
        <span class="k">raise</span> <span class="n">db</span><span class="o">.</span><span class="n">Rollback</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
          <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">WAITING</span><span class="p">,</span> <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">RUN</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s">&#39;Tried to retry pipeline ID &quot;</span><span class="si">%s</span><span class="s">&quot;, found bad state: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
            <span class="n">pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">db</span><span class="o">.</span><span class="n">Rollback</span><span class="p">()</span>

      <span class="n">params</span> <span class="o">=</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">params</span>
      <span class="n">offset_seconds</span> <span class="o">=</span> <span class="p">(</span>
          <span class="n">params</span><span class="p">[</span><span class="s">&#39;backoff_seconds&#39;</span><span class="p">]</span> <span class="o">*</span>
          <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;backoff_factor&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">current_attempt</span><span class="p">))</span>
      <span class="n">pipeline_record</span><span class="o">.</span><span class="n">next_retry_time</span> <span class="o">=</span> <span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_gettime</span><span class="p">()</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">offset_seconds</span><span class="p">))</span>
      <span class="n">pipeline_record</span><span class="o">.</span><span class="n">current_attempt</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="n">pipeline_record</span><span class="o">.</span><span class="n">retry_message</span> <span class="o">=</span> <span class="n">retry_message</span>
      <span class="n">pipeline_record</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">WAITING</span>

      <span class="k">if</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">current_attempt</span> <span class="o">&gt;=</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">max_attempts</span><span class="p">:</span>
        <span class="n">root_pipeline_key</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">root_pipeline</span><span class="o">.</span><span class="n">get_value_for_datastore</span><span class="p">(</span>
                <span class="n">pipeline_record</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s">&#39;Giving up on pipeline ID &quot;</span><span class="si">%s</span><span class="s">&quot; after </span><span class="si">%d</span><span class="s"> attempt(s); causing abort &#39;</span>
            <span class="s">&#39;all the way to the root pipeline ID &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span><span class="p">,</span> <span class="n">pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span>
            <span class="n">pipeline_record</span><span class="o">.</span><span class="n">current_attempt</span><span class="p">,</span> <span class="n">root_pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
        <span class="c"># NOTE: We do *not* set the status to aborted here to ensure that</span>
        <span class="c"># this pipeline will be finalized before it has been marked as aborted.</span>
        <span class="n">pipeline_record</span><span class="o">.</span><span class="n">abort_message</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s">&#39;Aborting after </span><span class="si">%d</span><span class="s"> attempts&#39;</span> <span class="o">%</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">current_attempt</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">taskqueue</span><span class="o">.</span><span class="n">Task</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fanout_abort_handler_path</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">root_pipeline_key</span><span class="o">=</span><span class="n">root_pipeline_key</span><span class="p">))</span>
        <span class="n">task</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">queue_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">queue_name</span><span class="p">,</span> <span class="n">transactional</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">taskqueue</span><span class="o">.</span><span class="n">Task</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pipeline_handler_path</span><span class="p">,</span>
            <span class="n">eta</span><span class="o">=</span><span class="n">pipeline_record</span><span class="o">.</span><span class="n">next_retry_time</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">pipeline_key</span><span class="o">=</span><span class="n">pipeline_key</span><span class="p">,</span>
                        <span class="n">purpose</span><span class="o">=</span><span class="n">_BarrierRecord</span><span class="o">.</span><span class="n">START</span><span class="p">,</span>
                        <span class="n">attempt</span><span class="o">=</span><span class="n">pipeline_record</span><span class="o">.</span><span class="n">current_attempt</span><span class="p">),</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;X-Ae-Pipeline-Key&#39;</span><span class="p">:</span> <span class="n">pipeline_key</span><span class="p">})</span>
        <span class="n">task</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">queue_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">queue_name</span><span class="p">,</span> <span class="n">transactional</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

      <span class="n">pipeline_record</span><span class="o">.</span><span class="n">put</span><span class="p">()</span>

    <span class="n">db</span><span class="o">.</span><span class="n">run_in_transaction</span><span class="p">(</span><span class="n">txn</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">transition_aborted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline_key</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Makes the given pipeline as having aborted.</span>

<span class="sd">    Does nothing if the pipeline is in a bad state.</span>

<span class="sd">    Args:</span>
<span class="sd">      pipeline_key: db.Key of the _PipelineRecord that needs to be retried.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">txn</span><span class="p">():</span>
      <span class="n">pipeline_record</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pipeline_key</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">pipeline_record</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s">&#39;Tried to abort pipeline ID &quot;</span><span class="si">%s</span><span class="s">&quot; but it does not exist.&#39;</span><span class="p">,</span>
            <span class="n">pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
        <span class="k">raise</span> <span class="n">db</span><span class="o">.</span><span class="n">Rollback</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
          <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">WAITING</span><span class="p">,</span> <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">RUN</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s">&#39;Tried to abort pipeline ID &quot;</span><span class="si">%s</span><span class="s">&quot;, found bad state: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
            <span class="n">pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">db</span><span class="o">.</span><span class="n">Rollback</span><span class="p">()</span>

      <span class="n">pipeline_record</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">ABORTED</span>
      <span class="n">pipeline_record</span><span class="o">.</span><span class="n">finalized_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gettime</span><span class="p">()</span>
      <span class="n">pipeline_record</span><span class="o">.</span><span class="n">put</span><span class="p">()</span>

    <span class="n">db</span><span class="o">.</span><span class="n">run_in_transaction</span><span class="p">(</span><span class="n">txn</span><span class="p">)</span>

<span class="c">################################################################################</span>


<span class="k">class</span> <span class="nc">_BarrierHandler</span><span class="p">(</span><span class="n">webapp</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Request handler for triggering barriers.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="s">&#39;HTTP_X_APPENGINE_TASKNAME&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span>
      <span class="k">return</span>

    <span class="n">context</span> <span class="o">=</span> <span class="n">_PipelineContext</span><span class="o">.</span><span class="n">from_environ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">notify_barriers</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;slot_key&#39;</span><span class="p">),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;cursor&#39;</span><span class="p">),</span>
        <span class="n">use_barrier_indexes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;use_barrier_indexes&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;True&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_PipelineHandler</span><span class="p">(</span><span class="n">webapp</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Request handler for running pipelines.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="s">&#39;HTTP_X_APPENGINE_TASKNAME&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span>
      <span class="k">return</span>

    <span class="n">context</span> <span class="o">=</span> <span class="n">_PipelineContext</span><span class="o">.</span><span class="n">from_environ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;pipeline_key&#39;</span><span class="p">),</span>
                     <span class="n">purpose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;purpose&#39;</span><span class="p">),</span>
                     <span class="n">attempt</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;attempt&#39;</span><span class="p">,</span> <span class="s">&#39;0&#39;</span><span class="p">)))</span>


<span class="k">class</span> <span class="nc">_FanoutAbortHandler</span><span class="p">(</span><span class="n">webapp</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Request handler for fanning out abort notifications.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="s">&#39;HTTP_X_APPENGINE_TASKNAME&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span>
      <span class="k">return</span>

    <span class="n">context</span> <span class="o">=</span> <span class="n">_PipelineContext</span><span class="o">.</span><span class="n">from_environ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">continue_abort</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;root_pipeline_key&#39;</span><span class="p">),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;cursor&#39;</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">_FanoutHandler</span><span class="p">(</span><span class="n">webapp</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Request handler for fanning out pipeline children.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="s">&#39;HTTP_X_APPENGINE_TASKNAME&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span>
      <span class="k">return</span>

    <span class="n">context</span> <span class="o">=</span> <span class="n">_PipelineContext</span><span class="o">.</span><span class="n">from_environ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>

    <span class="c"># Set of stringified db.Keys of children to run.</span>
    <span class="n">all_pipeline_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="c"># For backwards compatibility with the old style of fan-out requests.</span>
    <span class="n">all_pipeline_keys</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="s">&#39;pipeline_key&#39;</span><span class="p">))</span>

    <span class="c"># Fetch the child pipelines from the parent. This works around the 10KB</span>
    <span class="c"># task payload limit. This get() is consistent-on-read and the fan-out</span>
    <span class="c"># task is enqueued in the transaction that updates the parent, so the</span>
    <span class="c"># fanned_out property is consistent here.</span>
    <span class="n">parent_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;parent_key&#39;</span><span class="p">)</span>
    <span class="n">child_indexes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="s">&#39;child_indexes&#39;</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">parent_key</span><span class="p">:</span>
      <span class="n">parent_key</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Key</span><span class="p">(</span><span class="n">parent_key</span><span class="p">)</span>
      <span class="n">parent</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parent_key</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">child_indexes</span><span class="p">:</span>
        <span class="n">all_pipeline_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">fanned_out</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>

    <span class="n">all_tasks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">all_pipelines</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">([</span><span class="n">db</span><span class="o">.</span><span class="n">Key</span><span class="p">(</span><span class="n">pipeline_key</span><span class="p">)</span> <span class="k">for</span> <span class="n">pipeline_key</span> <span class="ow">in</span> <span class="n">all_pipeline_keys</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">child_pipeline</span> <span class="ow">in</span> <span class="n">all_pipelines</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">child_pipeline</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">continue</span>
      <span class="n">pipeline_key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">child_pipeline</span><span class="o">.</span><span class="n">key</span><span class="p">())</span>
      <span class="n">all_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">taskqueue</span><span class="o">.</span><span class="n">Task</span><span class="p">(</span>
          <span class="n">url</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">pipeline_handler_path</span><span class="p">,</span>
          <span class="n">params</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">pipeline_key</span><span class="o">=</span><span class="n">pipeline_key</span><span class="p">),</span>
          <span class="n">target</span><span class="o">=</span><span class="n">child_pipeline</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;target&#39;</span><span class="p">],</span>
          <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;X-Ae-Pipeline-Key&#39;</span><span class="p">:</span> <span class="n">pipeline_key</span><span class="p">},</span>
          <span class="n">name</span><span class="o">=</span><span class="s">&#39;ae-pipeline-fan-out-&#39;</span> <span class="o">+</span> <span class="n">child_pipeline</span><span class="o">.</span><span class="n">key</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">()))</span>

    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c"># Limit of taskqueue API bulk add.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_tasks</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
      <span class="n">batch</span> <span class="o">=</span> <span class="n">all_tasks</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">batch_size</span><span class="p">]</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">taskqueue</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">queue_name</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
      <span class="k">except</span> <span class="p">(</span><span class="n">taskqueue</span><span class="o">.</span><span class="n">TombstonedTaskError</span><span class="p">,</span> <span class="n">taskqueue</span><span class="o">.</span><span class="n">TaskAlreadyExistsError</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">_CleanupHandler</span><span class="p">(</span><span class="n">webapp</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Request handler for cleaning up a Pipeline.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="s">&#39;HTTP_X_APPENGINE_TASKNAME&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span>
      <span class="k">return</span>

    <span class="n">root_pipeline_key</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;root_pipeline_key&#39;</span><span class="p">))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Cleaning up root_pipeline_key=</span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">root_pipeline_key</span><span class="p">)</span>

    <span class="c"># TODO(user): Accumulate all BlobKeys from _PipelineRecord and</span>
    <span class="c"># _SlotRecord entities and delete them.</span>
    <span class="n">pipeline_keys</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">keys_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s">&#39;root_pipeline =&#39;</span><span class="p">,</span> <span class="n">root_pipeline_key</span><span class="p">))</span>
    <span class="n">db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">pipeline_keys</span><span class="p">)</span>
    <span class="n">slot_keys</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">_SlotRecord</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">keys_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s">&#39;root_pipeline =&#39;</span><span class="p">,</span> <span class="n">root_pipeline_key</span><span class="p">))</span>
    <span class="n">db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">slot_keys</span><span class="p">)</span>
    <span class="n">barrier_keys</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">_BarrierRecord</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">keys_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s">&#39;root_pipeline =&#39;</span><span class="p">,</span> <span class="n">root_pipeline_key</span><span class="p">))</span>
    <span class="n">db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">barrier_keys</span><span class="p">)</span>
    <span class="n">status_keys</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">_StatusRecord</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">keys_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s">&#39;root_pipeline =&#39;</span><span class="p">,</span> <span class="n">root_pipeline_key</span><span class="p">))</span>
    <span class="n">db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">status_keys</span><span class="p">)</span>
    <span class="n">barrier_index_keys</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">_BarrierIndex</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">keys_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s">&#39;root_pipeline =&#39;</span><span class="p">,</span> <span class="n">root_pipeline_key</span><span class="p">))</span>
    <span class="n">db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">barrier_index_keys</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_CallbackHandler</span><span class="p">(</span><span class="n">webapp</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Receives asynchronous callback requests from humans or tasks.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">run_callback</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">_CallbackTaskError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
      <span class="k">if</span> <span class="s">&#39;HTTP_X_APPENGINE_TASKRETRYCOUNT&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="c"># Silently give up on tasks that have retried many times. This</span>
        <span class="c"># probably means that the target pipeline has been deleted, so there&#39;s</span>
        <span class="c"># no reason to keep trying this task forever.</span>
        <span class="n">retry_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;HTTP_X_APPENGINE_TASKRETRYCOUNT&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">retry_count</span> <span class="o">&gt;</span> <span class="n">_MAX_CALLBACK_TASK_RETRIES</span><span class="p">:</span>
          <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Giving up on task after </span><span class="si">%d</span><span class="s"> retries&#39;</span><span class="p">,</span>
                        <span class="n">_MAX_CALLBACK_TASK_RETRIES</span><span class="p">)</span>
          <span class="k">return</span>

      <span class="c"># NOTE: The undescriptive error code 400 are present to address security</span>
      <span class="c"># risks of giving external users access to cause PipelineRecord lookups</span>
      <span class="c"># and execution.</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">run_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Runs the callback for the pipeline specified in the request.</span>

<span class="sd">    Raises:</span>
<span class="sd">      _CallbackTaskError if something was wrong with the request parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pipeline_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;pipeline_id&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pipeline_id</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">_CallbackTaskError</span><span class="p">(</span><span class="s">&#39;&quot;pipeline_id&quot; parameter missing.&#39;</span><span class="p">)</span>

    <span class="n">pipeline_key</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Key</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">kind</span><span class="p">(),</span> <span class="n">pipeline_id</span><span class="p">)</span>
    <span class="n">pipeline_record</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pipeline_key</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pipeline_record</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">_CallbackTaskError</span><span class="p">(</span>
          <span class="s">&#39;Pipeline ID &quot;</span><span class="si">%s</span><span class="s">&quot; for callback does not exist.&#39;</span> <span class="o">%</span> <span class="n">pipeline_id</span><span class="p">)</span>

    <span class="n">params</span> <span class="o">=</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">params</span>
    <span class="n">real_class_path</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;class_path&#39;</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">pipeline_func_class</span> <span class="o">=</span> <span class="n">mr_util</span><span class="o">.</span><span class="n">for_name</span><span class="p">(</span><span class="n">real_class_path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">_CallbackTaskError</span><span class="p">(</span>
          <span class="s">&#39;Cannot load class named &quot;</span><span class="si">%s</span><span class="s">&quot; for pipeline ID &quot;</span><span class="si">%s</span><span class="s">&quot;.&#39;</span>
          <span class="o">%</span> <span class="p">(</span><span class="n">real_class_path</span><span class="p">,</span> <span class="n">pipeline_id</span><span class="p">))</span>

    <span class="k">if</span> <span class="s">&#39;HTTP_X_APPENGINE_TASKNAME&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">pipeline_func_class</span><span class="o">.</span><span class="n">public_callbacks</span><span class="p">:</span>
        <span class="k">pass</span>
      <span class="k">elif</span> <span class="n">pipeline_func_class</span><span class="o">.</span><span class="n">admin_callbacks</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">users</span><span class="o">.</span><span class="n">is_current_user_admin</span><span class="p">():</span>
          <span class="k">raise</span> <span class="n">_CallbackTaskError</span><span class="p">(</span>
              <span class="s">&#39;Unauthorized callback for admin-only pipeline ID &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span>
              <span class="o">%</span> <span class="n">pipeline_id</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">_CallbackTaskError</span><span class="p">(</span>
            <span class="s">&#39;External callback for internal-only pipeline ID &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span>
            <span class="o">%</span> <span class="n">pipeline_id</span><span class="p">)</span>

    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">arguments</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s">&#39;pipeline_id&#39;</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">perform_callback</span><span class="p">():</span>
      <span class="n">stage</span> <span class="o">=</span> <span class="n">pipeline_func_class</span><span class="o">.</span><span class="n">from_id</span><span class="p">(</span><span class="n">pipeline_id</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">stage</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">_CallbackTaskError</span><span class="p">(</span>
            <span class="s">&#39;Pipeline ID &quot;</span><span class="si">%s</span><span class="s">&quot; deleted during callback&#39;</span> <span class="o">%</span> <span class="n">pipeline_id</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">stage</span><span class="o">.</span><span class="n">_callback_internal</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c"># callback_xg_transaction is a 3-valued setting (None=no trans,</span>
    <span class="c"># False=1-eg-trans, True=xg-trans)</span>
    <span class="k">if</span> <span class="n">pipeline_func_class</span><span class="o">.</span><span class="n">_callback_xg_transaction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">transaction_options</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">create_transaction_options</span><span class="p">(</span>
          <span class="n">xg</span><span class="o">=</span><span class="n">pipeline_func_class</span><span class="o">.</span><span class="n">_callback_xg_transaction</span><span class="p">)</span>
      <span class="n">callback_result</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">run_in_transaction_options</span><span class="p">(</span><span class="n">transaction_options</span><span class="p">,</span>
                                                      <span class="n">perform_callback</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">callback_result</span> <span class="o">=</span> <span class="n">perform_callback</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">callback_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">status_code</span><span class="p">,</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="n">callback_result</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">status_code</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;Content-Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">content_type</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>


<span class="c">################################################################################</span>

<span class="k">def</span> <span class="nf">_get_timestamp_ms</span><span class="p">(</span><span class="n">when</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Converts a datetime.datetime to integer milliseconds since the epoch.</span>

<span class="sd">  Requires special handling to preserve microseconds.</span>

<span class="sd">  Args:</span>
<span class="sd">    when: A datetime.datetime instance.</span>

<span class="sd">  Returns:</span>
<span class="sd">    Integer time since the epoch in milliseconds. If the supplied &#39;when&#39; is</span>
<span class="sd">    None, the return value will be None.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="n">when</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">return</span> <span class="bp">None</span>
  <span class="n">ms_since_epoch</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">when</span><span class="o">.</span><span class="n">utctimetuple</span><span class="p">())</span> <span class="o">*</span> <span class="mf">1000.0</span><span class="p">)</span>
  <span class="n">ms_since_epoch</span> <span class="o">+=</span> <span class="n">when</span><span class="o">.</span><span class="n">microsecond</span> <span class="o">/</span> <span class="mf">1000.0</span>
  <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">ms_since_epoch</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_internal_status</span><span class="p">(</span><span class="n">pipeline_key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                         <span class="n">pipeline_dict</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                         <span class="n">slot_dict</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                         <span class="n">barrier_dict</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                         <span class="n">status_dict</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Gets the UI dictionary of a pipeline from a set of status dictionaries.</span>

<span class="sd">  Args:</span>
<span class="sd">    pipeline_key: The key of the pipeline to lookup.</span>
<span class="sd">    pipeline_dict: Dictionary mapping pipeline db.Key to _PipelineRecord.</span>
<span class="sd">      Default is an empty dictionary.</span>
<span class="sd">    slot_dict: Dictionary mapping slot db.Key to _SlotRecord.</span>
<span class="sd">      Default is an empty dictionary.</span>
<span class="sd">    barrier_dict: Dictionary mapping barrier db.Key to _BarrierRecord.</span>
<span class="sd">      Default is an empty dictionary.</span>
<span class="sd">    status_dict: Dictionary mapping status record db.Key to _StatusRecord.</span>
<span class="sd">      Default is an empty dictionary.</span>

<span class="sd">  Returns:</span>
<span class="sd">    Dictionary with the keys:</span>
<span class="sd">      classPath: The pipeline function being run.</span>
<span class="sd">      args: List of positional argument slot dictionaries.</span>
<span class="sd">      kwargs: Dictionary of keyword argument slot dictionaries.</span>
<span class="sd">      outputs: Dictionary of output slot dictionaries.</span>
<span class="sd">      children: List of child pipeline IDs.</span>
<span class="sd">      queueName: Queue on which this pipeline is running.</span>
<span class="sd">      afterSlotKeys: List of Slot Ids after which this pipeline runs.</span>
<span class="sd">      currentAttempt: Number of the current attempt, starting at 1.</span>
<span class="sd">      maxAttempts: Maximum number of attempts before aborting.</span>
<span class="sd">      backoffSeconds: Constant factor for backoff before retrying.</span>
<span class="sd">      backoffFactor: Exponential factor for backoff before retrying.</span>
<span class="sd">      status: Current status of the pipeline.</span>
<span class="sd">      startTimeMs: When this pipeline ran or will run due to retries, if present.</span>
<span class="sd">      endTimeMs: When this pipeline finalized, if present.</span>
<span class="sd">      lastRetryMessage: Why the pipeline failed during the last retry, if there</span>
<span class="sd">        was a failure; may be empty.</span>
<span class="sd">      abortMessage: For root pipelines, why the pipeline was aborted if it was</span>
<span class="sd">        aborted; may be empty.</span>

<span class="sd">    Dictionary will contain these keys if explicit status is set:</span>
<span class="sd">      statusTimeMs: When the status was set as milliseconds since the epoch.</span>
<span class="sd">      statusMessage: Status message, if present.</span>
<span class="sd">      statusConsoleUrl: The relative URL for the console of this pipeline.</span>
<span class="sd">      statusLinks: Dictionary mapping human-readable names to relative URLs</span>
<span class="sd">        for related URLs to this pipeline.</span>

<span class="sd">  Raises:</span>
<span class="sd">    PipelineStatusError if any input is bad.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="n">pipeline_dict</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">pipeline_dict</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="k">if</span> <span class="n">slot_dict</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">slot_dict</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="k">if</span> <span class="n">barrier_dict</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">barrier_dict</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="k">if</span> <span class="n">status_dict</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">status_dict</span> <span class="o">=</span> <span class="p">{}</span>

  <span class="n">pipeline_record</span> <span class="o">=</span> <span class="n">pipeline_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pipeline_key</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">pipeline_record</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">PipelineStatusError</span><span class="p">(</span>
        <span class="s">&#39;Could not find pipeline ID &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>

  <span class="n">params</span> <span class="o">=</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">params</span>
  <span class="n">root_pipeline_key</span> <span class="o">=</span> \
      <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">root_pipeline</span><span class="o">.</span><span class="n">get_value_for_datastore</span><span class="p">(</span><span class="n">pipeline_record</span><span class="p">)</span>
  <span class="n">default_slot_key</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Key</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;output_slots&#39;</span><span class="p">][</span><span class="s">&#39;default&#39;</span><span class="p">])</span>
  <span class="n">start_barrier_key</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Key</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span>
      <span class="n">_BarrierRecord</span><span class="o">.</span><span class="n">kind</span><span class="p">(),</span> <span class="n">_BarrierRecord</span><span class="o">.</span><span class="n">START</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">pipeline_key</span><span class="p">)</span>
  <span class="n">finalize_barrier_key</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Key</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span>
      <span class="n">_BarrierRecord</span><span class="o">.</span><span class="n">kind</span><span class="p">(),</span> <span class="n">_BarrierRecord</span><span class="o">.</span><span class="n">FINALIZE</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">pipeline_key</span><span class="p">)</span>
  <span class="n">status_record_key</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Key</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span>
      <span class="n">_StatusRecord</span><span class="o">.</span><span class="n">kind</span><span class="p">(),</span> <span class="n">pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>

  <span class="n">start_barrier</span> <span class="o">=</span> <span class="n">barrier_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">start_barrier_key</span><span class="p">)</span>
  <span class="n">finalize_barrier</span> <span class="o">=</span> <span class="n">barrier_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">finalize_barrier_key</span><span class="p">)</span>
  <span class="n">default_slot</span> <span class="o">=</span> <span class="n">slot_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">default_slot_key</span><span class="p">)</span>
  <span class="n">status_record</span> <span class="o">=</span> <span class="n">status_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">status_record_key</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">finalize_barrier</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">PipelineStatusError</span><span class="p">(</span>
        <span class="s">&#39;Finalization barrier missing for pipeline ID &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span>
        <span class="n">pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
  <span class="k">if</span> <span class="n">default_slot</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">PipelineStatusError</span><span class="p">(</span>
        <span class="s">&#39;Default output slot with key=</span><span class="si">%s</span><span class="s"> missing for pipeline ID &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">default_slot_key</span><span class="p">,</span> <span class="n">pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">()))</span>

  <span class="n">output</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;classPath&#39;</span><span class="p">:</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">class_path</span><span class="p">,</span>
    <span class="s">&#39;args&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;args&#39;</span><span class="p">]),</span>
    <span class="s">&#39;kwargs&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;kwargs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
    <span class="s">&#39;outputs&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;output_slots&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
    <span class="s">&#39;children&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">fanned_out</span><span class="p">],</span>
    <span class="s">&#39;queueName&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;queue_name&#39;</span><span class="p">],</span>
    <span class="s">&#39;afterSlotKeys&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;after_all&#39;</span><span class="p">]],</span>
    <span class="s">&#39;currentAttempt&#39;</span><span class="p">:</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">current_attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;maxAttempts&#39;</span><span class="p">:</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">max_attempts</span><span class="p">,</span>
    <span class="s">&#39;backoffSeconds&#39;</span><span class="p">:</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;backoff_seconds&#39;</span><span class="p">],</span>
    <span class="s">&#39;backoffFactor&#39;</span><span class="p">:</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;backoff_factor&#39;</span><span class="p">],</span>
  <span class="p">}</span>

  <span class="c"># TODO(user): Truncate args, kwargs, and outputs to &lt; 1MB each so we</span>
  <span class="c"># can reasonably return the whole tree of pipelines and their outputs.</span>
  <span class="c"># Coerce each value to a string to truncate if necessary. For now if the</span>
  <span class="c"># params are too big it will just cause the whole status page to break.</span>

  <span class="c"># Fix the key names in parameters to match JavaScript style.</span>
  <span class="k">for</span> <span class="n">value_dict</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span>
      <span class="n">output</span><span class="p">[</span><span class="s">&#39;args&#39;</span><span class="p">],</span> <span class="n">output</span><span class="p">[</span><span class="s">&#39;kwargs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">itervalues</span><span class="p">()):</span>
    <span class="k">if</span> <span class="s">&#39;slot_key&#39;</span> <span class="ow">in</span> <span class="n">value_dict</span><span class="p">:</span>
      <span class="n">value_dict</span><span class="p">[</span><span class="s">&#39;slotKey&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;slot_key&#39;</span><span class="p">)</span>

  <span class="c"># Figure out the pipeline&#39;s status.</span>
  <span class="k">if</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">(</span><span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">WAITING</span><span class="p">,</span> <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">RUN</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">default_slot</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">_SlotRecord</span><span class="o">.</span><span class="n">FILLED</span><span class="p">:</span>
      <span class="n">status</span> <span class="o">=</span> <span class="s">&#39;finalizing&#39;</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">pipeline_record</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">WAITING</span> <span class="ow">and</span>
          <span class="n">pipeline_record</span><span class="o">.</span><span class="n">next_retry_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
      <span class="n">status</span> <span class="o">=</span> <span class="s">&#39;retry&#39;</span>
    <span class="k">elif</span> <span class="n">start_barrier</span> <span class="ow">and</span> <span class="n">start_barrier</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">_BarrierRecord</span><span class="o">.</span><span class="n">WAITING</span><span class="p">:</span>
      <span class="c"># start_barrier will be missing for root pipelines</span>
      <span class="n">status</span> <span class="o">=</span> <span class="s">&#39;waiting&#39;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">status</span> <span class="o">=</span> <span class="s">&#39;run&#39;</span>
  <span class="k">elif</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">DONE</span><span class="p">:</span>
    <span class="n">status</span> <span class="o">=</span> <span class="s">&#39;done&#39;</span>
  <span class="k">elif</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">ABORTED</span><span class="p">:</span>
    <span class="n">status</span> <span class="o">=</span> <span class="s">&#39;aborted&#39;</span>

  <span class="n">output</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span>

  <span class="k">if</span> <span class="n">status_record</span><span class="p">:</span>
    <span class="n">output</span><span class="p">[</span><span class="s">&#39;statusTimeMs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_get_timestamp_ms</span><span class="p">(</span><span class="n">status_record</span><span class="o">.</span><span class="n">status_time</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">status_record</span><span class="o">.</span><span class="n">message</span><span class="p">:</span>
      <span class="n">output</span><span class="p">[</span><span class="s">&#39;statusMessage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">status_record</span><span class="o">.</span><span class="n">message</span>
    <span class="k">if</span> <span class="n">status_record</span><span class="o">.</span><span class="n">console_url</span><span class="p">:</span>
      <span class="n">output</span><span class="p">[</span><span class="s">&#39;statusConsoleUrl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">status_record</span><span class="o">.</span><span class="n">console_url</span>
    <span class="k">if</span> <span class="n">status_record</span><span class="o">.</span><span class="n">link_names</span><span class="p">:</span>
      <span class="n">output</span><span class="p">[</span><span class="s">&#39;statusLinks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
          <span class="nb">zip</span><span class="p">(</span><span class="n">status_record</span><span class="o">.</span><span class="n">link_names</span><span class="p">,</span> <span class="n">status_record</span><span class="o">.</span><span class="n">link_urls</span><span class="p">))</span>

  <span class="c"># Populate status-depenedent fields.</span>
  <span class="k">if</span> <span class="n">status</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;run&#39;</span><span class="p">,</span> <span class="s">&#39;finalizing&#39;</span><span class="p">,</span> <span class="s">&#39;done&#39;</span><span class="p">,</span> <span class="s">&#39;retry&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">next_retry_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">output</span><span class="p">[</span><span class="s">&#39;startTimeMs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_get_timestamp_ms</span><span class="p">(</span><span class="n">pipeline_record</span><span class="o">.</span><span class="n">next_retry_time</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">start_barrier</span><span class="p">:</span>
      <span class="c"># start_barrier will be missing for root pipelines</span>
      <span class="n">output</span><span class="p">[</span><span class="s">&#39;startTimeMs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_get_timestamp_ms</span><span class="p">(</span><span class="n">start_barrier</span><span class="o">.</span><span class="n">trigger_time</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">start_time</span><span class="p">:</span>
      <span class="c"># Assume this pipeline ran immediately upon spawning with no</span>
      <span class="c"># start barrier or it&#39;s the root pipeline.</span>
      <span class="n">output</span><span class="p">[</span><span class="s">&#39;startTimeMs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_get_timestamp_ms</span><span class="p">(</span><span class="n">pipeline_record</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">status</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;finalizing&#39;</span><span class="p">,):</span>
    <span class="n">output</span><span class="p">[</span><span class="s">&#39;endTimeMs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_get_timestamp_ms</span><span class="p">(</span><span class="n">default_slot</span><span class="o">.</span><span class="n">fill_time</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">status</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;done&#39;</span><span class="p">,):</span>
    <span class="n">output</span><span class="p">[</span><span class="s">&#39;endTimeMs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_get_timestamp_ms</span><span class="p">(</span><span class="n">pipeline_record</span><span class="o">.</span><span class="n">finalized_time</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">next_retry_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">output</span><span class="p">[</span><span class="s">&#39;lastRetryMessage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">retry_message</span>

  <span class="k">if</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">abort_message</span><span class="p">:</span>
    <span class="n">output</span><span class="p">[</span><span class="s">&#39;abortMessage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">abort_message</span>

  <span class="k">return</span> <span class="n">output</span>


<span class="k">def</span> <span class="nf">_get_internal_slot</span><span class="p">(</span><span class="n">slot_key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                       <span class="n">filler_pipeline_key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                       <span class="n">slot_dict</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Gets information about a _SlotRecord for display in UI.</span>

<span class="sd">  Args:</span>
<span class="sd">    slot_key: The db.Key of the slot to fetch.</span>
<span class="sd">    filler_pipeline_key: In the case the slot has not yet been filled, assume</span>
<span class="sd">      that the given db.Key (for a _PipelineRecord) will be the filler of</span>
<span class="sd">      the slot in the future.</span>
<span class="sd">    slot_dict: The slot JSON dictionary.</span>

<span class="sd">  Returns:</span>
<span class="sd">    Dictionary with the keys:</span>
<span class="sd">      status: Slot status: &#39;filled&#39; or &#39;waiting&#39;</span>
<span class="sd">      fillTimeMs: Time in milliseconds since the epoch of when it was filled.</span>
<span class="sd">      value: The current value of the slot, which is a slot&#39;s JSON dictionary.</span>
<span class="sd">      fillerPipelineId: The pipeline ID of what stage has or should fill</span>
<span class="sd">        this slot.</span>

<span class="sd">  Raises:</span>
<span class="sd">    PipelineStatusError if any input is bad.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="n">slot_dict</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">slot_dict</span> <span class="o">=</span> <span class="p">{}</span>

  <span class="n">slot_record</span> <span class="o">=</span> <span class="n">slot_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">slot_key</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">slot_record</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">PipelineStatusError</span><span class="p">(</span>
        <span class="s">&#39;Could not find data for output slot key &quot;</span><span class="si">%s</span><span class="s">&quot;.&#39;</span> <span class="o">%</span> <span class="n">slot_key</span><span class="p">)</span>

  <span class="n">output</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="k">if</span> <span class="n">slot_record</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">_SlotRecord</span><span class="o">.</span><span class="n">FILLED</span><span class="p">:</span>
    <span class="n">output</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;filled&#39;</span>
    <span class="n">output</span><span class="p">[</span><span class="s">&#39;fillTimeMs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_get_timestamp_ms</span><span class="p">(</span><span class="n">slot_record</span><span class="o">.</span><span class="n">fill_time</span><span class="p">)</span>
    <span class="n">output</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">slot_record</span><span class="o">.</span><span class="n">value</span>
    <span class="n">filler_pipeline_key</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">_SlotRecord</span><span class="o">.</span><span class="n">filler</span><span class="o">.</span><span class="n">get_value_for_datastore</span><span class="p">(</span><span class="n">slot_record</span><span class="p">))</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">output</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;waiting&#39;</span>

  <span class="k">if</span> <span class="n">filler_pipeline_key</span><span class="p">:</span>
    <span class="n">output</span><span class="p">[</span><span class="s">&#39;fillerPipelineId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filler_pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>

  <span class="k">return</span> <span class="n">output</span>


<div class="viewcode-block" id="get_status_tree"><a class="viewcode-back" href="../../pipeline.html#pipeline.pipeline.get_status_tree">[docs]</a><span class="k">def</span> <span class="nf">get_status_tree</span><span class="p">(</span><span class="n">root_pipeline_id</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Gets the full status tree of a pipeline.</span>

<span class="sd">  Args:</span>
<span class="sd">    root_pipeline_id: The pipeline ID to get status for.</span>

<span class="sd">  Returns:</span>
<span class="sd">    Dictionary with the keys:</span>
<span class="sd">      rootPipelineId: The ID of the root pipeline.</span>
<span class="sd">      slots: Mapping of slot IDs to result of from _get_internal_slot.</span>
<span class="sd">      pipelines: Mapping of pipeline IDs to result of _get_internal_status.</span>

<span class="sd">  Raises:</span>
<span class="sd">    PipelineStatusError if any input is bad.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">root_pipeline_key</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Key</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">kind</span><span class="p">(),</span> <span class="n">root_pipeline_id</span><span class="p">)</span>
  <span class="n">root_pipeline_record</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">root_pipeline_key</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">root_pipeline_record</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">PipelineStatusError</span><span class="p">(</span>
        <span class="s">&#39;Could not find pipeline ID &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">root_pipeline_id</span><span class="p">)</span>

  <span class="c"># If the supplied root_pipeline_id is not actually the root pipeline that&#39;s</span>
  <span class="c"># okay. We&#39;ll find the real root and override the value they passed in.</span>
  <span class="n">actual_root_key</span> <span class="o">=</span> <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">root_pipeline</span><span class="o">.</span><span class="n">get_value_for_datastore</span><span class="p">(</span>
      <span class="n">root_pipeline_record</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">actual_root_key</span> <span class="o">!=</span> <span class="n">root_pipeline_key</span><span class="p">:</span>
    <span class="n">root_pipeline_key</span> <span class="o">=</span> <span class="n">actual_root_key</span>
    <span class="n">root_pipeline_id</span> <span class="o">=</span> <span class="n">root_pipeline_key</span><span class="o">.</span><span class="n">id_or_name</span><span class="p">()</span>
    <span class="n">root_pipeline_record</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">root_pipeline_key</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">root_pipeline_record</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">PipelineStatusError</span><span class="p">(</span>
          <span class="s">&#39;Could not find pipeline ID &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">root_pipeline_id</span><span class="p">)</span>

  <span class="c"># Run all queries asynchronously.</span>
  <span class="n">queries</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">(</span><span class="n">_PipelineRecord</span><span class="p">,</span> <span class="n">_SlotRecord</span><span class="p">,</span> <span class="n">_BarrierRecord</span><span class="p">,</span> <span class="n">_StatusRecord</span><span class="p">):</span>
    <span class="n">queries</span><span class="p">[</span><span class="n">model</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="s">&#39;root_pipeline =&#39;</span><span class="p">,</span> <span class="n">root_pipeline_key</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

  <span class="n">found_pipeline_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
      <span class="p">(</span><span class="n">stage</span><span class="o">.</span><span class="n">key</span><span class="p">(),</span> <span class="n">stage</span><span class="p">)</span> <span class="k">for</span> <span class="n">stage</span> <span class="ow">in</span> <span class="n">queries</span><span class="p">[</span><span class="n">_PipelineRecord</span><span class="p">])</span>
  <span class="n">found_slot_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
      <span class="p">(</span><span class="n">slot</span><span class="o">.</span><span class="n">key</span><span class="p">(),</span> <span class="n">slot</span><span class="p">)</span> <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">queries</span><span class="p">[</span><span class="n">_SlotRecord</span><span class="p">])</span>
  <span class="n">found_barrier_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
      <span class="p">(</span><span class="n">barrier</span><span class="o">.</span><span class="n">key</span><span class="p">(),</span> <span class="n">barrier</span><span class="p">)</span> <span class="k">for</span> <span class="n">barrier</span> <span class="ow">in</span> <span class="n">queries</span><span class="p">[</span><span class="n">_BarrierRecord</span><span class="p">])</span>
  <span class="n">found_status_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
      <span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">key</span><span class="p">(),</span> <span class="n">status</span><span class="p">)</span> <span class="k">for</span> <span class="n">status</span> <span class="ow">in</span> <span class="n">queries</span><span class="p">[</span><span class="n">_StatusRecord</span><span class="p">])</span>

  <span class="c"># Breadth-first traversal of _PipelineRecord instances by following</span>
  <span class="c"># _PipelineRecord.fanned_out property values.</span>
  <span class="n">valid_pipeline_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">root_pipeline_key</span><span class="p">])</span>
  <span class="n">slot_filler_dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c"># slot_key to pipeline_key</span>
  <span class="n">expand_stack</span> <span class="o">=</span> <span class="p">[</span><span class="n">root_pipeline_record</span><span class="p">]</span>
  <span class="k">while</span> <span class="n">expand_stack</span><span class="p">:</span>
    <span class="n">old_stack</span> <span class="o">=</span> <span class="n">expand_stack</span>
    <span class="n">expand_stack</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pipeline_record</span> <span class="ow">in</span> <span class="n">old_stack</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">child_pipeline_key</span> <span class="ow">in</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">fanned_out</span><span class="p">:</span>
        <span class="c"># This will let us prune off those pipelines which were allocated in</span>
        <span class="c"># the Datastore but were never run due to mid-flight task failures.</span>
        <span class="n">child_pipeline_record</span> <span class="o">=</span> <span class="n">found_pipeline_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">child_pipeline_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">child_pipeline_record</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
          <span class="k">raise</span> <span class="n">PipelineStatusError</span><span class="p">(</span>
              <span class="s">&#39;Pipeline ID &quot;</span><span class="si">%s</span><span class="s">&quot; points to child ID &quot;</span><span class="si">%s</span><span class="s">&quot; which does not exist.&#39;</span>
              <span class="o">%</span> <span class="p">(</span><span class="n">pipeline_record</span><span class="o">.</span><span class="n">key</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">child_pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">()))</span>
        <span class="n">expand_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child_pipeline_record</span><span class="p">)</span>
        <span class="n">valid_pipeline_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">child_pipeline_key</span><span class="p">)</span>

        <span class="c"># Figure out the deepest pipeline that&#39;s responsible for outputting to</span>
        <span class="c"># a particular _SlotRecord, so we can report which pipeline *should*</span>
        <span class="c"># be the filler.</span>
        <span class="n">child_outputs</span> <span class="o">=</span> <span class="n">child_pipeline_record</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;output_slots&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">output_slot_key</span> <span class="ow">in</span> <span class="n">child_outputs</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
          <span class="n">slot_filler_dict</span><span class="p">[</span><span class="n">db</span><span class="o">.</span><span class="n">Key</span><span class="p">(</span><span class="n">output_slot_key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">child_pipeline_key</span>

  <span class="n">output</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;rootPipelineId&#39;</span><span class="p">:</span> <span class="n">root_pipeline_id</span><span class="p">,</span>
    <span class="s">&#39;slots&#39;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="s">&#39;pipelines&#39;</span><span class="p">:</span> <span class="p">{},</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="n">pipeline_key</span> <span class="ow">in</span> <span class="n">found_pipeline_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">pipeline_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_pipeline_keys</span><span class="p">:</span>
      <span class="k">continue</span>
    <span class="n">output</span><span class="p">[</span><span class="s">&#39;pipelines&#39;</span><span class="p">][</span><span class="n">pipeline_key</span><span class="o">.</span><span class="n">name</span><span class="p">()]</span> <span class="o">=</span> <span class="n">_get_internal_status</span><span class="p">(</span>
        <span class="n">pipeline_key</span><span class="o">=</span><span class="n">pipeline_key</span><span class="p">,</span>
        <span class="n">pipeline_dict</span><span class="o">=</span><span class="n">found_pipeline_dict</span><span class="p">,</span>
        <span class="n">slot_dict</span><span class="o">=</span><span class="n">found_slot_dict</span><span class="p">,</span>
        <span class="n">barrier_dict</span><span class="o">=</span><span class="n">found_barrier_dict</span><span class="p">,</span>
        <span class="n">status_dict</span><span class="o">=</span><span class="n">found_status_dict</span><span class="p">)</span>

  <span class="k">for</span> <span class="n">slot_key</span><span class="p">,</span> <span class="n">filler_pipeline_key</span> <span class="ow">in</span> <span class="n">slot_filler_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
    <span class="n">output</span><span class="p">[</span><span class="s">&#39;slots&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">slot_key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">_get_internal_slot</span><span class="p">(</span>
        <span class="n">slot_key</span><span class="o">=</span><span class="n">slot_key</span><span class="p">,</span>
        <span class="n">filler_pipeline_key</span><span class="o">=</span><span class="n">filler_pipeline_key</span><span class="p">,</span>
        <span class="n">slot_dict</span><span class="o">=</span><span class="n">found_slot_dict</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">output</span>

</div>
<div class="viewcode-block" id="get_pipeline_names"><a class="viewcode-back" href="../../pipeline.html#pipeline.pipeline.get_pipeline_names">[docs]</a><span class="k">def</span> <span class="nf">get_pipeline_names</span><span class="p">():</span>
  <span class="sd">&quot;&quot;&quot;Returns the class paths of all Pipelines defined in alphabetical order.&quot;&quot;&quot;</span>
  <span class="n">class_path_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
  <span class="k">for</span> <span class="n">cls</span> <span class="ow">in</span> <span class="n">_PipelineMeta</span><span class="o">.</span><span class="n">_all_classes</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">cls</span><span class="o">.</span><span class="n">class_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">class_path_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">class_path</span><span class="p">)</span>
  <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">class_path_set</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="get_root_list"><a class="viewcode-back" href="../../pipeline.html#pipeline.pipeline.get_root_list">[docs]</a><span class="k">def</span> <span class="nf">get_root_list</span><span class="p">(</span><span class="n">class_path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cursor</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Gets a list root Pipelines.</span>

<span class="sd">  Args:</span>
<span class="sd">    class_path: Optional. If supplied, only return root Pipelines with the</span>
<span class="sd">      given class_path. By default all root pipelines are returned.</span>
<span class="sd">    cursor: Optional. When supplied, the cursor returned from the last call to</span>
<span class="sd">      get_root_list which indicates where to pick up.</span>
<span class="sd">    count: How many pipeline returns to return.</span>

<span class="sd">  Returns:</span>
<span class="sd">    Dictionary with the keys:</span>
<span class="sd">      pipelines: The list of Pipeline records in the same format as</span>
<span class="sd">        returned by get_status_tree, but with only the roots listed.</span>
<span class="sd">      cursor: Cursor to pass back to this function to resume the query. Will</span>
<span class="sd">        only be present if there is another page of results.</span>

<span class="sd">  Raises:</span>
<span class="sd">    PipelineStatusError if any input is bad.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">query</span> <span class="o">=</span> <span class="n">_PipelineRecord</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">cursor</span><span class="o">=</span><span class="n">cursor</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">class_path</span><span class="p">:</span>
    <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s">&#39;class_path =&#39;</span><span class="p">,</span> <span class="n">class_path</span><span class="p">)</span>
  <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s">&#39;is_root_pipeline =&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
  <span class="n">query</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="s">&#39;-start_time&#39;</span><span class="p">)</span>

  <span class="n">root_list</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>

  <span class="n">fetch_list</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">pipeline_record</span> <span class="ow">in</span> <span class="n">root_list</span><span class="p">:</span>
    <span class="n">fetch_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Key</span><span class="p">(</span><span class="n">pipeline_record</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;output_slots&#39;</span><span class="p">][</span><span class="s">&#39;default&#39;</span><span class="p">]))</span>
    <span class="n">fetch_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Key</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span>
        <span class="n">_BarrierRecord</span><span class="o">.</span><span class="n">kind</span><span class="p">(),</span> <span class="n">_BarrierRecord</span><span class="o">.</span><span class="n">FINALIZE</span><span class="p">,</span>
        <span class="n">parent</span><span class="o">=</span><span class="n">pipeline_record</span><span class="o">.</span><span class="n">key</span><span class="p">()))</span>
    <span class="n">fetch_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Key</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span>
        <span class="n">_StatusRecord</span><span class="o">.</span><span class="n">kind</span><span class="p">(),</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">key</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">()))</span>

  <span class="n">pipeline_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">stage</span><span class="o">.</span><span class="n">key</span><span class="p">(),</span> <span class="n">stage</span><span class="p">)</span> <span class="k">for</span> <span class="n">stage</span> <span class="ow">in</span> <span class="n">root_list</span><span class="p">)</span>
  <span class="n">slot_dict</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="n">barrier_dict</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="n">status_dict</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fetch_list</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">_BarrierRecord</span><span class="p">):</span>
      <span class="n">barrier_dict</span><span class="p">[</span><span class="n">entity</span><span class="o">.</span><span class="n">key</span><span class="p">()]</span> <span class="o">=</span> <span class="n">entity</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">_SlotRecord</span><span class="p">):</span>
      <span class="n">slot_dict</span><span class="p">[</span><span class="n">entity</span><span class="o">.</span><span class="n">key</span><span class="p">()]</span> <span class="o">=</span> <span class="n">entity</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">_StatusRecord</span><span class="p">):</span>
      <span class="n">status_dict</span><span class="p">[</span><span class="n">entity</span><span class="o">.</span><span class="n">key</span><span class="p">()]</span> <span class="o">=</span> <span class="n">entity</span>

  <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">pipeline_record</span> <span class="ow">in</span> <span class="n">root_list</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">output</span> <span class="o">=</span> <span class="n">_get_internal_status</span><span class="p">(</span>
          <span class="n">pipeline_record</span><span class="o">.</span><span class="n">key</span><span class="p">(),</span>
          <span class="n">pipeline_dict</span><span class="o">=</span><span class="n">pipeline_dict</span><span class="p">,</span>
          <span class="n">slot_dict</span><span class="o">=</span><span class="n">slot_dict</span><span class="p">,</span>
          <span class="n">barrier_dict</span><span class="o">=</span><span class="n">barrier_dict</span><span class="p">,</span>
          <span class="n">status_dict</span><span class="o">=</span><span class="n">status_dict</span><span class="p">)</span>
      <span class="n">output</span><span class="p">[</span><span class="s">&#39;pipelineId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">key</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
      <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">PipelineStatusError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
      <span class="n">output</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">}</span>
      <span class="n">output</span><span class="p">[</span><span class="s">&#39;classPath&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
      <span class="n">output</span><span class="p">[</span><span class="s">&#39;pipelineId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pipeline_record</span><span class="o">.</span><span class="n">key</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
      <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

  <span class="n">result_dict</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="n">cursor</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
  <span class="n">query</span><span class="o">.</span><span class="n">with_cursor</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">keys_only</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="n">result_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cursor</span><span class="o">=</span><span class="n">cursor</span><span class="p">)</span>
  <span class="n">result_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pipelines</span><span class="o">=</span><span class="n">results</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">result_dict</span>

<span class="c">################################################################################</span>
</div>
<div class="viewcode-block" id="set_enforce_auth"><a class="viewcode-back" href="../../pipeline.html#pipeline.pipeline.set_enforce_auth">[docs]</a><span class="k">def</span> <span class="nf">set_enforce_auth</span><span class="p">(</span><span class="n">new_status</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Sets whether Pipeline API handlers rely on app.yaml for access control.</span>

<span class="sd">  Args:</span>
<span class="sd">    new_status: If True, then the Pipeline API will enforce its own</span>
<span class="sd">      access control on status and static file handlers. If False, then</span>
<span class="sd">      it will assume app.yaml is doing the enforcement.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">global</span> <span class="n">_ENFORCE_AUTH</span>
  <span class="n">_ENFORCE_AUTH</span> <span class="o">=</span> <span class="n">new_status</span>

</div>
<div class="viewcode-block" id="create_handlers_map"><a class="viewcode-back" href="../../pipeline.html#pipeline.pipeline.create_handlers_map">[docs]</a><span class="k">def</span> <span class="nf">create_handlers_map</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s">&#39;.*&#39;</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Create new handlers map.</span>

<span class="sd">  Args:</span>
<span class="sd">    prefix: url prefix to use.</span>

<span class="sd">  Returns:</span>
<span class="sd">    list of (regexp, handler) pairs for WSGIApplication constructor.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">[</span>
      <span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s">&#39;/output&#39;</span><span class="p">,</span> <span class="n">_BarrierHandler</span><span class="p">),</span>
      <span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s">&#39;/run&#39;</span><span class="p">,</span> <span class="n">_PipelineHandler</span><span class="p">),</span>
      <span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s">&#39;/finalized&#39;</span><span class="p">,</span> <span class="n">_PipelineHandler</span><span class="p">),</span>
      <span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s">&#39;/cleanup&#39;</span><span class="p">,</span> <span class="n">_CleanupHandler</span><span class="p">),</span>
      <span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s">&#39;/abort&#39;</span><span class="p">,</span> <span class="n">_PipelineHandler</span><span class="p">),</span>
      <span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s">&#39;/fanout&#39;</span><span class="p">,</span> <span class="n">_FanoutHandler</span><span class="p">),</span>
      <span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s">&#39;/fanout_abort&#39;</span><span class="p">,</span> <span class="n">_FanoutAbortHandler</span><span class="p">),</span>
      <span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s">&#39;/callback&#39;</span><span class="p">,</span> <span class="n">_CallbackHandler</span><span class="p">),</span>
      <span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s">&#39;/rpc/tree&#39;</span><span class="p">,</span> <span class="n">status_ui</span><span class="o">.</span><span class="n">_TreeStatusHandler</span><span class="p">),</span>
      <span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s">&#39;/rpc/class_paths&#39;</span><span class="p">,</span> <span class="n">status_ui</span><span class="o">.</span><span class="n">_ClassPathListHandler</span><span class="p">),</span>
      <span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s">&#39;/rpc/list&#39;</span><span class="p">,</span> <span class="n">status_ui</span><span class="o">.</span><span class="n">_RootListHandler</span><span class="p">),</span>
      <span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s">&#39;(/.+)&#39;</span><span class="p">,</span> <span class="n">status_ui</span><span class="o">.</span><span class="n">_StatusUiHandler</span><span class="p">),</span>
      <span class="p">]</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015, some text.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.4</a>
      
    </div>

    

    
  </body>
</html>